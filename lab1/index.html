<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Lab 1 Tasks - HOLENT-2901 Advanced SD-WAN Lab</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Lab 1 Tasks";
    var mkdocs_page_input_path = "lab1.md";
    var mkdocs_page_url = "/lab1/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> HOLENT-2901 Advanced SD-WAN Lab</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Lab Guide</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../access/">Lab Access</a>
                </li>
                <li class="">
                    
    <a class="" href="../intro/">Getting Started</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Lab 1 Tasks</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#lab-1-advanced-routing">Lab 1: Advanced Routing</a></li>
    

    <li class="toctree-l3"><a href="#task-1-local-route-policy">Task 1: Local Route Policy</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#step-11-verification-of-the-routes-received-on-dc-wes">Step 1.1 Verification of the routes received on DC WEs.</a></li>
        
            <li><a class="toctree-l4" href="#step-12-verify-the-bgp-communities">Step 1.2 Verify the BGP communities.</a></li>
        
            <li><a class="toctree-l4" href="#step-13-set-omp-tag-for-dc-specific-routes">Step 1.3 set OMP tag for DC specific Routes</a></li>
        
            <li><a class="toctree-l4" href="#step-14-creating-a-local-policy">Step 1.4 Creating a Local Policy</a></li>
        
            <li><a class="toctree-l4" href="#step-15-apply-the-route-policy">Step 1.5 apply the route-policy</a></li>
        
            <li><a class="toctree-l4" href="#step-16-verify-omp-tags">Step 1.6 Verify OMP Tags</a></li>
        
        </ul>
    

    <li class="toctree-l3"><a href="#task-2-hub-spoke-topologies">Task 2: Hub &amp; Spoke Topologies</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#step-21-pre-config-verifications">Step 2.1. Pre-config verifications</a></li>
        
            <li><a class="toctree-l4" href="#step-22-create-a-topology-for-centralized-policy">Step 2.2. Create a topology for centralized policy</a></li>
        
            <li><a class="toctree-l4" href="#step-23-apply-the-topology-policy-to-centralized-policy">Step 2.3. Apply the topology policy to Centralized Policy</a></li>
        
            <li><a class="toctree-l4" href="#step-24-activate-the-first-centralized-policy">Step 2.4. Activate the first Centralized Policy</a></li>
        
            <li><a class="toctree-l4" href="#step-25-verify-the-hub-spoke-topology">Step 2.5. Verify the hub &amp; spoke topology</a></li>
        
        </ul>
    

    <li class="toctree-l3"><a href="#task-3-default-route-handling">Task 3: Default Route handling</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#step-31-new-central-policy">Step 3.1.  New Central Policy</a></li>
        
            <li><a class="toctree-l4" href="#step-32-edit-the-new-topology-policy">Step 3.2. Edit the new topology policy.</a></li>
        
            <li><a class="toctree-l4" href="#step-33-apply-the-policy">Step 3.3. Apply the policy</a></li>
        
            <li><a class="toctree-l4" href="#step-34-verify-change-of-default-route">Step 3.4. Verify change of default route</a></li>
        
            <li><a class="toctree-l4" href="#step-35-create-new-topology">Step 3.5. Create new topology</a></li>
        
            <li><a class="toctree-l4" href="#step-36-verify">Step 3.6. verify</a></li>
        
            <li><a class="toctree-l4" href="#step-37-create-topology-policy-for-remote2">Step 3.7. Create topology policy for Remote2</a></li>
        
        </ul>
    

    <li class="toctree-l3"><a href="#task-4-specific-routes-handling">Task 4: Specific Routes handling</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#step41-modify-topology-policy-for-remote1">Step4.1: Modify Topology policy for remote1</a></li>
        
            <li><a class="toctree-l4" href="#step42-configure-16-paths-ecmp">Step4.2: Configure 16 paths ECMP</a></li>
        
            <li><a class="toctree-l4" href="#step43-verification">Step4.3: Verification</a></li>
        
            <li><a class="toctree-l4" href="#step44-modify-topology-policy-for-remote2">Step4.4: Modify Topology policy for remote2</a></li>
        
            <li><a class="toctree-l4" href="#step45-verification">Step4.5: Verification</a></li>
        
        </ul>
    

    <li class="toctree-l3"><a href="#task-5-application-aware-routing">Task 5: Application Aware Routing</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#step51-configure-rh-lte-interface-be-used-only-when-all-other-circuits-are-unavailable">Step5.1: Configure RH LTE interface be used only when all other circuits are unavailable.</a></li>
        
            <li><a class="toctree-l4" href="#step52-last-resort-verification">Step5.2: Last-Resort verification.</a></li>
        
            <li><a class="toctree-l4" href="#step53-configure-sla-classes-for-app-aware-routing-aar">Step5.3: Configure SLA classes for app aware routing (AAR)</a></li>
        
            <li><a class="toctree-l4" href="#step54-apply-the-aar">Step5.4: Apply the AAR</a></li>
        
            <li><a class="toctree-l4" href="#step55-lab-verification">Step5.5: Lab Verification</a></li>
        
        </ul>
    

    <li class="toctree-l3"><a href="#task-6-application-pinning">Task 6: Application Pinning</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#step61-configure-data-policy">Step6.1: Configure Data Policy</a></li>
        
            <li><a class="toctree-l4" href="#step62-apply-data-policy">Step6.2: Apply Data Policy</a></li>
        
            <li><a class="toctree-l4" href="#step63-verify-application-pining-policy">Step6.3: verify application pining policy</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../lab2/">Lab 2 Tasks</a>
                </li>
                <li class="">
                    
    <a class="" href="../lab3/">Lab 3 Tasks</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../survey/">Survey</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">HOLENT-2901 Advanced SD-WAN Lab</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Lab Guide &raquo;</li>
        
      
    
    <li>Lab 1 Tasks</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h2 id="lab-1-advanced-routing">Lab 1: Advanced Routing</h2>
<hr />
<p>In this section, you will help ACME on advanced routing using local and central policy. You will perform the following tasks.</p>
<ul>
<li>
<p>ACME DC routers have already tagged all the routes originated from DC1 with BGP community of 65010:1000; all the routes originated from DC2 with BGP community of 65020:2000. <strong>Please configure a route-policy to ensure default route (0.0.0.0/0) coming from DC to set an OMP tag of 100.</strong> For DC1 routes, setting an OMP tag of <strong>1000</strong>; for DC2 routes, setting an OMP tag of <strong>2000</strong>. (Lab_Task 1)</p>
</li>
<li>
<p>ACME wants to have a <strong>hub &amp; spoke topology between Remotes and DCs as well between Remotes and Regional hubs</strong>. Hub &amp; spoke topology will scale more by reducing NO. of tunnels required on the devices. (Lab_Task 2)</p>
</li>
<li>
<p>ACME has categorized their branches into multiple Business Units(BUs). In the Data Center (DC) sites, the headend WAN Edges(WEs) are also categorized into multiple BUs for horizontal scaling purpose in terms of throughputs, therefore remote site only needs to build tunnels to its respective DC hub WEs. <strong>Remote Site1 only needs to build tunnels to DC1-WE1 and DC2-WE2</strong>; on the contrary, <strong>Remote Site 2 only needs to build tunnels to DC1-WE2 and DC2-WE2</strong>.(Lab_Task 2)</p>
</li>
<li>
<p>Remote sites receive default route from both RH and DC, <strong>DCs will be preferred and load shared</strong>. If RH goes down, DCs are load shared for default(Lab_Task 3)</p>
</li>
</ul>
<p><font color='red'>change to <strong>- Remote sites receive default route from both RH and DC, </strong>DCs will be preferred and load shared. RH's default will be used as backup for DCs. (Lab_Task 3)**</font></p>
<ul>
<li>
<p>Remotes sites receive more specific routes from both DCs, <strong>routes originated from local DC are preferred</strong>, if one DC goes down, it will use the routes from another DC as backup. In another words, from remote sites perspective, previously routes tagged with 1000 will prefer DC1; routes tagged with 2000 will prefer DC2.(Lab_Task 4)</p>
</li>
<li>
<p>For remote sites to any other regional routes are forced to go through DC’s functional hub. For <strong>remote site1, it goes through WE1 in DC1 and DC2</strong>; for <strong>remote site 2, it goes through WE2 in DC1 and DC2</strong>.(Lab_Task 4)</p>
</li>
</ul>
<p><strong>Note: In these lab exercises, it's possible that there are multiple ways to achieve the requirements. The lab guide provides a detailed step by step instruction for each taks. However you're welcomed to solve it with your own solution. Just be mindful with the time.</strong></p>
<h2 id="task-1-local-route-policy">Task 1: Local Route Policy</h2>
<h4 id="step-11-verification-of-the-routes-received-on-dc-wes"><strong>Step 1.1</strong> Verification of the routes received on DC WEs.</h4>
<ul>
<li>SSH to <strong>DC1-WE1</strong> (repeat the same on DC1-WE2,DC2-WE1,DC2-WE2,R1-WE1 and R2-WE2 as well) and do <code>show ip route vrf 1</code> and make sure <strong>10.100.100.0/24, 10.200.200/24</strong> as well as <strong>0.0.0.0/0</strong> learned via BGP.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_iproute.png" width="800"/></p>
<h4 id="step-12-verify-the-bgp-communities"><strong>Step 1.2</strong> Verify the BGP communities.</h4>
<ul>
<li>10.100.100.0/24 should tag with 65010:1000; 10.200.200.0/24 should tag with 65020:2000. Execute <code>show ip bgp vpnv4 vrf 1 &lt;prefix&gt;</code> (10.100.100.0/24 and 10.200.200.0/24) on DC1-WE1,WE2 and DC2-WE1,WE2.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_bgpcommunity.png" width="800"/></p>
<h4 id="step-13-set-omp-tag-for-dc-specific-routes"><strong>Step 1.3</strong> set OMP tag for DC specific Routes</h4>
<ul>
<li>login vManage <strong>198.18.133.200</strong> and access policy configuration from <strong>Configuration - Policies</strong></li>
<li>Click <strong>Custom Options</strong> drop down on the top right and select <strong>Route Policy</strong> under <strong>Localized Policy</strong></li>
<li>
<p>Click <strong>Add Route Policy</strong> to Create new</p>
<ul>
<li>Name: <strong>LAB_DCs_BGP_RP</strong>  (write down this name, it will be used later)</li>
<li>Description: <strong>LAB_DCs_BGP_RP</strong></li>
<li>Click <strong>+Sequence Type</strong> on the left then click <strong>+Sequence Rule</strong>, click Match, select <strong>Address</strong>, select <strong>default</strong>.</li>
</ul>
</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_new_lp_1.png" width="800"/></p>
<ul>
<li>Click <strong>Action</strong>, change to <strong>Accept</strong>, then select OMP tag, key in <strong>100</strong>, then save Match and Actions.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_new_lp_2.png" width="800"/></p>
<ul>
<li>
<p>click <strong>Sequence Rule</strong> to create following two rules:</p>
<ul>
<li>Match <strong>community-list DC1_Routes</strong>, <strong>Accept</strong> and Set <strong>Tag 1000</strong></li>
<li>Match <strong>community-list DC2_Routes</strong>, <strong>Accept</strong> and Set <strong>Tag 2000</strong>  </li>
<li>Then click on Save Route Policy</li>
</ul>
</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_new_lp_3.png" width="800"/></p>
<h4 id="step-14-creating-a-local-policy"><strong>Step 1.4</strong> Creating a Local Policy</h4>
<ul>
<li>login vManage <strong>198.18.133.200</strong> and access policy configuration from <strong>Configuration - Policies</strong></li>
<li>Click on <strong>Localized Policy</strong>, then click on <strong>Add Policy</strong></li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_new_lp_4.png" width="800"/></p>
<ul>
<li>Click on Next to proceed till you see <strong>Configure Route Policy</strong>; click <strong>Add Route Policy</strong> then select <strong>Import Existing Policy</strong>; Select <strong>LAB_DCs_BGP_RP</strong> click import</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_new_lp_5.png" width="800"/></p>
<ul>
<li>Click on Next, Key in<ul>
<li>Policy Name: <strong>LAB_DCs_Local_policy</strong></li>
<li>Policy Description: <strong>LAB_DCs_Local_policy</strong> .</li>
<li>Check <strong>Netflow, Application</strong> and <strong>Implicit ACL Logging</strong>.</li>
<li>Then click on Save Policy (Feel free to click Preview before save)</li>
</ul>
</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_new_lp_6.png" width="800"/></p>
<h4 id="step-15-apply-the-route-policy"><strong>Step 1.5</strong> apply the route-policy</h4>
<ul>
<li>Access feature template configuration from <strong>Configuration - Templates - Feature</strong></li>
<li>Locate feture template <strong>Lab_DC_VPN1_BGP_V01</strong> and select three dots then click <strong>Edit</strong>.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_bgp_ft_1.png" width="800"/></p>
<ul>
<li>Select <strong>Neighbor</strong> section, then click on the pencil icon under Action.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_bgp_ft_2.png" width="800"/></p>
<ul>
<li>Update the following:<ul>
<li><strong>Address Family</strong> changes to Global and set to <strong>On</strong></li>
<li><strong>Address Family</strong> changes to Global and set to <strong>ipv4-unicast</strong></li>
<li><strong>Route Policy In</strong> changes to Global and set to <strong>On</strong></li>
<li><strong>Policy Name</strong> changes to Global and set to <strong>LAB_DCs_BGP_RP</strong> (this was the name you wrote down earlier)</li>
</ul>
</li>
<li>then click on Save changes and Click on Update</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_bgp_ft_3.png" width="800"/></p>
<ul>
<li>Then click Next, feel free to review the config changes, then click Configure Devices, then check the Confirm configuration box and click on OK.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_bgp_ft_4.png" width="800"/></p>
<h4 id="step-16-verify-omp-tags"><strong>Step 1.6</strong> Verify OMP Tags</h4>
<ul>
<li>SSH to DC wEdge routers(<strong>DC1-WE1,DC1-WE2,DC2-WE1,DC2-WE2</strong>) and run <strong><code>show ip bgp vpnv4 vrf 1 &lt;prefix&gt;</code></strong> (10.100.100.0/24,10.200.200.0/24), you should see proper OMP tags are set</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_bgp_ft_5.png" width="800"/></p>
<h2 id="task-2-hub-spoke-topologies">Task 2: Hub &amp; Spoke Topologies</h2>
<h4 id="step-21-pre-config-verifications"><strong>Step 2.1.</strong> Pre-config verifications</h4>
<ul>
<li>SSH to <strong>R1-WE1</strong> and do <code>show sdwan omp route vpn 1</code></li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_Routes_1.png" width="800"/></p>
<p><strong>Question: Do you know why the default route learned from private2 shown as invalid and unreachable (Inv,U)</strong>? </n></p>
<p>This is because R1-WE1 doesn't have a transport with private 2 color. If you watch the route on R2-WE1, you should notice the next hop from private 1 marked as <strong>(Inv,U)</strong> for the same reason where private 1 color doesn't exist on R2-WE1.</p>
<p><strong>Question: Did you notice the default route is learned from 1.1.30.2 which is the Regional Hub(RH)? Do you know why?</strong> </n></p>
<p>To answer this question, we will check the route table at vSmart as all the routes are advertised by vSmart. SSH to vSmart and do <code>show omp route vpn 1 0.0.0.0/0 detail | t</code></p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_Routes_2.png" width="800"/></p>
<p>OMP is very much like BGP when it comes down to route preference. In the order of preference, there is a origin-protocol, in this case the default route learned on RH is from Static (by design, in real deployment, probably it's going to be BGP as well); whereas the default learned from DCs is from iBGP. Origin protocol static is more preferred than iBGP.</p>
<p>Now, let's look at the specific routes learned from DC. Do <code>show sdwan omp route vpn 1 10.100.100.0/24</code> on vSmart.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_Routes_3.png" width="800"/></p>
<p><strong>Question: you will see 4 paths and one of the paths shows Inv,U. Hopefully you can answer why it's that. But why there are 4 paths?</strong></p>
<p>Let's SSH to vSmart and do <code>show omp route vpn 1 10.100.100.0/24 | t</code>.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_Routes_4.png" width="800"/></p>
<p>You will see 12 ECMP routes marked as <strong>C,R</strong> (Chosen,Resolved). Why 12? Because we have 4 DC wEdges each with 3 transports, so total 12 paths. </n></p>
<p>The next question will be why there are only 4 paths on the remote wEdges? This is because the ECMP settings on the wEdge by default is set to 4. If you change it to 16 (currently 16, it will be increased to 128 in the future release), you will see all 12 paths. </n></p>
<p><strong>Note: vSmart randomly selects 4 paths (or whatever the max ECMP value is set) and install on the device. In a  large deployment where multiple paths is more than 16 (before 128 paths is supported), this may pose problem.</strong></p>
<p>In this exercise we purposely keep the default ECMP setting and learn how to solve this issue with centralized policy.</p>
<h4 id="step-22-create-a-topology-for-centralized-policy"><strong>Step 2.2.</strong> Create a topology for centralized policy</h4>
<ul>
<li>
<p>login vManage <strong>198.18.133.200</strong> and access policy configuration from <strong>Configuration - Policies</strong></p>
</li>
<li>
<p>Click <strong>Custom Options</strong> drop down on the top right and select <strong>Topology</strong> under <strong>Centralized Policy</strong></p>
</li>
<li>
<p>Click <strong>Add Topology</strong> under <strong>Topology</strong> and select <strong>Custom Control( Route&amp;TLOC )</strong></p>
</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_topo_1.png" width="800"/></p>
<p>You are going to create two topologies, one for each remote site.</p>
<ul>
<li>Create topology policy for Remote1<ul>
<li>Name: <strong>LAB_Topo_RS1</strong></li>
<li>Description: <strong>LAB topology for Remote Site 1</strong></li>
<li>Click <strong>+Sequence Type</strong> and select <strong>Route</strong></li>
<li>Click <strong>+Sequence Rule</strong>, leave unchanged under Match(means match all)</li>
<li>Click <strong>Actions</strong> and change to <strong>Accept</strong> (we'll come back and do the routes policy later).
<img src="https://leitian123.github.io/holent2901/img/lab_task2_topo_2.png" width="800"/></li>
<li>click <strong>+Sequence Type</strong> then select <strong>TLOC</strong></li>
<li>click <strong>+Sequence Rule</strong>, select <strong>TLOC</strong>.</li>
<li>Under <strong>Match Conditions</strong>, selects <strong>DCs-BU1-TLOCs</strong> for <strong>TLOC List</strong> (this TLOC list has been pre-defined for you which includes all the TLOCs of DC1-WE1 and DC2-WE1</li>
<li>Click <strong>Actions</strong>, change Actions to <strong>Accept</strong></li>
<li>Click <strong>+Sequence Rule</strong>, select <strong>TLOC</strong></li>
<li>under <strong>Match Conditions</strong>, selects <strong>RH</strong> for <strong>TLOC List</strong> (this TLOC list has been pre-defined for you which includes all the TLOCs of RH)</li>
<li>Click <strong>Actions</strong>, change Actions to <strong>Accept</strong></li>
</ul>
</li>
<li>Then click save Control Policy.</li>
</ul>
<p>This policy effectively allows R1-WE1 to build tunnels to all the DCs-BU1 devices (DC1-WE1 and DC2-WE1) as well as RH, nothing else as the default action is reject.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_topo_3.png" width="800"/></p>
<ul>
<li>Follow the above steps and create another topology for Remote2 with the following settings:<ul>
<li>Name: <strong>LAB_Topo_RS2</strong></li>
<li>Description: <strong>LAB topology for Remote Site 2</strong></li>
<li>Click <strong>+Sequence Type</strong> then select <strong>Route</strong></li>
<li>Click <strong>+Sequence Rule</strong>, leave unchanged under Match(means match all),</li>
<li>Click <strong>Actions</strong> change Actions to <strong>Accept</strong> (we'll come back and do the routes policy later).
<img src="https://leitian123.github.io/holent2901/img/lab_task2_topo_4.png" width="800"/></li>
<li>Click <strong>+Sequence Type</strong> then select <strong>TLOC</strong></li>
<li>click <strong>+Sequence Rule</strong>, select <strong>TLOC</strong>.</li>
<li>Under <strong>Match Conditions</strong>, selects <strong>DCs-BU2-TLOCss</strong> for <strong>TLOC List</strong> (this TLOC list has been pre-defined for you which includes all the TLOCs of DC1-WE2 and DC2-WE2)</li>
<li>Click <strong>Actions</strong>, change Actions to <strong>Accept</strong></li>
<li>Click <strong>+Sequence Rule</strong>, select <strong>TLOC</strong></li>
<li>under <strong>Match Conditions</strong>, selects <strong>RH</strong> for <strong>TLOC List</strong> (this TLOC list has been pre-defined for you which includes all the TLOCs of RH)</li>
<li>Click <strong>Actions</strong>, change Actions to <strong>Accept</strong></li>
</ul>
</li>
<li>Then click save Control Policy.</li>
</ul>
<p>This policy effectively allows R2-WE1 to build tunnels to all the DCs-BU1 devices (DC1-WE2 and DC2-WE2) as well as RH, nothing else as the default action is reject.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_topo_5.png" width="800"/></p>
<h4 id="step-23-apply-the-topology-policy-to-centralized-policy"><strong>Step 2.3.</strong> Apply the topology policy to Centralized Policy</h4>
<ul>
<li>login vManage <strong>198.18.133.200</strong> and access policy configuration from <strong>Configuration - Policies</strong></li>
<li>Click <strong>Add Policy</strong> under <strong>Centralized Policy</strong></li>
<li>Click next, you will see Configure Topology and VPN membership - Click <strong>Add topology</strong>, select <strong>Import Existing Topology</strong></li>
<li>Click <strong>Custom Control(Route and TLOC)</strong>, select <strong>LAB_Topo_RS1</strong></li>
<li>Click on Add Topology</li>
<li>follow the above steps to add topology <strong>LAB_Topo_RS2</strong> as well</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_topo_6.png" width="800"/></p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_topo_7.png" width="800"/></p>
<ul>
<li>Click <strong>Next</strong> proceed to the last step for Applying Policies to Sites and VPNs<ul>
<li>Policy Name: <strong>LAB_Central_v01</strong></li>
<li>Description: <strong>Task2 Topo only</strong></li>
<li>Click New Site List Under <strong>LAB_Topo_RS1</strong>, under <strong>Outbound Site List</strong>, select <strong>RS1</strong>,then click on Add</li>
<li>Click New Site List Under <strong>LAB_Topo_RS2</strong>, under <strong>Outbound Site List</strong>, select <strong>RS2</strong>,then click on Add
then click Save Policy</li>
</ul>
</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_topo_8.png" width="800"/></p>
<h4 id="step-24-activate-the-first-centralized-policy"><strong>Step 2.4.</strong> Activate the first Centralized Policy</h4>
<ul>
<li>login vManage <strong>198.18.133.200</strong> and access policy configuration from <strong>Configuration - Policies - Centralized Policy</strong></li>
<li>locate policy <strong>LAB_Centeral_v01</strong> you have created in previous step. Click <strong>...</strong> for more option and select <strong>Activate</strong>. The policy will be pushed to vSmarts.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_topo_9.png" width="800"/></p>
<h4 id="step-25-verify-the-hub-spoke-topology"><strong>Step 2.5.</strong> Verify the hub &amp; spoke topology</h4>
<ul>
<li>SSH to R1-WE1 &amp; R2-WE1 do <code>show sdwan bfd sessions</code>, verify no bfd session between R1-WE1 and R2-WE1</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_topo_10.png" width="800"/>
<img src="https://leitian123.github.io/holent2901/img/lab_task2_topo_11.png" width="800"/></p>
<h2 id="task-3-default-route-handling">Task 3: Default Route handling</h2>
<p>In this task. you will configure the central policy to prefer default route learned from DC over RH. You need to modify the Centralized policy so that the default route from DC has higher OMP preference over RH.</p>
<h4 id="step-31-new-central-policy"><strong>Step 3.1.</strong>  New Central Policy</h4>
<ul>
<li>
<p>Make a new version of the topology policy.
<strong>Note: In production network, it is always recommended to create a new version when you update your policy. So you can also change to the previous version as fallback plan.</strong></p>
</li>
<li>
<p>login vManage <strong>198.18.133.200</strong> and access policy configuration from <strong>Configuration - Policies</strong></p>
</li>
<li>Click <strong>Custom Options</strong> drop down on the top right and select <strong>Topology</strong> under <strong>Centralized Policy</strong></li>
<li>Locate policy <strong>LAB_Topo_RS1</strong>, click <strong>...</strong> and select <strong>Copy</strong>.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_1.png" width="800"/>
- Give a name and description for the new policy
    - Name: <strong>LAB_Topo_RS1_V02</strong>
    - Description: <strong>+Default Route handling</strong></p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_2.png" width="800"/></p>
<h4 id="step-32-edit-the-new-topology-policy"><strong>Step 3.2.</strong> Edit the new topology policy.</h4>
<ul>
<li>locate <strong>LAB_Topo_RS1_V02</strong> and click <strong>...</strong> select <strong>Edit</strong></li>
<li>you are going to add two new rules<ul>
<li>rule1: match default &amp; originator of 1.1.10.1(DC1-WE1) then accept and set preference of 100</li>
<li>rule2: match default &amp; originator of 1.1.20.1(DC2-WE1) then accept and set preference of 100</li>
</ul>
</li>
<li>Drag &amp; drop the newly created rules to move it ahead of previous accept all rule.
<strong>Note: vSmart does the lookup based on the order, if it finds the match, it will use that rule and it won't look for subsequent rule any more.</strong></li>
<li>click Save policy.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_3.png" width="800"/></p>
<h4 id="step-33-apply-the-policy"><strong>Step 3.3.</strong> Apply the policy</h4>
<ul>
<li>
<p>login vManage <strong>198.18.133.200</strong> and access policy configuration from <strong>Configuration - Policies</strong></p>
</li>
<li>
<p>locate centralized policy <strong>LAB_Central_v01</strong>, click <strong>...</strong> and select <strong>Edit</strong></p>
</li>
</ul>
<p><strong>Note: In production deployment, you always want to use the same practice of copying the current policy then apply it.</strong></p>
<ul>
<li>Under <strong>Topology</strong> tab, select <strong>LAB_Topo_RS1</strong>. Click <strong>...</strong> and select <strong>Detach</strong> to remove this topology.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_4.png" width="800"/></p>
<ul>
<li>Click <strong>Add Topology</strong>, select <strong>Import Existing Topology</strong> then select <strong>LAB_Topo_RS1_V02</strong>, then click Import.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_5.png" width="800"/></p>
<ul>
<li>Click on <strong>Policy Application</strong></li>
<li>Under <strong>LAB_Topo_RS1_V02 - Outbound Site List</strong>, click <strong>New Site List</strong> and select <strong>RS1</strong>.</li>
<li>click <strong>ADD</strong>, Save Policy Changes to Activate.</li>
</ul>
<p><strong>Note: Outbound and Inbound are from vSmart perspective where outbound policy means how the routes are sent out from vSmart; inbound policy means how the routes are sent to the vSmart.</strong></p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_6.png" width="800"/></p>
<h4 id="step-34-verify-change-of-default-route"><strong>Step 3.4.</strong> Verify change of default route</h4>
<ul>
<li>SSH to <strong>R1-WE1</strong> and do <code>show sdwan omp route</code> and check the learned TLOC for default route as well as preference.
</n></li>
</ul>
<p>We're expecting the routes which are learned from DC1-WE1 and DC2-WE1 with preference of 100. However, the output shows the routes are not changed at all, the three installed routes still learned from RH and no preference set either. Why is that?</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_7.png" width="800"/></p>
<p>Let's check omp route table on the vSmart, SSH to vSmart and do <code>show omp route | t</code>. As you recall, the OMP routes don't have any changes either where 3 paths learned from RH marked with C,R due to routes originated from Static which are preferred over originated from iBGP. But why the outbound policy setting the routes originated from DC1-WE1 and DC2-WE1 doesn't work, <strong>this is because outbound policy will only look for the chosen routes with C.R by default, other routes without learned from DCs as they are not chosen without C,R</strong>, so those routes are not even going through the outbound policies. There are multiple way of changing this behavior such as using inbound policy or configure send-backup path, or make every route with C.R. We're not going over all the solutions.</p>
<p>Let's configure an vSmart <strong>inbound policy</strong> to make the default routes from DCs have higher OMP preference than RH's.</p>
<p><strong>Note: vSmart inbound policy may not be an ideal solution for the scenarios. It is recommended to use outbound policy only if an outbound policy can meet the requirements without additional inbound policy for its simplicity and full visibility of vSmart.</strong></p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_8.png" width="800"/></p>
<h4 id="step-35-create-new-topology"><strong>Step 3.5.</strong> Create new topology</h4>
<ul>
<li>login vManage <strong>198.18.133.200</strong> and access policy configuration from <strong>Configuration - Policies</strong></li>
<li>Click <strong>Custom Options</strong> on the upper right corner and select <strong>Topology</strong> under <strong>Centralized Policy</strong>.</li>
<li>Click <strong>Add Topology</strong> and select <strong>Custom Control(Route&amp;TLOC)</strong></li>
<li>Configure the new policy with following setting<ul>
<li>Name: <strong>default_route_from_DC</strong></li>
<li>Description: <strong>default_route_from_DC</strong></li>
<li>click <strong>+Sequence Type</strong> and select <strong>Route</strong></li>
<li>click <strong>+Sequence Rule</strong></li>
<li>click <strong>Prefix List</strong> and <strong>Site</strong> under <strong>Match</strong>  </li>
<li>Under <strong>Match Conditions</strong>, select <strong>default</strong> from <strong>Prefix List</strong> dropdown</li>
<li>Under <strong>Match Conditions</strong>, select <strong>DCs</strong> from <strong>Site List</strong> dropdown</li>
<li>Click <strong>Actions</strong> select <strong>Accept</strong>; add <strong>Preference</strong> with value <strong>50</strong></li>
<li>Click <strong>Default Action</strong> and change action to <strong>Accept</strong></li>
<li>Click <strong>Save Control Policy</strong></li>
</ul>
</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_9.png" width="800"/></p>
<ul>
<li>Apply this new topology to the current policy.</li>
<li>login vManage <strong>198.18.133.200</strong> and access policy configuration from <strong>Configuration - Policies</strong></li>
<li>locate <strong>LAB_Central_v01</strong> and select <strong>Edit</strong></li>
<li>Click Topology tab and click <strong>Add Topology</strong></li>
<li>Select <strong>Import Existing Topology</strong> and select <strong>Custom Control( Route and TLOC)</strong> Policy Type then select <strong>default_route_from_DC</strong> from drop down; click Import.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_10.png" width="800"/></p>
<ul>
<li>Click on <strong>Policy Application</strong>, click on <strong>New Site List</strong> under <strong>Inbound Site List</strong>, select <strong>DCs</strong>.</li>
<li>Click on Add and <strong>Save Policy Changes</strong> to Activate.</li>
</ul>
<p><strong>Note: This time is an inbound policy where inbound policy controls how the vSmart are seeing the routes.</strong></p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_11.png" width="800"/></p>
<h4 id="step-36-verify"><strong>Step 3.6.</strong> verify</h4>
<ul>
<li>SSH to vSmart and run <code>show omp route vpn 1 | t</code>, you will see the routes from DCs are C,R with preference 50 now which is expected.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_12.png" width="800"/></p>
<ul>
<li>SSH to <strong>R1-WE1</strong> and do <code>show sdwan omp route vpn 1</code>. You will see 4 paths from DCs with preference 100. Remember the vSmart outbound policy we assign preference of 100 where the inbound policy we assign preference of 50 so that we can differentiate which policy is taking effect.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_13.png" width="800"/></p>
<p><strong>Well done! You have finished the default route handling task for R1-WE1.Let's do the same policy for R2-WE1.</strong></p>
<h4 id="step-37-create-topology-policy-for-remote2"><strong>Step 3.7.</strong> Create topology policy for Remote2</h4>
<ul>
<li>login vManage <strong>198.18.133.200</strong> and access policy configuration from <strong>Configuration - Policies</strong></li>
<li>Click <strong>Custom Options</strong> on the upper right corner and select <strong>Topology</strong> under <strong>Centralized Policy</strong>.</li>
<li>Locate <strong>LAB_Topo_RS1v02</strong> click <strong>...</strong> select copy and change Name and Description to <strong>LAB_Topo_RS2_v02</strong> then click Copy.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_14.png" width="800"/></p>
<ul>
<li>locate newly created <strong>LAB_Topo_RS2_v02</strong>. click <strong>...</strong> select Edit</li>
<li>Select <strong>TLOC</strong> as the Sequence Type, edit Rule1.</li>
</ul>
<p><strong>Note: We need to change the TLOC List from BU1 to BU2 as we'd like to use the BU2's functional hub which are DC1-WE2 and DC2-WE2 as the entry point for remote site 2(Remember remote site 2 represents the remote sites for BU2, where remote site 1 represents the remote sites for BU1).</strong></p>
<ul>
<li>Remove <strong>DCs-BU1-TLOCs</strong> by clicking the <strong>x</strong>, then select <strong>DCs-BU2-TLOCs</strong> and click <strong>Save Match and Actions</strong>.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_TLOC_15.png" width="800"/></p>
<ul>
<li>Select <strong>Route</strong> as the <strong>Sequence Type</strong>, you need to change the <strong>originator</strong> from 1.1.10.1 and 1.1.20.2 to 1.1.10.2 and 1.1.20.2 respectively . By doing this, default route from DC1-WE2 and DC2-WE2 will have OMP preference of 100 sent to R2-WE2 site.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_15.png" width="800"/></p>
<ul>
<li>After <strong>Save Control Policy</strong>, access the <strong>Centralized Policy</strong> from <strong>Configuration - Policies</strong></li>
<li>locate <strong>LAB_Central_v01</strong> and select <strong>Edit</strong>  </li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_16.png" width="800"/></p>
<ul>
<li>Under <strong>Topology</strong> tab, click <strong>Add Topology</strong> and select <strong>Import Existing Topology</strong></li>
<li>change Policy Type to <strong>Custom Control( Route and TLOC )</strong>; select <strong>LAB_Topo_RS2_V02</strong> and Import.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_17.png" width="800"/></p>
<ul>
<li>Select existing topology <strong>LAB_Topo_RS2</strong>, click <strong>detach</strong> to remove it from Centralized Policy.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_18.png" width="800"/></p>
<ul>
<li>Click <strong>Policy Application</strong>; under <strong>LAB_Topo_RS2_V02</strong> click <strong>New Site List</strong> and select <strong>RS2</strong> as outbound site list.</li>
<li>click Add, and <strong>Save Policy Changes</strong> to Activate.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_19.png" width="800"/></p>
<ul>
<li>Once the policy has been pushed to vSmart, let's verify by SSH to <strong>R2-WE1</strong> and run <code>show ip route vrf 1</code>. Now, default route has two ECMP paths, one path for each DC.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_20.png" width="800"/>
- do <code>show sdwan omp route vpn 1</code>.You will see that there are 4 paths in the OMP route table, however none of them is valid.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_21.png" width="800"/></p>
<h2 id="task-4-specific-routes-handling">Task 4: Specific Routes handling</h2>
<p>ACME wants to prefer more specific routes originated from its DC and use the other DC as backup. In the meanwhile, for BU1 (R1-WE1), it only needs to learn the routes from BU1's Headend devices (DC1-WE1, DC2-WE1); for BU2(R2-WE1), it only needs to learn the routes from BU2's Headend devices.(DC1-WE2, DC2-WE2)
The specific routes from DC1 are tagged with 1000, from DC2 already tagged with 2000 in previous task. In this section, you are going to create different policies for BU1 and BU2 sites and set different OMP preference based on OMP tag.</p>
<h4 id="step41-modify-topology-policy-for-remote1">Step4.1: Modify Topology policy for remote1</h4>
<ul>
<li>login vManage <strong>198.18.133.200</strong> and access policy configuration from <strong>Configuration - Policies</strong></li>
<li>Click <strong>Custom Options</strong> on the upper right corner and select <strong>Topology</strong> under <strong>Centralized Policy</strong>.</li>
<li>locate topology <strong>LAB_Topo_RS1_V02</strong>. click <strong>...</strong> and select <strong>Edit</strong></li>
<li>Select <strong>Route</strong> under <strong>Sequence Type</strong>, you are going to add four more rules.</li>
<li>rule1<ul>
<li>Click <strong>Sequence Rule</strong>, select <strong>OMP Tag</strong> and <strong>TLOC</strong> for match condition</li>
<li>Under <strong>Match Conditions</strong>, type <strong>1000</strong> in <strong>OMP Tag</strong>; <strong>DC1-BU1-TLOCs</strong> in <strong>TLOC List</strong></li>
<li>Click <strong>Actions</strong>, change to <strong>Accept</strong> and set <strong>Preference</strong> of 100.</li>
<li>Click <strong>Save Match And Actions</strong></li>
</ul>
</li>
<li>rule2<ul>
<li>Click <strong>Sequence Rule</strong>, select <strong>OMP Tag</strong> and <strong>TLOC</strong> for match condition</li>
<li>Under <strong>Match Conditions</strong>, type <strong>1000</strong> in <strong>OMP Tag</strong>; <strong>DC2-BU1-TLOCs</strong> in <strong>TLOC List</strong></li>
<li>Click <strong>Actions</strong>, change to <strong>Accept</strong> and set <strong>Preference</strong> of 50</li>
<li>Click <strong>Save Match And Actions</strong></li>
</ul>
</li>
<li>rule3<ul>
<li>Click <strong>Sequence Rule</strong>, select <strong>OMP Tag</strong> and <strong>TLOC</strong> for match condition</li>
<li>Under <strong>Match Conditions</strong>, type <strong>2000</strong> in <strong>OMP Tag</strong>; <strong>DC2-BU1-TLOCs</strong> in <strong>TLOC List</strong></li>
<li>Click <strong>Actions</strong>, change to <strong>Accept</strong> and set <strong>Preference</strong> of 100.</li>
<li>Click <strong>Save Match And Actions</strong>  </li>
</ul>
</li>
<li>rule4<ul>
<li>Click <strong>Sequence Rule</strong>, select <strong>OMP Tag</strong> and <strong>TLOC</strong> for match condition</li>
<li>Under <strong>Match Conditions</strong>, type <strong>2000</strong> in <strong>OMP Tag</strong>; <strong>DC1-BU1-TLOCs</strong> in <strong>TLOC List</strong></li>
<li>Click <strong>Actions</strong>, change to <strong>Accept</strong> and set <strong>Preference</strong> of 50</li>
<li>Click <strong>Save Match And Actions</strong></li>
</ul>
</li>
<li>Dragging and Drop to move up the newly created rules ahead of the <strong>accept all</strong> rule. (if you follow the lab previously, the new rules should be No. 5, 6,7 and 8, match all rule should be rule No. 9)
<strong>Note: vSmart does the lookup based upon the order, if it finds the match, it will use that rule and it won't look for subsequent rule.</strong></li>
<li>click <strong>Save policy</strong> to Activate. This will make the vSmart to push the policy immediately after you confirm configuring devices
<strong>This is expected, creating a new policy is a best practice otherwise updating the existing active policy will cause the immediate policy push.</strong></li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task4_routes_1.png" width="800"/></p>
<ul>
<li>To verify, SSH to <strong>R1-WE1</strong> and run <code>show sdwan omp route vpn 1</code></li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task4_routes_2.png" width="800"/></p>
<p>You can see 4 paths for 10.100.100.0/24, however we see 3 paths with preference of 100, 1 path doesn't have preference; and for 10.200.200.0/24, there are 4 paths however 3 paths with preference of 50, 1 path doesn't have preference. If you look at it closely you will notice that the paths picked are from the lowest system-ip.</p>
<p>This is caused that vSmart by default will only send 4 paths to the wEdges. When vSmart is going through the outbound policy, it takes a route from vsmart route table in the winning order (marked as C,R) and compare it with the outbound policy as long as there is a match (permit) in the policy for a particular prefix, it will send it out and count it as one until it hits the send-path-limits which is 4 by default. Since in our route-policy, we have a permit all at the end which means every route will have a match, therefore first 4 routes in the winning order are sent out regardless which rule they're matching in the policy. There are multiple ways to fix this, the simple way is to change the limit to 16 on both vSmart as well as on the wEdges.</p>
<h4 id="step42-configure-16-paths-ecmp">Step4.2: Configure 16 paths ECMP</h4>
<ul>
<li>Configure vSmart to send 16 paths</li>
<li>
<ul>
<li>Access template configuration from <strong>Configuration - Templates</strong></li>
</ul>
</li>
<li>Under <strong>Device</strong> template tab, locate template <strong>vSmart</strong> and select <strong>Edit</strong></li>
<li>under <strong>OMP</strong> config section, add configure <strong>send-path-limit 16</strong>. Click update to update the configure.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task4_routes_3.png" width="800"/></p>
<ul>
<li>Change ecmp-limit to 16 on the wEdges.</li>
<li>Access template configuration from <strong>Configuration - Templates</strong></li>
<li>Under <strong>Feature</strong> template tab, locate template <strong>Lab_OMP_V01</strong> and select <strong>Edit</strong></li>
<li>Under <strong>Basic Configuration</strong> section, change <strong>ECMP</strong> to <strong>16</strong> as Global variable.</li>
<li>Click update to push configuration changes.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task4_routes_4.png" width="800"/></p>
<h4 id="step43-verification">Step4.3: Verification</h4>
<ul>
<li>SSH to <strong>R1-WE1</strong> and run <code>show sdwan omp route vpn 1</code>
You should see each route (10.100.100.0/24 and 10.200.200.0/24) will have 12 paths and 3 paths from prefered DC with preference of 100, 3 paths from secondary DC with preference of 50, another 6 paths from are invalid from other BU hub devices.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task4_routes_5.png" width="800"/></p>
<ul>
<li>run <code>show ip route vrf 1</code>
You will see 10.100.100.0/0 is learned from 1.1.10.1; 10.200.200.0/24 is learned from 1.1.20.1 which is desired.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task4_routes_6.png" width="800"/></p>
<h4 id="step44-modify-topology-policy-for-remote2">Step4.4: Modify Topology policy for remote2</h4>
<ul>
<li>login vManage <strong>198.18.133.200</strong> and access policy configuration from <strong>Configuration - Policies</strong></li>
<li>Click <strong>Custom Options</strong> on the upper right corner and select <strong>Topology</strong> under <strong>Centralized Policy</strong>.</li>
<li>locate topology <strong>LAB_Topo_RS2_V02</strong>. click <strong>...</strong> and select <strong>Edit</strong></li>
<li>Select <strong>Route</strong> under <strong>Sequence Type</strong>, you are going to add four more rules.</li>
<li>rule1<ul>
<li>Click <strong>Sequence Rule</strong>, select <strong>OMP Tag</strong> and <strong>TLOC</strong> for match condition</li>
<li>Under <strong>Match Conditions</strong>, type <strong>1000</strong> in <strong>OMP Tag</strong>; <strong>DC1-BU2-TLOCs</strong> in <strong>TLOC List</strong></li>
<li>Click <strong>Actions</strong>, change to <strong>Accept</strong> and set <strong>Preference</strong> of 100.</li>
<li>Click <strong>Save Match And Actions</strong></li>
</ul>
</li>
<li>rule2<ul>
<li>Click <strong>Sequence Rule</strong>, select <strong>OMP Tag</strong> and <strong>TLOC</strong> for match condition</li>
<li>Under <strong>Match Conditions</strong>, type <strong>1000</strong> in <strong>OMP Tag</strong>; <strong>DC2-BU2-TLOCs</strong> in <strong>TLOC List</strong></li>
<li>Click <strong>Actions</strong>, change to <strong>Accept</strong> and set <strong>Preference</strong> of 50</li>
<li>Click <strong>Save Match And Actions</strong></li>
</ul>
</li>
<li>rule3<ul>
<li>Click <strong>Sequence Rule</strong>, select <strong>OMP Tag</strong> and <strong>TLOC</strong> for match condition</li>
<li>Under <strong>Match Conditions</strong>, type <strong>2000</strong> in <strong>OMP Tag</strong>; <strong>DC2-BU2-TLOCs</strong> in <strong>TLOC List</strong></li>
<li>Click <strong>Actions</strong>, change to <strong>Accept</strong> and set <strong>Preference</strong> of 100.</li>
<li>Click <strong>Save Match And Actions</strong>  </li>
</ul>
</li>
<li>rule4<ul>
<li>Click <strong>Sequence Rule</strong>, select <strong>OMP Tag</strong> and <strong>TLOC</strong> for match condition</li>
<li>Under <strong>Match Conditions</strong>, type <strong>2000</strong> in <strong>OMP Tag</strong>; <strong>DC1-BU2-TLOCs</strong> in <strong>TLOC List</strong></li>
<li>Click <strong>Actions</strong>, change to <strong>Accept</strong> and set <strong>Preference</strong> of 50</li>
<li>Click <strong>Save Match And Actions</strong></li>
</ul>
</li>
<li>Dragging and Drop to move up the newly created rules ahead of the <strong>accept all</strong> rule. (if you follow the lab previously, the new rules should be No. 5, 6,7 and 8, match all rule should be rule No. 9)
<strong>Note: vSmart does the lookup based upon the order, if it finds the match, it will use that rule and it won't look for subsequent rule.</strong></li>
<li>click <strong>Save policy</strong> to Activate. This will make the vSmart to push the policy immediately after you confirm configuring devices
<strong>This is expected, creating a new policy is a best practice otherwise updating the existing active policy will cause the immediate policy push.</strong></li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task4_routes_7.png" width="800"/></p>
<h4 id="step45-verification">Step4.5: Verification</h4>
<ul>
<li>SSH to <strong>R2-WE1</strong> and run <code>show sdwan omp route vpn 1</code>
You should see each route (10.100.100.0/24 and 10.200.200.0/24) will have 12 paths and 3 paths from prefered DC with preference of 100, 3 paths from secondary DC with preference of 50, another 6 paths from are invalid from other BU hub devices.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task4_routes_8.png" width="800"/></p>
<ul>
<li>run <code>show ip route vrf 1</code>
You will see 10.100.100.0/0 is leared from 1.1.10.2; 10.200.200.0/24 is learned from 1.1.20.2 whis is desired.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task4_routes_9.png" width="800"/></p>
<h6 id="this-concludes-the-routing-handling-for-the-specific-routes"><strong>This concludes the routing handling for the specific routes.</strong></h6>
<h2 id="task-5-application-aware-routing">Task 5: Application Aware Routing</h2>
<p>ACME wants to provide best user experience for their transactional data ( we will use SSH to simulate that) which has to meet the below SLA requirement. In the mean while, ACME would like to use private 1 as the preferred link, if private 1 doesn't meet the SLA requirement, it will use private 2 when private 2 still meets the SLA. LTE link will only be used when both private 1 and private 2 go down. ACME has the following SLA requirements for their applications.</p>
<table>
<thead>
<tr>
<th align="center">Application</th>
<th align="center">Loss(%)</th>
<th align="center">Lattency(msec)</th>
<th align="center">Jitter(msec)</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><strong>Transactional Data</strong></td>
<td align="center">5</td>
<td align="center">50</td>
<td align="center">100</td>
</tr>
<tr>
<td align="center"><strong>Bulk-Data</strong></td>
<td align="center">10</td>
<td align="center">300</td>
<td align="center">100</td>
</tr>
<tr>
<td align="center"><strong>Voice-and-Video</strong></td>
<td align="center">2</td>
<td align="center">45</td>
<td align="center">100</td>
</tr>
<tr>
<td align="center"><strong>Default</strong></td>
<td align="center">25</td>
<td align="center">300</td>
<td align="center">100</td>
</tr>
</tbody>
</table>
<p>Solutions: Application Aware Routing (AAR) is one of the differentiator between SDWAN and traditional WAN technology where you can route traffic based upon Application's SLA. You can classify an application based upon traditional 5 tuples or even applications (Deep Pakcket Inspection). There three action keyword for the seleted application. Prefer; backup and strict. The key to remember is AAR is all about SLA.</p>
<p>Prefer means when the preferred color/s meets the SLA, this/these colors will be prefered. If all the preferred colors don't meet the SLA, then depends on if you have backup or strict configure, these two options are mutual exclusive.</p>
<p>If backup color is configured which means when preferred color doesn't meet SLA, first it will use all other colors meeting the SLA regardless if that color is configured as backup or not as long as the color meets the SLA, if there are multiple such colors, it will do load sharing among them. If none of the colors meeting the SLAs, it will use the configured backup color.</p>
<p>If strict is configured (note: stric and backup are mutual exclusive ), the matching traffic will be dropped when the preferred color is not configured.</p>
<p>Based upon the requirements, we will do the following, first confgure LTE as last resort which means it won't come up until all other circuits are not available. Then we configure private1 as preferred color, we simply don't need to mention private2 as if private2 meets the SLA, it will be used anyway. If private2 doesn't meet SLA, as neither strict nor backup is configured, it will simply use any available tunnels.</p>
<h4 id="step51-configure-rh-lte-interface-be-used-only-when-all-other-circuits-are-unavailable">Step5.1: Configure RH LTE interface be used only when all other circuits are unavailable.</h4>
<ul>
<li>Access template configuration from <strong>Configuration - Templates</strong></li>
<li>Under <strong>Feature</strong> template tab, locate template <strong>Lab_RH_VPN0_LTE_V01</strong> and select <strong>Edit</strong></li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_LTE_1.png" width="800"/></p>
<ul>
<li>Under <strong>Tunnel</strong> section, expand <strong>Advanced Options</strong>; change <strong>Last-Resort Circuit</strong> settings to <strong>On</strong>.</li>
<li>Click <strong>Update</strong> to trigger configure push
This setting will make LTE last-resort which means the interface will go down, and no traffic go across it until all other circuits become unavailable.
<img src="https://leitian123.github.io/holent2901/img/lab_task5_LTE_2.png" width="800"/></li>
</ul>
<h4 id="step52-last-resort-verification">Step5.2: Last-Resort verification.</h4>
<ul>
<li>SSH to <strong>RH</strong> and run <code>show ip int brief</code> You will notice Gig3 is down and Tunnel3 is down as well.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_LTE_3.png" width="800"/></p>
<ul>
<li>Run <code>show sdwan control connections</code>. Notice there is no control connections on LTE.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_LTE_4.png" width="800"/></p>
<ul>
<li>Run <code>show sdwan bfd sessions</code>, and there is no IPSec tunnel over LTE either.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_LTE_5.png" width="800"/></p>
<h4 id="step53-configure-sla-classes-for-app-aware-routing-aar">Step5.3: Configure SLA classes for app aware routing (AAR)</h4>
<ul>
<li>login vManage <strong>198.18.133.200</strong> and access policy configuration from <strong>Configuration - Policies</strong></li>
<li>Click <strong>Custom Options</strong> drop down on the top right and select <strong>Lists</strong> under <strong>Centralized Policy</strong></li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_1.png" width="800"/></p>
<ul>
<li>select <strong>SLA Class</strong> and confirm the classes are defined properly.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_2.png" width="800"/></p>
<ul>
<li>Click <strong>Custom Options</strong> drop down on the top right and select <strong>Traffic Policy</strong> under <strong>Centralized Policy</strong></li>
<li>Select <strong>Application Aware Routing</strong> and <strong>Add Policy</strong> to create new
<img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_3.png" width="800"/></li>
<li>Configure the AAR policy with below settings<ul>
<li>Name: <strong>LAB_AAR_V01</strong></li>
<li>Description: <strong>LAB_AAR_V01</strong></li>
<li>click <strong>+Sequence Type</strong> and click <strong>Sequence Rule</strong></li>
<li>select <strong>Destination Port</strong> for <strong>Match</strong> condition</li>
<li>under <strong>Match Conditions</strong>, type <strong>22</strong> in destination port</li>
<li>click <strong>Actions</strong>, select <strong>SLA Class List</strong> and <strong>Counter</strong></li>
<li>under <strong>Actions</strong><ul>
<li>SLA Class: <strong>Transactional-Data</strong>  </li>
<li>Preferred Color: <strong>private1</strong></li>
<li>Counter: <strong>transactional-data</strong></li>
</ul>
</li>
</ul>
</li>
<li>Click <strong>Save Match And Actions</strong></li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_4.png" width="800"/></p>
<ul>
<li>Click 'Save Application Aware Routing Policy'</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_5.png" width="800"/></p>
<h4 id="step54-apply-the-aar">Step5.4: Apply the AAR</h4>
<ul>
<li>Access policy configuration from <strong>Configuration - Policies</strong></li>
<li>Locate <strong>LAB_Central_v01</strong> click <strong>...</strong> for more option and select <strong>Copy</strong></li>
<li>Name the new policy <strong>LAB_Central_v02</strong></li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_6.png" width="800"/></p>
<ul>
<li>Select the new policy <strong>LAB_Central_v02</strong>, click <strong>...</strong> for more option and select <strong>Edit</strong></li>
<li>under <strong>Traffic Rules - Application Aware Routing</strong>, click <strong>Add Policy</strong> then <strong>Import Existing</strong>, select <strong>LAB_AAR_V01</strong> and Import.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_7.png" width="800"/></p>
<ul>
<li>Click <strong>Policy Application</strong> tab then select <strong>Application Aware Routing</strong><ul>
<li>click <strong>New Site List and VPN List</strong> to add<ul>
<li>New Site List: <strong>DCs and RH</strong></li>
<li>VPN List: <strong>VPN1</strong></li>
</ul>
</li>
</ul>
</li>
<li>
<p>click on Add then <strong>Save Policy Changes</strong>
<img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_8.png" width="800"/></p>
</li>
<li>
<p>Activate <strong>LAB_Central_v02</strong> policy by clicking <strong>...</strong> and select <strong>activate</strong>.</p>
</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_9.png" width="800"/></p>
<h4 id="step55-lab-verification">Step5.5: Lab Verification</h4>
<ul>
<li>login vManage <strong>198.18.133.200</strong> and select <strong>Monitor - Network</strong></li>
<li>click <strong>RH-WE1</strong> to bring up device monitor page, and select <strong>Troubleshooting</strong> from the panel on the left</li>
<li>select <strong>Simulate Flows</strong> tool under <strong>Traffic</strong> and use the following value for simulated flow<ul>
<li>VPN: <strong>VPN-1</strong></li>
<li>Source/Interface for VPN-1: <strong>Gigabiethernet4 - ipv4 - 10.10.30.2</strong></li>
<li>Source IP: <strong>10.10.30.2</strong></li>
<li>Destination IP: <strong>10.100.100.100</strong></li>
<li>Click on <strong>Advanced Options</strong>:</li>
<li>Protocol: 6 (TCP)</li>
<li>Destination Port: 22</li>
<li>All Paths: Checked</li>
</ul>
</li>
<li>Click <strong>Simulate</strong></li>
</ul>
<p>You should see the traffic is only taking the private1 path which means it's using private1 as the preferred transport.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_10.png" width="800"/></p>
<p>Do another simulation, this time change the destination port to 23, everything else remains the same.</p>
<p>You should see the traffic will use both <strong>private1</strong> and <strong>private2</strong> which means it uses all available circuits for all other traffic.
<img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_11.png" width="800"/></p>
<ul>
<li>Now let's shutdown the private1 interface of the RH-WE1 and verify again.</li>
<li>Access template configuration from <strong>Configuration - Templates</strong></li>
<li>Locate deice template <strong>Lab-RH-V01</strong>, click <strong>...</strong> and select <strong>Change Device Values</strong></li>
<li>click <strong>...</strong> to select <strong>Edit Device Template</strong></li>
<li>select the <strong>Shutdown(vpn_if_interface)</strong> checkbox under <strong>GigabitEthernet1</strong></li>
<li>click Update -&gt; next to trigger the configure change.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_12.png" width="800"/></p>
<ul>
<li>
<p>Now let's verify it again.</p>
</li>
<li>
<p>login vManage <strong>198.18.133.200</strong> and select <strong>Monitor - Network</strong></p>
</li>
<li>click <strong>RH-WE1</strong> to bring up device monitor page, and select <strong>Troubleshooting</strong> from the panel on the left</li>
<li>select <strong>Simulate Flows</strong> tool under <strong>Traffic</strong> and use the following value for simulated flow<ul>
<li>VPN: <strong>VPN-1</strong></li>
<li>Source/Interface for VPN-1: <strong>Gigabiethernet4 - ipv4 - 10.10.30.2</strong></li>
<li>Source IP: <strong>10.10.30.2</strong></li>
<li>Destination IP: <strong>10.100.100.100</strong></li>
<li>Click on <strong>Advanced Options</strong>:</li>
<li>Protocol: 6 (TCP)</li>
<li>Destination Port: 22</li>
<li>All Paths: Checked</li>
</ul>
</li>
<li>Click <strong>Simulate</strong></li>
</ul>
<p>You should see the traffic is only taking the private2 path now as private2 is the only one available.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_13.png" width="800"/></p>
<ul>
<li>Let's shutdown private2 interface and erify again</li>
<li>Access template configuration from <strong>Configuration - Templates</strong></li>
<li>Locate deice template <strong>Lab-RH-V01</strong>, click <strong>...</strong> and select <strong>Change Device Values</strong></li>
<li>click <strong>...</strong> to select <strong>Edit Device Template</strong></li>
<li>select the <strong>Shutdown(vpn_if_interface)</strong> checkbox under <strong>GigabitEthernet2</strong></li>
<li>
<p>click Update -&gt; next to trigger the configure change.</p>
</li>
<li>
<p>Now let's verify it again.</p>
</li>
<li>
<p>login vManage <strong>198.18.133.200</strong> and select <strong>Monitor - Network</strong></p>
</li>
<li>click <strong>RH-WE1</strong> to bring up device monitor page, and select <strong>Troubleshooting</strong> from the panel on the left</li>
<li>select <strong>Simulate Flows</strong> tool under <strong>Traffic</strong> and use the following value for simulated flow<ul>
<li>VPN: <strong>VPN-1</strong></li>
<li>Source/Interface for VPN-1: <strong>Gigabiethernet4 - ipv4 - 10.10.30.2</strong></li>
<li>Source IP: <strong>10.10.30.2</strong></li>
<li>Destination IP: <strong>10.100.100.100</strong></li>
<li>Click on <strong>Advanced Options</strong>:</li>
<li>Protocol: 6 (TCP)</li>
<li>Destination Port: 22</li>
<li>All Paths: Checked</li>
</ul>
</li>
<li>Click <strong>Simulate</strong></li>
</ul>
<p>You should see the traffic is taking LTE interface only.
<img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_14.png" width="800"/></p>
<p><strong>Great! You're completed task 5. Before proceed further, let's no shutdown the private1 and private2 interfaces by changing the device vlau of RH-WE1's device template.</strong></p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_15.png" width="800"/></p>
<h2 id="task-6-application-pinning">Task 6: Application Pinning</h2>
<p>ACME wants to only run its business critical applications over LTE when all other links go down due to limited available bandwidth on the LTE link. Non-business critical application (such as ICMP) will need to be dropped when LTE comes up.</p>
<p>SDWAN Data Policy is a means to pin certain applications on the certain links.</p>
<h4 id="step61-configure-data-policy">Step6.1: Configure Data Policy</h4>
<ul>
<li>login vManage <strong>198.18.133.200</strong> and access policy configuration from <strong>Configuration - Policies</strong></li>
<li>Click <strong>Custom Options</strong> drop down on the top right and select <strong>Traffic Policy</strong> under <strong>Centralized Policy</strong></li>
<li>click <strong>Traffic Data</strong> and click <strong>Add Policy</strong> to create new data policy</li>
<li><strong>Create New</strong> policy with following setting<ul>
<li>Name: <strong>LAB1_DP_V01</strong></li>
<li>Description: <strong>LAB1_DP_V01</strong></li>
<li>click <strong>+Sequence Type</strong> and select <strong>Custom</strong></li>
<li>click <strong>+Sequence Rule</strong> and select <strong>protocol</strong> for Match condition</li>
<li>under Match Conditions:<ul>
<li>protocol: 6 (TCP)</li>
</ul>
</li>
<li>click Actions and change to <strong>Accept</strong>, and click <strong>Local TLOC</strong> for action<ul>
<li>Local TLOC (color): private1, private2, LTE</li>
</ul>
</li>
</ul>
</li>
<li>save <strong>Match and Actions</strong>
<img src="https://leitian123.github.io/holent2901/img/lab_task6_DP_1.png" width="800"/>  <ul>
<li>click <strong>+Sequence Rule</strong> and select <strong>protocol</strong> for Match condition</li>
<li>under Match Conditions:<ul>
<li>protocol: 1 (ICMP)</li>
</ul>
</li>
<li>click Actions and change to <strong>Accept</strong>, and click <strong>Local TLOC</strong> for action<ul>
<li>Local TLOC (color): private1, private2</li>
<li>check <strong>Restrict</strong> (this means traffic will be dropped when configured TLOC is unreachable)</li>
</ul>
</li>
<li>save Match and Actions</li>
</ul>
</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task6_DP_2.png" width="800"/>
 - Click <strong>Default Action</strong>, and change action to <strong>Accept</strong>
 - click <strong>Save Match and Actions</strong> then click Save Data Policy</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task6_DP_3.png" width="800"/></p>
<h4 id="step62-apply-data-policy">Step6.2: Apply Data Policy</h4>
<ul>
<li>Access policy configuration from <strong>Configuration - Policies</strong></li>
<li>Locate <strong>LAB_Central_v02</strong> click <strong>...</strong> for more option and select <strong>Edit</strong></li>
<li>Click <strong>Traffic Rules</strong> and select <strong>Traffic Data</strong></li>
<li>Click <strong>Add Policy</strong> and select <strong>Import Existing</strong>; select <strong>LAB1_DP_V01</strong> from Policy dropdown and <strong>Import</strong></li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task6_DP_4.png" width="800"/></p>
<ul>
<li>Click <strong>Policy Application</strong> and select <strong>Traffic Data</strong></li>
<li>click <strong>+ New Site List and VPN list</strong> and configure as following<ul>
<li>check <strong>From Service</strong> checkbox</li>
<li>select site list: <strong>RH</strong> and <strong>ALL-Remotes</strong></li>
<li>Select VPN list: <strong>VPN1</strong></li>
</ul>
</li>
<li>Click Add then <strong>Save Policy Changes</strong> to Activate</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task6_DP_5.png" width="800"/></p>
<h4 id="step63-verify-application-pining-policy">Step6.3: verify application pining policy</h4>
<ul>
<li>login vManage <strong>198.18.133.200</strong> and select <strong>Monitor - Network</strong></li>
<li>click <strong>RH-WE1</strong> to bring up device monitor page, and select <strong>Troubleshooting</strong> from the panel on the left</li>
<li>select <strong>Simulate Flows</strong> tool under <strong>Traffic</strong> and use the following value for simulated flow<ul>
<li>VPN: <strong>VPN-1</strong></li>
<li>Source/Interface for VPN-1: <strong>Gigabiethernet4 - ipv4 - 10.10.30.2</strong></li>
<li>Source IP: <strong>10.10.30.2</strong></li>
<li>Destination IP: <strong>10.100.101.1</strong> (this is remote site1's VPN1 interface IP)</li>
<li>Click on <strong>Advanced Options</strong>:</li>
<li>Protocol: 1 (ICMP)</li>
<li>All Paths: Checked</li>
</ul>
</li>
<li>Click <strong>Simulate</strong>
you should see traffic is taking private1</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task6_DP_6.png" width="800"/></p>
<ul>
<li>Change the Protocol to 6 (TCP) and simulate again</li>
</ul>
<p>You should not see any changes as private1 is only available circuit.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task6_DP_7.png" width="800"/></p>
<ul>
<li>Let's shutdown both private1 and private2 interface and verify again</li>
<li>Access template configuration from <strong>Configuration - Templates</strong></li>
<li>Locate deice template <strong>Lab-RH-V01</strong>, click <strong>...</strong> and select <strong>Change Device Values</strong></li>
<li>click <strong>...</strong> to select <strong>Edit Device Template</strong></li>
<li>select the <strong>Shutdown(vpn_if_interface)</strong> checkbox under <strong>GigabitEthernet1</strong></li>
<li>select the <strong>Shutdown(vpn_if_interface)</strong> checkbox under <strong>GigabitEthernet2</strong></li>
<li>click Update -&gt; next to trigger the configure change.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task6_DP_8.png" width="800"/></p>
<ul>
<li>click <strong>RH-WE1</strong> to bring up device monitor page, and select <strong>Troubleshooting</strong> from the panel on the left</li>
<li>select <strong>Simulate Flows</strong> tool under <strong>Traffic</strong> and use the following value for simulated flow<ul>
<li>VPN: <strong>VPN-1</strong></li>
<li>Source/Interface for VPN-1: <strong>Gigabiethernet4 - ipv4 - 10.10.30.2</strong></li>
<li>Source IP: <strong>10.10.30.2</strong></li>
<li>Destination IP: <strong>10.100.102.1</strong> (this is remote site2's VPN1 interface IP)</li>
<li>Click on <strong>Advanced Options</strong>:</li>
<li>Protocol: 1 (ICMP)</li>
<li>All Paths: Checked</li>
</ul>
</li>
<li>Click <strong>Simulate</strong>
you can see the traffic is blockholed.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task6_DP_9.png" width="800"/></p>
<ul>
<li>Let's restore private1 and private2 link by changing the device values of RH-WE1 device template, uncheck the shutdown box of GigabitEthernet1 and 2.Update-&gt;Next-&gt;Configure Devices</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task6_DP_10.png" width="800"/></p>
<p>Before we proceed to the next lab, let's do one more simulation test.</p>
<ul>
<li>login vManage <strong>198.18.133.200</strong> and select <strong>Monitor - Network</strong></li>
<li>click <strong>RH-WE1</strong> to bring up device monitor page, and select <strong>Troubleshooting</strong> from the panel on the left</li>
<li>select <strong>Simulate Flows</strong> tool under <strong>Traffic</strong> and use the following value for simulated flow<ul>
<li>VPN: <strong>VPN-1</strong></li>
<li>Source/Interface for VPN-1: <strong>Gigabiethernet4 - ipv4 - 10.10.30.2</strong></li>
<li>Source IP: <strong>10.10.30.2</strong></li>
<li>Destination IP: <strong>10.100.100.100</strong> (this is DC1-WE)</li>
<li>Click on <strong>Advanced Options</strong>:</li>
<li>Protocol: 6 (TCP)</li>
<li>Destination Port: 22</li>
<li>All Paths: Checked</li>
</ul>
</li>
<li>Click <strong>Simulate</strong></li>
</ul>
<p>you should see traffic is taking both private1 &amp; private2.</p>
<p><strong>Question: In the previous AAR lab says private1 should be preferred, and we have verified that behavior earlier. Why this is taking both private1 and private2 now?</strong></p>
<p>This is because our Data Policy says TCP traffic can use all the colors, when you have both AAR and Data Policy configured, Data Policy will take the final decision. You have to be careful with that when designing your AAR and DP. Avoid having both configured for the same application on same sites.</p>
<p><a href="JAVASCRIPT:scroll(0,0)" style="color:blue">Back to Top</a></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../lab2/" class="btn btn-neutral float-right" title="Lab 2 Tasks">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../intro/" class="btn btn-neutral" title="Getting Started"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../intro/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../lab2/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js"></script>
      <script src="../search/require.js"></script>
      <script src="../search/search.js"></script>

</body>
</html>
