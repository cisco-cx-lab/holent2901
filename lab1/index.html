<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Lab 1 Tasks - HOLENT-2901_Advanced_SD-WAN_Lab</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Lab 1 Tasks";
    var mkdocs_page_input_path = "lab1.md";
    var mkdocs_page_url = "/lab1/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> HOLENT-2901_Advanced_SD-WAN_Lab</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Lab Guide</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../access/">Lab Access</a>
                </li>
                <li class="">
                    
    <a class="" href="../intro/">Getting Started</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Lab 1 Tasks</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#lab-1-advanced-routing">Lab 1: Advanced Routing</a></li>
    

    <li class="toctree-l3"><a href="#task-1-local-route-policy">Task 1: Local Route Policy</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#step-11-verification-of-the-routes-received-on-dc-wes">Step 1.1 Verification of the routes received on DC WEs.</a></li>
        
            <li><a class="toctree-l4" href="#step-12-verify-the-bgp-communities">Step 1.2 Verify the BGP communities.</a></li>
        
            <li><a class="toctree-l4" href="#step-13-set-omp-tag-for-dc-specific-routes">Step 1.3 set OMP tag for DC specific Routes</a></li>
        
            <li><a class="toctree-l4" href="#step-14-creating-a-local-policy">Step 1.4 Creating a Local Policy</a></li>
        
            <li><a class="toctree-l4" href="#step-15-apply-the-route-policy">Step 1.5 apply the route-policy</a></li>
        
            <li><a class="toctree-l4" href="#step-16-verify-omp-tags">Step 1.6 Verify OMP Tags</a></li>
        
        </ul>
    

    <li class="toctree-l3"><a href="#task-2-hub-spoke-topologies">Task 2: Hub &amp; Spoke Topologies</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#step-21-pre-config-verifications">Step 2.1. Pre-config verifications</a></li>
        
            <li><a class="toctree-l4" href="#step-22-create-a-topology-for-centralized-policy">Step 2.2. Create a topology for centralized policy</a></li>
        
            <li><a class="toctree-l4" href="#step-23-apply-the-topology-policy-to-centralized-policy">Step 2.3. Apply the topology policy to Centralized Policy</a></li>
        
        </ul>
    

    <li class="toctree-l3"><a href="#33-lab-instructions-for-task-lab_task-3-default-route-handling">3.3 Lab instructions for task Lab_Task 3 (Default Route handling)</a></li>
    

    <li class="toctree-l3"><a href="#34-lab-instructions-for-task-lab_task-4-specific-routes-handling">3.4 Lab instructions for task Lab_Task 4 (Specific Routes handling)</a></li>
    

    <li class="toctree-l3"><a href="#35-lab-instructions-for-task-lab_task-5-application-aware-routing">3.5 Lab instructions for task Lab_Task 5 (Application Aware Routing)</a></li>
    

    <li class="toctree-l3"><a href="#35-lab-instructions-for-task-lab_task-6-application-pinning">3.5 Lab instructions for task Lab_Task 6 (Application Pinning)</a></li>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../lab2/">Lab 2 Tasks</a>
                </li>
                <li class="">
                    
    <a class="" href="../lab3/">Lab 3 Tasks</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../survey/">Survey</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">HOLENT-2901_Advanced_SD-WAN_Lab</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Lab Guide &raquo;</li>
        
      
    
    <li>Lab 1 Tasks</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h2 id="lab-1-advanced-routing">Lab 1: Advanced Routing</h2>
<hr />
<p>In this section, you will help ACME on advanced routing using local and central policy. You will perform the following tasks.</p>
<ul>
<li>
<p>ACME DC routers have already tagged all the routes originated from DC1 with BGP community of 65010:1000; all the routes originated from DC2 with BGP community of 65020:2000. <strong>Please configure a route-policy to ensure default route (0.0.0.0/0) coming from DC to set an OMP tag of 100.</strong> For DC1 routes, setting an OMP tag of <strong>1000</strong>; for DC2 routes, setting an OMP tag of <strong>2000</strong>. (Lab_Task 1)</p>
</li>
<li>
<p>ACME wants to have a <strong>hub &amp; spoke topology between Remotes and DCs as well between Remotes and Regional hubs</strong>. Hub &amp; spoke topology will scale more by reducing NO. of tunnels required on the devices. (Lab_Task 2)</p>
</li>
<li>
<p>ACME has categorized their branches into multiple Business Units(BUs). In the Data Center (DC) sites, the headend WAN Edges(WEs) are also categorized into multiple BUs for horizontal scaling purpose in terms of throughputs, therefore remote site only needs to build tunnels to its respective DC hub WEs. <strong>Remote Site1 only needs to build tunnels to DC1-WE1 and DC2-WE2</strong>; on the contrary, <strong>Remote Site 2 only needs to build tunnels to DC1-WE2 and DC2-WE2</strong>.(Lab_Task 2)</p>
</li>
<li>
<p>Remote sites receive default route from both RH and DC, <strong>DCs will be preferred and load shared</strong>. If RH goes down, DCs are load shared for default(Lab_Task 3)</p>
</li>
</ul>
<p><font color='red'>change to <strong>- Remote sites receive default route from both RH and DC, </strong>DCs will be preferred and load shared. RH's default will be used as backup for DCs. (Lab_Task 3)**</font></p>
<ul>
<li>
<p>Remotes sites receive more specific routes from both DCs, <strong>routes originated from local DC are preferred</strong>, if one DC goes down, it will use the routes from another DC as backup. In another words, from remote sites perspective, previously routes tagged with 1000 will prefer DC1; routes tagged with 2000 will prefer DC2.(Lab_Task 4)</p>
</li>
<li>
<p>For remote sites to any other regional routes are forced to go through DCâ€™s functional hub. For <strong>remote site1, it goes through WE1 in DC1 and DC2</strong>; for <strong>remote site 2, it goes through WE2 in DC1 and DC2</strong>.(Lab_Task 4)</p>
</li>
</ul>
<p><strong>Note: In these lab exercises, it's possible that there are multiple ways to achieve the requirements. The lab guide provides a detailed step by step instruction for each taks. However you're welcomed to solve it with your own solution. Just be mindful with the time.</strong></p>
<h2 id="task-1-local-route-policy">Task 1: Local Route Policy</h2>
<h4 id="step-11-verification-of-the-routes-received-on-dc-wes"><strong>Step 1.1</strong> Verification of the routes received on DC WEs.</h4>
<ul>
<li>SSH to <strong>DC1-WE1</strong> (repeat the same on DC1-WE2,DC2-WE1,DC2-WE2,R1-WE1 and R2-WE2 as well) and do <code>show ip route vrf 1</code> and make sure <strong>10.100.100.0/24, 10.200.200/24</strong> as well as <strong>0.0.0.0/0</strong> learned via BGP.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_iproute.png" width="600"/></p>
<h4 id="step-12-verify-the-bgp-communities"><strong>Step 1.2</strong> Verify the BGP communities.</h4>
<ul>
<li>10.100.100.0/24 should tag with 65010:1000; 10.200.200.0/24 should tag with 65020:2000. Execute <code>show ip bgp vpnv4 vrf 1 &lt;prefix&gt;</code> (10.100.100.0/24 and 10.200.200.0/24) on DC1-WE1,WE2 and DC2-WE1,WE2.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_bgpcommunity.png" width="600"/></p>
<h4 id="step-13-set-omp-tag-for-dc-specific-routes"><strong>Step 1.3</strong> set OMP tag for DC specific Routes</h4>
<ul>
<li>login vManage <strong>198.18.133.200</strong> and access policy configuration from <strong>Configuration - Policies</strong></li>
<li>Click <strong>Custom Options</strong> drop down on the top right and select <strong>Route Policy</strong> under <strong>Localized Policy</strong></li>
<li>Click <strong>Add Route Policy</strong> to Create new</li>
<li>Name: <strong>LAB_DCs_BGP_RP</strong>  (write down this name, it will be used later)</li>
<li>Description: <strong>LAB_DCs_BGP_RP</strong></li>
<li>Click <strong>+Sequence Type</strong> on the left then click <strong>+Sequence Rule</strong>, click Match, select <strong>Address</strong>, select <strong>default</strong>.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_new_lp_1.png" width="600"/></p>
<ul>
<li>Click <strong>Action</strong>, change to <strong>Accept</strong>, then select OMP tag, key in <strong>100</strong>, then save Match and Actions.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_new_lp_2.png" width="600"/></p>
<ul>
<li>
<p>click <strong>Sequence Rule</strong> to create following two rules:</p>
<ul>
<li>Match <strong>community-list DC1_Routes</strong>, <strong>Accept</strong> and Set <strong>Tag 1000</strong></li>
<li>Match <strong>community-list DC2_Routes</strong>, <strong>Accept</strong> and Set <strong>Tag 2000</strong>  </li>
<li>Then click on Save Route Policy</li>
</ul>
</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_new_lp_3.png" width="600"/></p>
<h4 id="step-14-creating-a-local-policy"><strong>Step 1.4</strong> Creating a Local Policy</h4>
<ul>
<li>login vManage <strong>198.18.133.200</strong> and access policy configuration from <strong>Configuration - Policies</strong></li>
<li>Click on <strong>Localized Policy</strong>, then click on <strong>Add Policy</strong></li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_new_lp_4.png" width="600"/></p>
<ul>
<li>Click on Next to proceed till you see <strong>Configure Route Policy</strong>; click <strong>Add Route Policy</strong> then select <strong>Import Existing Policy</strong>; Select <strong>LAB_DCs_BGP_RP</strong> click import</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_new_lp_5.png" width="600"/></p>
<ul>
<li>Click on Next, Key in</li>
<li>Policy Name: <strong>LAB_DCs_Local_policy</strong></li>
<li>Policy Description: <strong>LAB_DCs_Local_policy</strong> .</li>
<li>Check <strong>Netflow, Application</strong> and <strong>Implicit ACL Logging</strong>.</li>
<li>Then click on Save Policy (Feel free to click Preview before save)</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_new_lp_6.png" width="600"/></p>
<h4 id="step-15-apply-the-route-policy"><strong>Step 1.5</strong> apply the route-policy</h4>
<ul>
<li>Access feature template configuration from <strong>Configuration - Templates - Feature</strong></li>
<li>Locate feture template <strong>Lab_DC_VPN1_BGP_V01</strong> and select three dots then click <strong>Edit</strong>.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_bgp_ft_1.png" width="600"/></p>
<ul>
<li>Select <strong>Neighbor</strong> section, then click on the pencil icon under Action.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_bgp_ft_2.png" width="600"/></p>
<ul>
<li>
<p>Update the following:</p>
</li>
<li>
<p><strong>Address Family</strong> changes to Global and set to <strong>On</strong></p>
</li>
<li><strong>Address Family</strong> changes to Global and set to <strong>ipv4-unicast</strong></li>
<li><strong>Route Policy In</strong> changes to Global and set to <strong>On</strong></li>
<li><strong>Policy Name</strong> changes to Global and set to <strong>LAB_DCs_BGP_RP</strong>
(this was the name you wrote down earlier)</li>
<li>then click on Save changes and Click on Update</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_bgp_ft_3.png" width="600"/></p>
<ul>
<li>Then click Next, feel free to review the config changes, then click Configure Devices, then check the Confim configuration box and click on OK.</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_bgp_ft_4.png" width="600"/></p>
<h4 id="step-16-verify-omp-tags"><strong>Step 1.6</strong> Verify OMP Tags</h4>
<ul>
<li>SSH to DC wEdge routers(<strong>DC1-WE1,DC1-WE2,DC2-WE1,DC2-WE2</strong>) and run <strong><code>show ip bgp vpnv4 vrf 1 &lt;prefix&gt;</code></strong> (10.100.100.0/24,10.200.200.0/24), you should see proper OMP tags are set</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task1_bgp_ft_5.png" width="600"/></p>
<h2 id="task-2-hub-spoke-topologies">Task 2: Hub &amp; Spoke Topologies</h2>
<h4 id="step-21-pre-config-verifications"><strong>Step 2.1.</strong> Pre-config verifications</h4>
<ul>
<li>SSH to <strong>R1-WE1</strong> and do <code>show sdwan omp route vpn 1</code></li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_Routes_1.png" width="600"/></p>
<p><strong>Question: Do you know why the default route learned from private2 shown as invalid and unreachable (Inv,U)</strong>? </n></p>
<p>This is because R1-WE1 doesn't have a transport with private 2 color. If you watch the route on R2-WE1, you should notice the next hop from private 1 marked as <strong>(Inv,U)</strong> for the same reason where private 1 color doesn't exist on R2-WE1.</p>
<p><strong>Question: Did you notice the default route is learned from 1.1.30.2 which is the Regional Hub(RH)? Do you know why?</strong> </n></p>
<p>To answer this question, we will check the route table at vSmart as all the routes are advertised by vSmart. SSH to vSmart and do <code>show omp route vpn 1 0.0.0.0/0 detail | t</code></p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_Routes_2.png" width="600"/></p>
<p>OMP is very much like BGP when it comes down to route preference. In the order of preference, there is a origin-protocol, in this case the default route learned on RH is from Static (by design, in real deployment, probably it's going to be BGP as well); whereas the default learned from DCs is from iBGP. Origin protocol static is more preferred than iBGP.</p>
<p>Now, let's look at the specific routes learned from DC. Do <code>show sdwan omp route vpn 1 10.100.100.0/24</code> on vSmart.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_Routes_3.png" width="600"/></p>
<p><strong>Question: you will see 4 paths and one of the paths shows Inv,U. Hopefully you can answer why it's that. But why there are 4 paths?</strong></p>
<p>Let's SSH to vSmart and do <code>show omp route vpn 1 10.100.100.0/24 | t</code>.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_Routes_4.png" width="600"/></p>
<p>You will see 12 ECMP routes marked as <strong>C,R</strong> (Chosen,Resolved). Why 12? Because we have 4 DC wEdges each with 3 transports, so total 12 paths. </n></p>
<p>The next question will be why there are only 4 paths on the remote wEdges? This is because the ECMP settings on the wEdge by default is set to 4. If you change it to 16 (currently 16, it will be increased to 128 in the future release), you will see all 12 paths. </n></p>
<p><strong>Note: vSmart randomly selects 4 paths (or whatever the max ECMP value is set) and install on the device. In a  large deployment where multiple paths is more than 16 (before 128 paths is supported), this may pose problem.</strong></p>
<p>In this exercise we purposely keep the default ECMP setting and learn how to solve this issue with centralized policy.</p>
<h4 id="step-22-create-a-topology-for-centralized-policy"><strong>Step 2.2.</strong> Create a topology for centralized policy</h4>
<ul>
<li>
<p>login vManage <strong>198.18.133.200</strong> and access policy configuration from <strong>Configuration - Policies</strong></p>
</li>
<li>
<p>Click <strong>Custom Options</strong> drop down on the top right and select <strong>Topology</strong> under <strong>Centralized Policy</strong></p>
</li>
<li>
<p>Click <strong>Add Topology</strong> under <strong>Topology</strong> and select <strong>Custom Control(Route&amp;TLOC)</strong></p>
</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_topo_1.png" width="600"/></p>
<p>You are going to create two topologies, one for each remote site.</p>
<ul>
<li>Create topology policy for Remote1</li>
<li>Name: <strong>LAB_Topo_RS1</strong></li>
<li>Description: <strong>LAB topology for Remote Site 1</strong></li>
<li>Click <strong>+Sequence Type</strong> and select <strong>Route</strong></li>
<li>Click <strong>+Sequence Rule</strong>, leave unchanged under Match(means match all)</li>
<li>Click <strong>Actions</strong> and change to <strong>Accept</strong> (we'll come back and do the routes policy later).</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_topo_2.png" width="600"/></p>
<ul>
<li>click <strong>+Sequence Type</strong> then select <strong>TLOC</strong></li>
<li>
<p>click <strong>+Sequence Rule</strong>, select <strong>TLOC</strong>.</p>
<ul>
<li>Under <strong>Match Conditions</strong>, selects <strong>DCs-BU1-TLOCs</strong> for <strong>TLOC List</strong> (this TLOC list has been pre-defined for you which includes all the TLOCs of DC1-WE1 and DC2-WE1</li>
<li>Click <strong>Actions</strong>, change Actions to <strong>Accept</strong></li>
<li>Click <strong>+Sequence Rule</strong>, select <strong>TLOC</strong></li>
<li>under <strong>Match Conditions</strong>, selects <strong>RH</strong> for <strong>TLOC List</strong> (this TLOC list has been pre-defined for you which includes all the TLOCs of RH)</li>
<li>Click <strong>Actions</strong>, change Actions to <strong>Accept</strong></li>
</ul>
</li>
<li>
<p>Then click save Control Policy.</p>
</li>
</ul>
<p>This policy effectively allows R1-WE1 to build tunnels to all the DCs-BU1 devices (DC1-WE1 and DC2-WE1) as well as RH, nothing else as the default action is reject.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_topo_3.png" width="600"/></p>
<ul>
<li>Follow the above steps and create another topology for Remote2 with the following settings:</li>
<li>Name: <strong>LAB_Topo_RS2</strong></li>
<li>Description: <strong>LAB topology for Remote Site 2</strong></li>
<li>Click <strong>+Sequence Type</strong> then select <strong>Route</strong></li>
<li>Click <strong>+Sequence Rule</strong>, leave unchanged under Match(means match all),</li>
<li>Click <strong>Actions</strong> change Actions to <strong>Accept</strong> (we'll come back and do the routes policy later).</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_topo_4.png" width="600"/></p>
<ul>
<li>Click <strong>+Sequence Type</strong> then select <strong>TLOC</strong></li>
<li>click <strong>+Sequence Rule</strong>, select <strong>TLOC</strong>.<ul>
<li>Under <strong>Match Conditions</strong>, selects <strong>DCs-BU2-TLOCss</strong> for <strong>TLOC List</strong> (this TLOC list has been pre-defined for you which includes all the TLOCs of DC1-WE2 and DC2-WE2)</li>
<li>Click <strong>Actions</strong>, change Actions to <strong>Accept</strong></li>
<li>Click <strong>+Sequence Rule</strong>, select <strong>TLOC</strong></li>
<li>under <strong>Match Conditions</strong>, selects <strong>RH</strong> for <strong>TLOC List</strong> (this TLOC list has been pre-defined for you which includes all the TLOCs of RH)</li>
<li>Click <strong>Actions</strong>, change Actions to <strong>Accept</strong></li>
</ul>
</li>
<li>Then click save Control Policy.</li>
</ul>
<p>This policy effectively allows R2-WE1 to build tunnels to all the DCs-BU1 devices (DC1-WE2 and DC2-WE2) as well as RH, nothing else as the default action is reject.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_topo_5.png" width="600"/></p>
<h4 id="step-23-apply-the-topology-policy-to-centralized-policy"><strong>Step 2.3.</strong> Apply the topology policy to Centralized Policy</h4>
<ul>
<li>login vManage <strong>198.18.133.200</strong> and access policy configuration from <strong>Configuration - Policies</strong></li>
<li>Click <strong>Add Policy</strong> under <strong>Centralized Policy</strong></li>
<li>Click next, you will see Configure Topology and VPN membership - Click <strong>Add topology</strong>, select <strong>Import Existing Topology</strong></li>
<li>Click <strong>Custom Control(Route and TLOC)</strong>, select <strong>LAB_Topo_RS1</strong></li>
<li>Click on Add Topology</li>
<li>follow the above steps to add topology <strong>LAB_Topo_RS2</strong> as well</li>
</ul>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_topo_6.png" width="600"/></p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_topo_7.png" width="600"/></p>
<ul>
<li>Click Next and Next, you will see Apply Policies to Sites and VPNs,</li>
</ul>
<p>Policy Name: LAB_Central_v01
Description: Task2 Topo only
Click New Site List Under LAB_Topo_RS1, under Outbound Site List, select RS1,then click on Add
Click New Site List Under LAB_Topo_RS2, under Outbound Site List, select RS2,then click on Add
then click Save Policy</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_topo_8.png" width="600"/></p>
<p><strong>Step 4.</strong> Activate the first Centralized Policy</p>
<p>Go to Configuration Centralized Policy, click ...(three dots) of our LAB_Centeral_v01, then click on Activate, and Activate. Policy will be pushed to the vSmart.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_topo_9.png" width="600"/></p>
<p><strong>Step 5.</strong> Verify the hub &amp; spoke topology where R1-WE1 and R2-WE1 should not have tunnel between them but everyone else.</p>
<p>SSH to R1-WE1 &amp; R2-WE1 do show sdwan bfd sessions, you can see no bfd session between R1-WE1 and R2-WE1</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task2_topo_10.png" width="600"/>
<img src="https://leitian123.github.io/holent2901/img/lab_task2_topo_11.png" width="600"/></p>
<h2 id="33-lab-instructions-for-task-lab_task-3-default-route-handling">3.3 Lab instructions for task Lab_Task 3 (Default Route handling)</h2>
<p><strong>Step 1.</strong> Default Route Handling. The requirement is to prefer the default route learned from DC over RH. We need to modify our Centralized policy so that the default from DC has higher OMP perference over RH. First, let's make a new version of the topology policy, that way, when you update your policy in a production network you can also fall back to the previous version.</p>
<p>Go to Configurations-&gt;Policies-&gt;Centralized Policy, click three dots of LAB_Topo_RS1 and then click Copy.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_1.png" width="600"/></p>
<p>Name: LAB_Topo_RS1_V02</p>
<p>Description: +Default Route handling</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_2.png" width="600"/></p>
<p><strong>Step 2.</strong> Let's edit the new topology. click Edit under three dots of LAB_Topo_RS1_V02.We're going to add two new rules, rule1: match default &amp; originator of 1.1.10.1(DC1-WE1) then accept and set preference of 100; rule2: match default &amp; originator of 1.1.20.1(DC2-WE1) then accept and set preference of 100; and we need to make sure the sequence of these two new rules are ahead of previous accept all rule as the order on vSmart policy does matter, it will do the lookup based upon the order, if it finds the match, it will use that rule and it won't look for subsequent rule any more. Then click Save policy.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_3.png" width="600"/></p>
<p><strong>Step 3.</strong> Let's apply the policy and verify.</p>
<p>Go to Configuration-&gt;Policies-&gt;Centralized Policy, edit(three dots) the current policy(In production deployment, you always want to use the same practice of copying the current policy then apply it. Just demonstrate how to update the current policy works.)</p>
<p>Select Topology, edit LAB_Topo_RS1 then click Detach which will remove this topology.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_4.png" width="600"/></p>
<p>Add the new topology we're just created. Click Add Topology,select Import Existing Topology then select LAB_Topo_RS1_V02, then click Import.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_5.png" width="600"/></p>
<p>Click on Policy Application-&gt;New Site List-&gt;Outbound Site List, select RS1,then click on ADD, Save Policy Changes, then Activate.
Note: Outbound and Inbound are from vSmart perspective where outbound policy means how the routes are sent out from vSmart; inbound policy means how the routes are sent to the vSmart.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_6.png" width="600"/></p>
<p><strong>Step 4.</strong> Once the policy is activated, let's do some verifications.
SSH to R1-WE1 and do show sdwan omp route and see the learned TLOC for default  route as well as preference. We're expecting the routes are learned from DC1-WE1 and DC2-WE1 with preference of 100. Oh, no the routes are not changed at all, the three installed routes still learned from RH and no preference set either.Why is that?</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_7.png" width="600"/></p>
<p>Let's check omp route table on the vSmart, SSH to vSmart and do show omp route | t. As you recall, the OMP routes don't have any changes either where 3 paths learned from RH marked with C,R due to routes originated from Static which are preferred over originated from iBGP. But why the outbound policy setting the routes originated from DC1-WE1 and DC2-WE1 doesn't work, this is because outbound policy will only look for the chosen routes with C.R by default, other routes without learned from DCs as they are not chosen without C,R, so those routes are not even going through the outbound policies. There are multiple way of changing this behavior such as using inbound policy or configure send-backup path, or make every route with C.R. We're not going over all the solutions. Let's configure an vSmart inbound policy to make the default routes from DCs have higher OMP preference than RH's. Note: vSmart inbound policy may not be an ideal solution for the senarios. It is recommended to use outbound policy only if an outbound policy can meet the requirements without additional inbound policy for its simplicity and full visibility of vSmart.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_8.png" width="600"/></p>
<p><strong>Step 5.</strong> Let's configure an inbound policy by creating a new topology first, go to Configuration-&gt;Policies-&gt; Custom Options-&gt;Centralized Policy-&gt;Topology, then Add Topology-&gt;Custom Control with the following settings:</p>
<p>Name: default_route_from_DC
Description: default_route_from_DC
+Sequence Type: Route
+Sequence Rule
Match-&gt;Prefix List: default
Site List: DCs
Actions-&gt;Accept preference:50
Default Action: Accept</p>
<p>Then Save Control Policy</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_9.png" width="600"/></p>
<p>Apply this new topology to the current policy.</p>
<p>Go to Configuration-&gt;Policies-&gt;Centralized Policy, Edit(three Dots)the LAB_Central_v01, Click Add Topology,select Import Existing Topology then select default_route_from_DC, then click Import.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_10.png" width="600"/></p>
<p>Click on Policy Application-&gt;New Site List-&gt;Iutbound Site List, select DCs,then click on ADD, Save Policy Changes, then Activate.
Note:This time is an inbound policy wehre inbound policy controls how the vSmart are seeing the routes.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_11.png" width="600"/></p>
<p><strong>Step 6.</strong> SSH to vSmart and do show omp route vpn 1 | t, we can see the routes from DCs are C,R with preference 50 now which is expected.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_12.png" width="600"/></p>
<p>SSH to R1-WE1 and do show sdwan omp route vpn 1 , we can see 4 paths from DCs with preference 100. Remember the vSmart outbound policy we assign preference of 100 where the inbound policy we assign preference of 50 so that we can differentiate which policy is taking effect.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_13.png" width="600"/></p>
<p>Well done! You have finished the default route handling task for R1-WE1.Let's do the same policy for R2-WE1.</p>
<p><strong>Step 1.</strong> Go to Configurations-&gt;Policies-&gt;Centralized Policy, click three dots of LAB_Topo_RS1v02 and change Name and Description to LAB_Topo_RS2v02 then click Copy.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_14.png" width="600"/></p>
<p><strong>Step 2.</strong> Modify the topology for R2-WE2.
select TLOC as the Sequence Type, edit Rule1, we need to change the TLOC List from BU1 to BU2 as we'd like to use the BU2's functional hub which are DC1-WE2 and DC2-WE2 as the entry point for remote site 2(Remember remote site 2 represents the remote sites for BU2, where remote site 1 represents the remote sites for BU1). Remove the DCs-BU1-TLOCs by clicking the x, then select DCs-BU2-TLOCs instead, then click Save Match and Actions.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_TLOC_15.png" width="600"/></p>
<p>Select Route as the Sequence Type, we need to change the originator from 1.1.10.1 and 1.1.20.2 to 1.1.10.2 and 1.1.20.2 respectively . By doing this, default route from DC1-WE2 and DC2-WE2 will have OMP preference of 100 sent to R2-WE2 site.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_15.png" width="600"/></p>
<p><strong>Step 3.</strong> Apply this topology to the Centralized Policy.
Go to Configurations-&gt;Policies-&gt;Centralized Policy, Edit LAB_Central_v01.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_16.png" width="600"/></p>
<p>Go to Topology-&gt;Add Topology-&gt;Import Existing Topology-&gt;Custom Control, then select LAB_Topo_RS2_V02, Import.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_17.png" width="600"/></p>
<p>Remove the previous RS2 topology by selecting the topology of LAB_Topo_RS2, click detach.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_18.png" width="600"/></p>
<p>Click Policy Application-&gt;Select New Site List under LAB_Topo_RS2_V02, select RS2 as outbound site list, click Add, then save Policy Change, click Activate.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_19.png" width="600"/></p>
<p>Once the policy has been pushed to vSmart, let's verify by SSH to R2-WE1 and do show ip route vrf 1. Now, default route has two ECMP paths, one path for each DC.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_20.png" width="600"/>
Let's do show sdwan omp route vpn 1.You will see that there are 4 paths in the OMP route table, however none of them are valid</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task3_routes_21.png" width="600"/></p>
<h2 id="34-lab-instructions-for-task-lab_task-4-specific-routes-handling">3.4 Lab instructions for task Lab_Task 4 (Specific Routes handling)</h2>
<p><strong>Step 1.</strong> Now, we're going to control the more specific routes, the goal is to prefer the more specific routes originated from its DC on the remote sites. In the meanwhile, for BU1 (R1-WE1), it only needs to learn the routes from BU1's Headend devices (DC1-WE1, DC2-WE1); for BU2(R2-WE1), it only needs to learn the routes from BU2's Headend devices.
Remember the specific routes from DC1 already tagged with 1000, from DC2 already tagged with 2000. The idea is to create different policies for BU1 and BU2 sites such that give different OMP preference for different OMP tag.</p>
<p>Go to Configuration-&gt;Policies-&gt;Custom Options-&gt;Centralized Policy-&gt; Topology. Let's edit the current topologies (LAB_Topo_RS1_V02 and LAB_Topo_RS2_V02). click Edit under three dots of LAB_Topo_RS1_V02.Select Route as the sequence type,we're going to add four more rules, match OMP Tag 1000 and TLOC of DC1-BU1-TLOCs accept and set preference of 100 ; match OMP Tag 1000 and TLOC of DC2-BU1-TLOCs accept and set preference of 50;  match OMP Tag 2000 and TLOC of DC2-BU1-TLOCs accept and set preference of 100 ; match OMP Tag 2000 and TLOC of DC1-BU1-TLOCs accept and set preference of 50;and we need to make sure the sequence of these rules are ahead of previous accept all rule as the order on vSmart policy does matter, it will do the lookup based upon the order, if it finds the match, it will use that rule and it won't look for subsequent rule any more. Dragging the new rule up and drop the rule in front of the accept all rule (if you follow the lab previously, the new rules should be No. 5, 6,7 and 8, match all rule should be rule No. 9), Then click Save policy and Activate. This will make the vSmart to push the policy immediately after you confirm configuring devices (this is expected as illuted earlier, creating a new policy is a best practice otherwise upating the existing policy will cause the immediate policy push. )</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task4_routes_1.png" width="600"/></p>
<p>Let's verify. SSH to R1-WE1 and do show sdwan omp route vpn 1, you can see 4 paths for 10.100.100.0/24, however we see 3 paths with preference of 100, 1 path doesn't have preference; and for 10.200.200.0/24, there are 4 paths however 3 paths with preference of 50, 1 path doesn't have preference. If you look at it closely you will notice that the paths picked are from the lowest system-ip.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task4_routes_2.png" width="600"/></p>
<p>This is caused that vSmart by default will only send 4 paths to the wEdges. When vSmart is going through the outbound policy, it takes a route from vsmart route table in the winning order (marked as C,R) and compare it with the outbound policy as long as there is a match (permit) in the policy for a particular prefix, it will send it out and count it as one until it hits the send-path-limits which is 4 by default. Since in our route-policy, we have a permit all at the end which means every route will have a match, therefore first 4 routes in the winning order are sent out regardless which rule they're matching in the policy. There are multiple ways to fix this, the simple way is to change the limit to 16 on both vSmart as well as on the wEdges.</p>
<p><strong>Step 2.</strong> Configure send-path-limit 16 on vSmart</p>
<p>Go to Configuration-&gt;Templates-&gt;Device Template, edit vSmart template, under the OMP config section, add one new command 'send-path-limit 16', then click Update, then Configure Devices.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task4_routes_3.png" width="600"/></p>
<p><strong>Step 3.</strong> Change ecmp-limit to 16 on the wEdges.</p>
<p>Go to Configuration-&gt;Templates-&gt;Feature Template (tab, next to Device Tempalte), search for OMP, and edit Lab_OMP_V01, Under Basic Configuration section look for ECMP limit, change it to Global, and set to 16.Then update, Next, Configure Devices.check Confirm configuration changes on 7 Devices, then  OK.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task4_routes_4.png" width="600"/>
<strong>Step 4.</strong> Verification.
SSH to R1-WE1 and do show sdwan omp route vpn 1, you should see each route (10.100.100.0/24 and 10.200.200.0/24) will have 12 paths and 3 paths from prefered DC with preference of 100, 3 paths from secondary DC with preference of 50, another 6 paths from are invalid from other BU hub devices.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task4_routes_5.png" width="600"/></p>
<p>do show ip route vrf 1; you will see 10.100.100.0/0 is leared from 1.1.10.1; 10.200.200.0/24 is learned from 1.1.20.1 whis is desired.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task4_routes_6.png" width="600"/></p>
<p>Next, we need to do the same for LAB_Topo_RS2.
<strong>Step 5.</strong> Go to Configuration-&gt;Policies-&gt;Custom Options-&gt;Centralized Policy-&gt; Topology. Click Edit under three dots of LAB_Topo_RS1_V02.Select Route as the sequence type,we're going to add four more rules, match OMP Tag 1000 and TLOC of DC1-BU2-TLOCs accept and set preference of 100 ; match OMP Tag 1000 and TLOC of DC2-BU2-TLOCs accept and set preference of 50;  match OMP Tag 2000 and TLOC of DC2-BU2-TLOCs accept and set preference of 100 ; match OMP Tag 2000 and TLOC of DC1-BU2-TLOCs accept and set preference of 50;and we need to make sure the sequence of these rules are ahead of previous accept all rule as the order on vSmart policy does matter, it will do the lookup based upon the order, if it finds the match, it will use that rule and it won't look for subsequent rule any more. Dragging the new rule up and drop the rule in front of the accept all rule (if you follow the lab previously, the new rules should be No. 5, 6,7 and 8, match all rule should be rule No. 9), Then click Save policy and Activate. This will make the vSmart to push the policy immediately after you confirm configuring devices (this is expected as illuted earlier, creating a new policy is a best practice otherwise upating the existing policy will cause the immediate policy push. )</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task4_routes_7.png" width="600"/></p>
<p><strong>Step 6.</strong> Verification.
SSH to R2-WE1 and do show sdwan omp route vpn 1, you should see each route (10.100.100.0/24 and 10.200.200.0/24) will have 12 paths and 3 paths from prefered DC with preference of 100, 3 paths from secondary DC with preference of 50, another 6 paths from are invalid from other BU hub devices.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task4_routes_8.png" width="600"/></p>
<p>do show ip route vrf 1; you will see 10.100.100.0/0 is leared from 1.1.10.2; 10.200.200.0/24 is learned from 1.1.20.2 whis is desired.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task4_routes_9.png" width="600"/></p>
<p>This concludes the routing handling for the specific routes.</p>
<h2 id="35-lab-instructions-for-task-lab_task-5-application-aware-routing">3.5 Lab instructions for task Lab_Task 5 (Application Aware Routing)</h2>
<p>ACME wants to provide best user experience for their transactional data ( we will use SSH to simulate that) which has to meet the below SLA requirement. In the mean while, ACME would like to use private 1 as the preferred link, if private 1 doesn't meet the SLA requirement, it will use private 2 when private 2 still meets the SLA. LTE link will only be used when both private 1 and private 2 go down. ACME has the following SLA requirements for their applications.</p>
<table>
<thead>
<tr>
<th align="center">Application</th>
<th align="center">Loss(%)</th>
<th align="center">Lattency(msec)</th>
<th align="center">Jitter(msec)</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><strong>Transactional Data</strong></td>
<td align="center">5</td>
<td align="center">50</td>
<td align="center">100</td>
</tr>
<tr>
<td align="center"><strong>Bulk-Data</strong></td>
<td align="center">10</td>
<td align="center">300</td>
<td align="center">100</td>
</tr>
<tr>
<td align="center"><strong>Voice-and-Video</strong></td>
<td align="center">2</td>
<td align="center">45</td>
<td align="center">100</td>
</tr>
<tr>
<td align="center"><strong>Default</strong></td>
<td align="center">25</td>
<td align="center">300</td>
<td align="center">100</td>
</tr>
</tbody>
</table>
<p>Solutions: Application Aware Routing (AAR) is one of the differentiator between SDWAN and traditional WAN technology where you can route traffic based upon Application's SLA. You can classify an application based upon traditional 5 tuples or even applications (Deep Pakcket Inspection). There three action keyword for the seleted application. Prefer; backup and strict. The key to remember is AAR is all about SLA.</p>
<p>Prefer means when the preferred color/s meets the SLA, this/these colors will be prefered. If all the preferred colors don't meet the SLA, then depends on if you have backup or strict configure, these two options are mutual exclusive.</p>
<p>If backup color is configured which means when preferred color doesn't meet SLA, first it will use all other colors meeting the SLA regardless if that color is configured as backup or not as long as the color meets the SLA, if there are multiple such colors, it will do load sharing among them. If none of the colors meeting the SLAs, it will use the configured backup color.</p>
<p>If strict is configured (note: stric and backup are mutual exclusive ), the matching traffic will be dropped when the preferred color is not configured.</p>
<p>Based upon the requirements, we will do the following, first confgure LTE as last resort which means it won't come up until all other circuits are not available. Then we configure private1 as preferred color, we simply don't need to mention private2 as if private2 meets the SLA, it will be used anyway. If private2 doesn't meet SLA, as neither strict nor backup is configured, it will simply use any available tunnels.</p>
<p><strong>Step 1.</strong> Configure RH LTE interface as last resort circuit as the LTE will only be used when all other circuits becomes unavailable.</p>
<p>Go to Configuration-&gt;Templates-&gt;Feature, search LTE, and select Lab_RH_VPN0_LTE_V01, then click Edit (three dots)</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_LTE_1.png" width="600"/></p>
<p>Under 'Tunnel' section, expand 'Advanced Options', change 'Last-Resort Circuit' settings to Device Specific and click update.Then click three dots, Edit Device Template, check Last-Resort Circuit and Update, Next and Configure Devices. This setting will make LTE last-resort which means the interface will go down, and no traffic go across it until all other circuits become unavailable.
<img src="https://leitian123.github.io/holent2901/img/lab_task5_LTE_2.png" width="600"/></p>
<p><strong>Step 2.</strong> Last-Resort verification.</p>
<p>SSH to RH and do show ip int brief, you will notice Gig3 is down and Tunnel3 is down as well.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_LTE_3.png" width="600"/></p>
<p>Do show sdwan control connections, there is no control connections on LTE.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_LTE_4.png" width="600"/></p>
<p>Do show sdwan bfd sessions, there is no IPSec tunnel over LTE either.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_LTE_5.png" width="600"/></p>
<p><strong>Step 3.</strong> Configure SLA classes for app aware routing (AAR)</p>
<p>Go to Configurations-&gt;Policies-&gt;Custome Options-&gt;Centralized Policiy-&gt;Lists</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_1.png" width="600"/></p>
<p>select SLA Class and make sure above classes are defined properly.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_2.png" width="600"/></p>
<p>Go to Centralized Policies-&gt;Custom Options-&gt;Traffic Policy, then select Application Aware Routing, click Add Policy then Creat New</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_3.png" width="600"/></p>
<p>Name: LAB_AAR_V01
Description: LAB_AAR_V01
+Sequence Type-&gt;+ Sequence Rule
Match-&gt; Destination: 22
Actions-&gt; SLA Class List: Transctional-Data;
          Preferred Color: private1
          Counter: transactional-data
Click Save Match and Actions</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_4.png" width="600"/></p>
<p>Click 'Save Application Aware Routing Policy'
<img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_5.png" width="600"/></p>
<p><strong>Step 4.</strong> Apply the AAR</p>
<p>Go to Centralized Policy, Copy the current policy of 'LAB_Central_v01' and change the name and description to 'LAB_Central_v02', then click Copy</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_6.png" width="600"/></p>
<p>Edit the new policy 'LAB_Central_v02', under Traffic Rules-&gt;Application Aware Routing, click Add Policy then Import Existing, select LAB_AAR_V01,then Import.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_7.png" width="600"/></p>
<p>Click Policy Application-&gt;Application Aware Routing
+New Site List and VPN List:
New Site List: DCs and RH
VPN List: VPN1</p>
<p>Then click on Add then Save Policy Changes
<img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_8.png" width="600"/></p>
<p>Activate the v02 policy by clicking the three dots, then activate.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_9.png" width="600"/></p>
<p><strong>Step 5.</strong> Lab Verification</p>
<p>Go to Monitor, then select RH-WE1, then select Troubleshooting-&gt;Simulate Flows
VPN:VPN-1
Source/Interface for VPN-1:Gigabiethernet4
Source IP: 10.10.30.2
Destination IP: 10.100.100.100
Click on Advanced Options:
Protocol: 6 (TCP)
Destination Port: 22
All Paths: Checked
Click Simulate</p>
<p>You should see the traffic is only taking the private1 path which means it's using private1 as the preferred transport.
<img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_10.png" width="600"/></p>
<p>Do another simultation, this time change the destination port to 23, everything else remain the same.</p>
<p>You should see the traffic will use both private1 and private2 which means it will use all available circuits for all other traffic.
<img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_11.png" width="600"/></p>
<p>Now let's shutdown the private1 interface of the RH-WE1, go to Configurations-&gt;Templates-&gt;Device Template, edit the template of Lab-RH-V01  , then select 'Change Device Values', click the three dots to 'Edit Device Template',check the 'Shutdown(vpn_if_interface)', make sure select the check box under the GigabitEthernet1 section, do not shutdown other interface.Then click Update-&gt;Next-&gt;Configure Devices.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_12.png" width="600"/></p>
<p>Now let's verify it again.</p>
<p>Go to Monitor, then select RH-WE1, then select Troubleshooting-&gt;Simulate Flows
VPN:VPN-1
Source/Interface for VPN-1:Gigabiethernet4
Source IP: 10.10.30.2
Destination IP: 10.100.100.100
Click on Advanced Options:
Protocol: 6 (TCP)
Destination Port: 22
All Paths: Checked
Click Simulate</p>
<p>You should see the traffic is only taking the private2 path now as private2 is the only one available.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_13.png" width="600"/></p>
<p>Let's shutdown private2 interface on RH-WE1.go to Configurations-&gt;Templates-&gt;Device Template, edit the template of Lab-RH-V01  , then select 'Change Device Values', click the three dots to 'Edit Device Template',check the 'Shutdown(vpn_if_interface)', make sure select the check box under the GigabitEthernet2 section, do not shutdown other interface.Then click Update-&gt;Next-&gt;Configure Devices.</p>
<p>Now let's verify it again.</p>
<p>Go to Monitor, then select RH-WE1, then select Troubleshooting-&gt;Simulate Flows
VPN:VPN-1
Source/Interface for VPN-1:Gigabiethernet4
Source IP: 10.10.30.2
Destination IP: 10.100.100.100
Click on Advanced Options:
Protocol: 6 (TCP)
Destination Port: 22
All Paths: Checked
Click Simulate</p>
<p>You should see the traffic is taking LTE interface only.
<img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_14.png" width="600"/></p>
<p>Great! You're completed task 5. Before proceed further,let's no shutdown the private1 and private2 interfaces by changing the device vlaue of RH-WE1's device template.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task5_AAR_15.png" width="600"/></p>
<h2 id="35-lab-instructions-for-task-lab_task-6-application-pinning">3.5 Lab instructions for task Lab_Task 6 (Application Pinning)</h2>
<p>ACME wants to only run its business critical applications over LTE when all other links go down due to limited available bandwidth on the LTE link. Non-business critical application (such as ICMP) will need to be dropped when LTE comes up.</p>
<p>SDWAN Data Policy is a means to pin certain applications on the certain links.</p>
<p><strong>Step 1.</strong> Configure Data Policy.
Go to Configurations-&gt;Policies-&gt;Centralized Policy-&gt;Custom Options-&gt;Traffic Policy-&gt;Add Policy</p>
<p>Name: LAB1_DP_V01
Description: LAB1_DP_V01
+Sequence Type: Custom
+Sequence Rule
Match Conditions:
    protocol: 6 (TCP)
Actions: Accept
    Local TLOC (color): private1, private2, LTE
    save Match and Actions</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task6_DP_1.png" width="600"/>  </p>
<p>+Sequence Rule
Match Conditions:
    protocol: 1 (ICMP)
Actions: Accept
    Local TLOC (color): private1, private2
    check Restrict (this means traffic will be dropped when configured TLOC unreable)
    save Match and Actions</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task6_DP_2.png" width="600"/></p>
<p>Change Default Action to Accept.
Click Default Action, then click Pencil to edit, click Actions then Accept.
Save Match and Actions, then click Save Data Policy</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task6_DP_3.png" width="600"/></p>
<p><strong>Step 2.</strong> Apply Data Policy.</p>
<p>Go to Configuration-&gt;Policies-&gt;Centralized Policy, select LAB_Central_V02 and Edit.</p>
<p>Click Traffic Rules-&gt;Traffic Data, Click Add Policy-&gt;Import Existing,select LAB1_DP_V01, then Import</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task6_DP_4.png" width="600"/></p>
<p>Click Policy Application-&gt;Traffic Data
+ New Site List and VPN list
From Service
    select site list: RH and ALL-Remotes
    Select VPN list: VPN1
Click Add then Save Policy Changes, click Activate</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task6_DP_5.png" width="600"/></p>
<p><strong>Step 3.</strong> Lab Verification.</p>
<p>Go to Monitor, then select RH-WE1, then select Troubleshooting-&gt;Simulate Flows
VPN:VPN-1
Source/Interface for VPN-1:Gigabiethernet4
Source IP: 10.10.30.2
Destination IP: 10.10.101.1 (this is remote site1's VPN1 interface IP)
Click on Advanced Options:
Protocol: 1 (ICMP)
All Paths: Checked
Click Simulate
you should see traffic is taking private1</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task6_DP_6.png" width="600"/></p>
<p>Change the Protocol to 6 (TCP) and simulate again</p>
<p>You should not see any changes as private1 is only available circuit.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task6_DP_7.png" width="600"/></p>
<p>Shutdown private1 and private2 interface on RH-WE1. Go to Configuration-&gt;Device Template, Select Lab_RH_V01, edit-&gt;change Device Values.</p>
<p>Interface GigabitEthernet 1-&gt;Shutdown
Interface GigabitEthernet 2-&gt;Shutdown
Update-&gt;Next-&gt;Configure Devices</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task6_DP_8.png" width="600"/></p>
<p>send simulate flows again with ICMP to 10.10.102.1 (remote site 2),
you can see the traffic is blockholed.</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task6_DP_9.png" width="600"/></p>
<p>Let's restore private1 and private2 link by changing the device values of RH-WE1 device template, uncheck the shutdown box of GigabitEthernet1 and 2.Update-&gt;Next-&gt;Configure Devices</p>
<p><img src="https://leitian123.github.io/holent2901/img/lab_task6_DP_10.png" width="600"/></p>
<p>Before we proceed to the next lab, let's do one more simulation test.</p>
<p>Go to Monitor, then select RH-WE1, then select Troubleshooting-&gt;Simulate Flows
VPN:VPN-1
Source/Interface for VPN-1:Gigabiethernet4
Source IP: 10.10.30.2
Destination IP: 10.100.100.100 (this is DC1-WE)
Click on Advanced Options:
Protocol: 6 (TCP)
Destination Port: 22
All Paths: Checked
Click Simulate
you should see traffic is taking both private1 &amp; private2.</p>
<p>Wait a second, our AAR poicy in the previous lab says private1 should be preferred, and we have verified that behavior earlier, why this is taking both private1 and private2 now? This is because our DP says TCP traffic can use all the colors, when you have both AAR and DP configured, DP will take the final decision. You have to be careful with that when designing your AAR and DP and not to have them configured for the same applicaiton on the same sites.</p>
<p><a href="JAVASCRIPT:scroll(0,0)" style="color:blue">Back to Top</a></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../lab2/" class="btn btn-neutral float-right" title="Lab 2 Tasks">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../intro/" class="btn btn-neutral" title="Getting Started"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../intro/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../lab2/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js"></script>
      <script src="../search/require.js"></script>
      <script src="../search/search.js"></script>

</body>
</html>
