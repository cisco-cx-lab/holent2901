{
    "docs": [
        {
            "location": "/",
            "text": "HOLENT-2901\n\n\nWelcome to Cisco Live HOLENT-2901: Advanced SD-WAN Lab\n\n\nPreface\n\n\nThis document describes the Cisco SD-WAN Advanced Lab.\n\n\nAudience\n\n\nThis document is intended for use by attendees of the Cisco Live 2021 who are taking the SD-WAN Advanced Lab (HOLENT-2901).\n\n\nSpeakers\n\n\n\n\nEric Wang \nCustomer Delivery Architect\n\n\nLei Tian \nCustomer Delivery Architect",
            "title": "Home"
        },
        {
            "location": "/#holent-2901",
            "text": "Welcome to Cisco Live HOLENT-2901: Advanced SD-WAN Lab",
            "title": "HOLENT-2901"
        },
        {
            "location": "/#preface",
            "text": "This document describes the Cisco SD-WAN Advanced Lab.",
            "title": "Preface"
        },
        {
            "location": "/#audience",
            "text": "This document is intended for use by attendees of the Cisco Live 2021 who are taking the SD-WAN Advanced Lab (HOLENT-2901).",
            "title": "Audience"
        },
        {
            "location": "/#speakers",
            "text": "Eric Wang  Customer Delivery Architect  Lei Tian  Customer Delivery Architect",
            "title": "Speakers"
        },
        {
            "location": "/access/",
            "text": "About this lab\n\n\nIn this lab, you will be introduced with advanced SD-WAN topics including advanced routing, central control policy, QoS, per-tunnel QoS, Direct Internet Access, Cloud OnRamp for SaaS, Dynamic tunneling. The lab will be built with Network Function Virtualization for Viptela and IOS XE SD-WAN image.\n\n\nLab Flow\n\n\nIn this lab, you will follow the lab guide to configure:\n\n\n\n\nAdvanced Routing\n\n\nMigration\n\n\nPerformance & Optimization\n\n\n\n\nLab Access\n\n\nBelow table provides the IP addresses and credentials for the devices used in this lab:\n\n\n\n\n\n\n\n\nDevice\n\n\nIP\n\n\nUsername\n\n\nPassword\n\n\n\n\n\n\n\n\n\n\nvManage\n\n\n198.18.133.200:19001\n\n\nadmin\n\n\nadmin\n\n\n\n\n\n\nvbond\n\n\n198.18.133.200:19002\n\n\nadmin\n\n\nadmin\n\n\n\n\n\n\nvSmart\n\n\n198.18.133.200:19003\n\n\nadmin\n\n\nadmin\n\n\n\n\n\n\nDC1-WE1\n\n\n198.18.133.200:19010\n\n\nadmin\n\n\nadmin\n\n\n\n\n\n\nDC1-WE2\n\n\n198.18.133.200:19009\n\n\nadmin\n\n\nadmin\n\n\n\n\n\n\nDC2-WE1\n\n\n198.18.133.200:19014\n\n\nadmin\n\n\nadmin\n\n\n\n\n\n\nDC2-WE2\n\n\n198.18.133.200:19012\n\n\nadmin\n\n\nadmin\n\n\n\n\n\n\nRH-WE1\n\n\n198.18.133.200:19016\n\n\nadmin\n\n\nadmin\n\n\n\n\n\n\nR1-WE1\n\n\n198.18.133.200:19017\n\n\nadmin\n\n\nadmin\n\n\n\n\n\n\nR2-WE1\n\n\n198.18.133.200:19020\n\n\nadmin\n\n\nadmin\n\n\n\n\n\n\nR1-VM1\n\n\n198.18.133.200:19018\n\n\nviptela\n\n\nviptela\n\n\n\n\n\n\nR2-VM1\n\n\n198.18.133.200:19019\n\n\nviptela\n\n\nviptela\n\n\n\n\n\n\n\n\nYou can also login the remote host via VNC.\n\n\n\n\n\n\n\n\nDevice\n\n\nIP\n\n\nUsername\n\n\nPassword\n\n\n\n\n\n\n\n\n\n\nR1-VM1\n\n\n198.18.133.200:30500\n\n\nviptela\n\n\nviptela\n\n\n\n\n\n\nR1-VM1\n\n\n198.18.133.200:30501\n\n\nviptela\n\n\nviptela\n\n\n\n\n\n\n\n\nLab Topology",
            "title": "Lab Access"
        },
        {
            "location": "/access/#about-this-lab",
            "text": "In this lab, you will be introduced with advanced SD-WAN topics including advanced routing, central control policy, QoS, per-tunnel QoS, Direct Internet Access, Cloud OnRamp for SaaS, Dynamic tunneling. The lab will be built with Network Function Virtualization for Viptela and IOS XE SD-WAN image.",
            "title": "About this lab"
        },
        {
            "location": "/access/#lab-flow",
            "text": "In this lab, you will follow the lab guide to configure:   Advanced Routing  Migration  Performance & Optimization",
            "title": "Lab Flow"
        },
        {
            "location": "/access/#lab-access",
            "text": "Below table provides the IP addresses and credentials for the devices used in this lab:     Device  IP  Username  Password      vManage  198.18.133.200:19001  admin  admin    vbond  198.18.133.200:19002  admin  admin    vSmart  198.18.133.200:19003  admin  admin    DC1-WE1  198.18.133.200:19010  admin  admin    DC1-WE2  198.18.133.200:19009  admin  admin    DC2-WE1  198.18.133.200:19014  admin  admin    DC2-WE2  198.18.133.200:19012  admin  admin    RH-WE1  198.18.133.200:19016  admin  admin    R1-WE1  198.18.133.200:19017  admin  admin    R2-WE1  198.18.133.200:19020  admin  admin    R1-VM1  198.18.133.200:19018  viptela  viptela    R2-VM1  198.18.133.200:19019  viptela  viptela     You can also login the remote host via VNC.     Device  IP  Username  Password      R1-VM1  198.18.133.200:30500  viptela  viptela    R1-VM1  198.18.133.200:30501  viptela  viptela",
            "title": "Lab Access"
        },
        {
            "location": "/access/#lab-topology",
            "text": "",
            "title": "Lab Topology"
        },
        {
            "location": "/intro/",
            "text": "Lab Introduction\n\n\n\n\nCompany ACME is a multi-international company where it has branches world wide which include two Data Centers in San Jose and RTP and few regional hubs in different continents as well as remote branches world wide.\n\n\nLab Design\n\n\nThis lab is designed to help you understand various advanced routing features based upon a large multi-international company design. The lab is based on dcloud and simulating ACME's topolgy with 5 Wan Edges(wEdges). All the basic connectivities as well as feature templates/devices templates have been pre-configured for you. You should be able to go straight to those LAB tasks.\n\n\n\n\nAs shown in the above diagram:\n\n\n\n\nDC1 has two cEdges which connects to three transports\n\n\nDC2 has also two cEdges which connect to three transports as well\n\n\nRH(reginal hub) has one cEdge\n\n\nBoth DC1-WEs and DC2-WEs are running eBGP with DC routers, BGP has been       preconfigured for you.\n\n\nRemote1 has one cEdge connecting to private1 and LTE\n\n\nRemote2 has one cEdge connecting to private2 and LTE\n\n\n\n\nLab Access\n\n\nPlease find your anyconnect login from your proctor.\n\n- Connect to anyconnect VPN dcloud-lon-anyconnect.cisco.com with the username and password provided.\n\n\n- After prompted for credentials, use the credentials provided by the lab admin.  \n\n\n\n- Hit accept when the prompt appears to accept the VPN connection login",
            "title": "Lab Introduction"
        },
        {
            "location": "/intro/#lab-introduction",
            "text": "Company ACME is a multi-international company where it has branches world wide which include two Data Centers in San Jose and RTP and few regional hubs in different continents as well as remote branches world wide.",
            "title": "Lab Introduction"
        },
        {
            "location": "/intro/#lab-design",
            "text": "This lab is designed to help you understand various advanced routing features based upon a large multi-international company design. The lab is based on dcloud and simulating ACME's topolgy with 5 Wan Edges(wEdges). All the basic connectivities as well as feature templates/devices templates have been pre-configured for you. You should be able to go straight to those LAB tasks.   As shown in the above diagram:   DC1 has two cEdges which connects to three transports  DC2 has also two cEdges which connect to three transports as well  RH(reginal hub) has one cEdge  Both DC1-WEs and DC2-WEs are running eBGP with DC routers, BGP has been       preconfigured for you.  Remote1 has one cEdge connecting to private1 and LTE  Remote2 has one cEdge connecting to private2 and LTE",
            "title": "Lab Design"
        },
        {
            "location": "/intro/#lab-access",
            "text": "Please find your anyconnect login from your proctor. \n- Connect to anyconnect VPN dcloud-lon-anyconnect.cisco.com with the username and password provided. \n- After prompted for credentials, use the credentials provided by the lab admin.    \n- Hit accept when the prompt appears to accept the VPN connection login",
            "title": "Lab Access"
        },
        {
            "location": "/lab1/",
            "text": "Lab 1: Advanced Routing\n\n\nACME DC routers have already tagged all the routes originated from DC1 with BGP community of 65010:1000; all the routes originated from DC2 with BGP community of 65020:2000. Please configure a route-policy to ensure default route (0.0.0.0/0) coming from DC to set an OMP tag of 100. For DC1 routes, setting an OMP tag of 1000; for DC2 routes, setting an OMP tag of 2000. (Lab_Task 1)\n\n\n\n\nACME wants to have a hub & spoke topology between Remotes and DCs as well between Remotes and Regional hubs. Hub & spoke topology will scale more by reducing NO. of tunnels required on the devices.\n\n\n\n\nACME has categorized their branches into mutliple Business Units(BUs). In the Data Center (DC) sites, the headend WAN Edges(WEs) are also categorized into mutiple BUs for horizontal scaling purpose in terms of throughputs, therefore RS only needs to build tunnels to its respective DC hub WEs.Remote Site1 only needs to build tunnels to DC1-WE1 and DC2-WE2; on the contrary, Remote Site 2 only needs to build tunnels  to DC1-WE2 and DC2-WE2.(Lab_Task 2)\n\n\n\n\n\n\nRemote sites receive default route from both RH and DC, DCs will be preferred and load shared. If RH goes down, DCs are load shared for default(Lab_Task 2)\n\n\n\n\n\n\nRemotes sites receive more specific routes from both DCs, routes originated from local DC are preferred, if one DC goes down, it will use the routes from another DC as backup. In another words, from remote sites perspective, previously routes tagged with 1000 will prefer DC1; routes tagged with 2000 will prefer DC2.(Lab_Task 2)\n\n\n\n\n\n\nFor remote sites to any other regional routes are forced to go through DC\u2019s functional hub. For remote site1, it goes through WE1 in DC1 and 2; for remote site 2, it goes through WE2 in DC1 and 2.(Lab_Task 2)\n\n\n\n\n\n\nNote: In these lab exercises, it's possible that there are multiple ways to achieve the requirements. The lab guide provides a detailed step by step instruction for each task. However you're welcomed to solve it with your own solution. Just be mindful with the time.\n\n\ntask1: Lab instructions for task Lab_Task 1\n\n\nStep 1.\n Verification of the routes received on DC WEs.\nSSH to DC1-WE1 (repeat the same on DC1-WE2,DC2-WE1,DC2-WE2,R1-WE1 and R2-WE2 as well) and do show ip route vrf 1 and make sure 10.100.100.0/24 and 10.200.200/24 as well as 0.0.0.0/0 learned via BGP.\n\n\n\n\nStep 2.\n Verify the BGP communities. 10.100.100.0/24 should tag with 65010:1000; 10.200.200.0/24 should tag with 65020:2000. Execute show ip bgp vpnv4 vrf 1 \n (10.100.100.0/24 and 10.200.200.0/24) on DC1-WE1,WE2 and DC2-WE1,WE2.\n\n\n\n\nStep 3.\n Configuring Local Route-Policy to set OMP tag for DC specific Routes. Go to Configuration->Policies->Custom Options(upper righ)->Route Policy->Add Route Policy->Create New, then do the following:\n\n\nName: LAB_DCs_BGP_RP (write down this name, it will be used later)\nDescription: LAB_DCs_BGP_RP\nClick +Sequence Type then click +Sequence Rule, click Math, select Address, select default.\n\n\n\n\nClick Action, change to Accept, then select OMP tag, key in 100, then save Match and Actions.\n\n\n\n\nCreate two other rules:\n\n\nMatch community-list DC1_Routes, Accept and Set Tag 1000;\nMatch community-list DC2_Routes, Accept and Set Tag 2000;\nThen click on Save Route Policy\n\n\n\n\nStep 4.\n Creating a Local Policy\n\n\nClick on Localized Policy, then click on Add Policy\n\n\n\n\nClick on Next,Next and Next, till you see Configure Route Policy, then click Add Route Policy, then select Import Existing Policy, Select LAB_DCs_BGP_RP click import\n\n\n\nClick on Next, Key in Policy Name: LAB_DCs_Local_policy; Policy Description: LAB_DCs_Local_policy. Check Netflow, Application and Implict ACL Logging. Then click on Save Policy (Feel free to click Preview before save)\n\n\n\n\nStep 5.\n Configuring BGP template to apply the route-policy\nGo to Configuration->Template then search for BGP in the serch bar; select Lab_DC_VPN1_BGP_V01 and select three dots then click Edit.\n\n\n\n\nSelect Neighbor section, then click on the pencil icon under Action.\n\n\n\n\nUpdate the following:\nAddress Family changes to Global and set to On\nAddress Family changes to Global and set to ipv4-unicast\nRoute Policy In changes to Global and set to On\nPolicy Name changes to Global and set to LAB_DCs_BGP_RP (this was the name you wrote down earlier)\nthen click on Save changes and Click on Update\n\n\n\n\nThen click Next, feel free to review the config changes, then click Configure Devices, then check the Confim configuration box and click on OK.\n\n\n\n\nStep 6.\n Verify that the OMP Tags have been properly set.\n\n\nSSH to DC wEdge routers(DC1-WE1,DC1-WE2,DC2-WE1,DC2-We2) and run show ip bgp vpnv4 vrf 1 \n (10.100.100.0/24,10.200.200.0/24), you should see proper OMP tags are set\n\n\n\n\n3.2 Lab instructions for task Lab_Task 2\n\n\nStep 1.\n Let's do some verification before we do any configurations.\nSSH to R1-WE1 and do show sdwan omp route vpn 1\n\n\n\n\nDo you know why the default route learned from private2 shown as invalid and unreachable (Inv,U)? This is because R1-WE1 doesn't have a transport with private 2 color. If you watch the route on R2-WE1, you should notice the next hop from private 1 marked as Inv,U for the same reason where private 1 color doesn't exist on R2-WE1.\n\n\nDid you notice the default route is learned from 1.1.30.2 which is the Regional Hub(RH)? Do you know why? In order to answer this question, we have to look at the vSmart table as all the routes are told by vSmart.SSH to vSmart and do show omp route vpn 1 0.0.0.0/0 detail | t\n\n\n\n\nOMP is very much like BGP when it comes down to route preference. In the order of preference, there is a origin-protocol, in this case the default route learned on RH is from Static (by design, in real deployment, probably it's going to be BGP as well); whereas the default learned from DCs is from iBGP. Origin protocol static is more preferred than iBGP.\n\n\nNow, let's look at the specific routes learned from DC. Do show sdwan omp route vpn 1 10.100.100.0/24.\n\n\n\n\nYou will see 4 paths and one of the paths shows Inv,U. Hopefully you can answer why it's that. But why there are 4 paths?\n\n\nAgain, let's go to vSmart and see. SSH to vSmart and do show omp route vpn 1 10.100.100.0/24 | t.\n\n\n\n\nYou will see 12 ECMP routes marked as C,R (Chosen,Resolved). Why 12? Because we have 4 DC wEdges each with 3 transport, so total 12 paths. The next question will be why there are only 4 paths on the remote wEdges? This is because the ECMP settings on the wEdge by default is set to 4. If you change it to 16 (currently 16, it will be increased to 128 in the future release), you will see all 12 paths. Note: vSmart is going to randomly select 4 paths (or whatever the max ECMP value is set) installed on the device, in a very large deployment where multiple paths is more than 16 before 128 paths is supported, this may pose problem. This excercise we purposely don't change the ECMP setting and learn how to solve this issue with centralized policy.\n\n\nStep 2.\n Creating a topology for centralized policy.We're going to tackle the above requirements step by step.\n\n\nOn the side bar select the Gear(Configuration) Icon then click Policies, then select Custom Options then select on Topology, then click on Add Topology.\n\n\n\n\nWe're going to create two topologies, one for Remote Site 1 another for Remote site 2.\n\n\nCreating first topology:\nName: LAB_Topo_RS1\nDescription: LAB topology for Remote Site 1\n+Sequence Type then select Route\n+Sequence Rule, leave unchanged under Match(means match all), change Actions to default (we'll come back and do the routes policy later).\n\n\n\n\nAdd new TLOC Rules:\n+Sequence Type then select TLOC\n+Sequence Rule, select TLOC List under Match, first TLOC list selects DCs-BU1-TLOCs (this TLOC list has been pre-defined for you which includes all the TLOCs of DC1-WE1 and DC2-WE1); change Actions to accept\n\n\n+Sequence Rule, select TLOC List under Match, second TLOC list selects RH (this TLOC list has been pre-defined for you which includes all the TLOCs of RH); change Actions to accept\n\n\nThen click save Control Policy. This policy effectively allows R1-WE1 to build tunnels to all the DCs-BU1 devices (DC1-WE1 and DC2-WE1) as well as RH, nothing else as the default action is reject.\n\n\n\n\nFollow the above step and create another topology with the following settings:\nName: LAB_Topo_RS2\nDescription: LAB topology for Remote Site 2\n+Sequence Type then select Route\n+Sequence Rule, leave unchanged under Match(means match all), change Actions to default (we'll come back and do the routes policy later).\n\n\n\n\nAdd new TLOC Rules:\n+Sequence Type then select TLOC\n+Sequence Rule, select TLOC List under Match, first TLOC list selects DCs-BU2-TLOCs (this TLOC list has been pre-defined for you which includes all the TLOCs of DC1-WE2 and DC2-WE2); change Actions to accept\n\n\n+Sequence Rule, select TLOC List under Match, second TLOC list selects RH (this TLOC list has been pre-defined for you which includes all the TLOCs of RH); change Actions to accept\n\n\nThen click save Control Policy. This policy effectively allows R2-WE1 to build tunnels to all the DCs-BU1 devices (DC1-WE2 and DC2-WE2) as well as RH, nothing else as the default action is reject.\n\n\n\n\nStep 3.\n Apply the topology policy to Centralized Policy\n\n\nSelect Configuration(Gear Icon)->Add Policy, then click next, you will see Configure Topology and VPN membership, then click Add topology, select Import Existing Topology, then click Custom Control(Route and TLOC), select LAB_Topo_RS1; then Click on Add Topology, add LAB_Topo_RS2 as well\n\n\n\n\n\n\nNow click Next and Next, you will see Apply Policies to Sites and VPNs,\n\n\nPolicy Name: LAB_Central_v01\nDescription: Task2 Topo only\nClick New Site List Under LAB_Topo_RS1, under Outbound Site List, select RS1,then click on Add\nClick New Site List Under LAB_Topo_RS2, under Outbound Site List, select RS2,then click on Add\nthen click Save Policy\n\n\n\n\nStep 4.\n Activate the first Centralized Policy\n\n\nGo to Configuration Centralized Policy, click ...(three dots) of our LAB_Centeral_v01, then click on Activate, and Activate. Policy will be pushed to the vSmart.\n\n\n\n\nStep 5.\n Verify the hub & spoke topology where R1-WE1 and R2-WE1 should not have tunnel between them but everyone else.\n\n\nSSH to R1-WE1 & R2-WE1 do show sdwan bfd sessions, you can see that\n\n\n\n\n\n\nVerify the policy setting under \nPolicy\n tab\n\n\n\n\nPolicy Control Enforcement Preference: \nEnforced\n\n\nPolicy Control Enforcement Direction: \nIngress\n\n\n\n\n\n\nBoth of the configuration are default settings and pre-requisites for MicroSegmentation feature to function properly.\n\n\n\n\nNote down the \nSegment ID*\n (\n2752513*** shown in the sample screenshot.Your Segment ID may be different) for the VRF. you may use the notepad file on your RDP desktop. It will be used  later in the CLI show commands.\n\n\n\n\nStep 3.\n Navigate the APIC GUI and verify the bridge domain (BD) settings:\n\n\nTenants -> useg-user{TNUM} -> Networking -> Bridge Domains -> uSeg_BD\n\n\n\n\nWe are using all default parameters in the bridge domain configuration.\n\n\nClick on the \nL3 Configuration\n sub-tab in the Work pane to review L3 configuration for the bridge domain.\n\n\n\n\n\n\nBD subnets configured: \n10.10.10.1/24\n, \n20.20.20.1/24\n, and \n30.30.30.1/24\n.\n\n\n\n\nStep 4.\n Navigate the APIC GUI and verify the base EPG configuration:\n\n\nTenants -> useg-user{TNUM} -> Application Profiles -> uSeg_AP\n\n\nExpand on \nApplication EPGs\n underneath and click on \nbase_EPG\n then \nGeneral\n to verify the base EPG policy configuration.  \n\n\n\n\nNote down the \npcTag(sclass)\n value (\n49153\n in the sample screenshot) of the EPG for later use.\n\n\nClick on the \nOperational\n tab in the Work pane to verify the endpoints that are attached to the EPG.  \n\n\nVerify the endpoint names, IP addresses and note down the vlan encapsulation assigned.\n\n\nThe endpoints might be timed out after a long idling period. Please perform a PING to their gateways on the VMs if they are not shown in the list.\n\n\n\n\nClick on and expand \nbase_EPG\n, then click on \nDomains (VMs and Bare-Metals)\n in the Navigation pane, verify that the EGP is associated with DVS VMM Domain \nVMware/CLBlin2016\n and Allow Micro-Segmentation is set to \nFalse\n. Physical Domain \nuseg-baremetal-phys\n is also associated.   \n\n\n\n\n4. Intra EPG Isolation Configuration\n\n\nWe will enable \nIntra-EPG Isolation\n on our base EPG to demonstrate this feature. once the \nIntra-EPG Isolation\n feature is enabled, endpoints inside the base EPG will not able to communicate with each other.\n\n\nStep 1.\n Verify that all four (4) endpionts under \nbase_EPG\n can ping each other and their respective gateway.\n\n\nusername: \nuseg-user\n\n\npassword: \nciscolive.2019\n\n\nuseg{TNUM}-vm-web1\n : \n{VM-WEB1-OOB}\n\n\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 10.10.10.1 -c 2\nPING 10.10.10.1 (10.10.10.1) 56(84) bytes of data.\n64 bytes from 10.10.10.1: icmp_seq=1 ttl=63 time=0.477 ms\n...\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 10.10.10.12 -c 2\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 20.20.20.11 -c 2\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 20.20.20.12 -c 2\n\n\n\n\nuseg{TNUM}-vm-web2\n : \n{VM-WEB2-OOB}\n\n\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 10.10.10.1 -c 2\nPING 10.10.10.1 (10.10.10.1) 56(84) bytes of data.\n64 bytes from 10.10.10.1: icmp_seq=1 ttl=63 time=0.477 ms\n...\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 10.10.10.11 -c 2\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 20.20.20.11 -c 2\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 20.20.20.12 -c 2\n\n\n\n\nuseg{TNUM}-vm-app1\n : \n{VM-APP1-OOB}\n\n\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 20.20.20.1 -c 2\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 10.10.10.11 -c 2\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 10.10.10.12 -c 2\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 20.20.20.12 -c 2\n\n\n\n\nuseg{TNUM}-vm-app2\n : \n{VM-APP2-OOB}\n\n\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 20.20.20.1 -c 2\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 10.10.10.11 -c 2\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 10.10.10.12 -c 2\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 20.20.20.11 -c 2\n\n\n\n\nStep 2.\n Review the current zoning-rule configuration\n\n\nGo to \nFabric -> Inventory -> Pod 1 -> site1-leaf1 -> Rules\n  \n\n\n\n\nUse the \nSegment ID\n of the \nuSeg_VRF\n you noted down earlier on as \nscope ID\n (\n2752513\n in the sample screenshot) to filter the rules of interest.\n\n\nVerify that \nno\n specific filter shown for the \nbase_EPG\n with \npcTag\n that you noted earlier on (\n49153\n in the sample screenshot) as currently we don't have any contract associated with the base EPG.\n\n\n\n\nStep 3.\n Go back to your tenant->application profile->uSeg_AP->Application EPGs configuration from the APIC GUI, click on EPG \nbase_EPG\n in the Navagation pane, under the \nPolicy->Gerneral\n tab, change the \nIntra-EPG Isolation\n from \"\nUnenforced\n\" mode to \u201c\nEnforced\n\u201d mode.\n\n\nYou will see the following warning message regarding what are not supported with intra EPG isolation, click on \nOK\n, then click on \nSUBMIT\n.\n\n\n\n\nYou will see a Policy Usage Warning pop-up window, click on \nSUBMIT CHANGES\n to commit the change.\n\n\n\n\nStep 4.\n Back onto \nFabric -> Inventory -> Pod1 -> site1-leaf1 -> Rules\n, check the zoning-rule again. A new zoning-rule should be added to deny traffic within \nbase_EPG\n.\n\n\nIn the sample output, a new deny rule (ID \n4377\n) is added with both \nSrcEPG\n and \nDstEPG\n pcTag of \n49153\n.\n\n\n\n\nStep 5.\n  Click on tenant->application profile->uSeg_AP->Application EPGs->base_EPG->Operational->Client End-Points. Verify the encapsulation for the base EPG has changed to (P,S) pair which is a Private VLAN implementation under the hood.\n\n\n\n\nStep 6.\n  Verify endpoint connectivities within the base EPG.\n\n\nuseg{TNUM}-vm-web1\n : \n{VM-WEB1-OOB}\n\n\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 10.10.10.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 10.10.10.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 20.20.20.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 20.20.20.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 30.30.30.11 -c 2 -t 1\n\n\n\n\nuseg{TNUM}-vm-web2\n : \n{VM-WEB2-OOB}\n\n\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 10.10.10.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 10.10.10.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 20.20.20.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 20.20.20.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 30.30.30.11 -c 2 -t 1\n\n\n\n\nuseg{TNUM}-vm-app1\n : \n{VM-APP1-OOB}\n\n\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 20.20.20.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 10.10.10.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 10.10.10.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 20.20.20.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 30.30.30.11 -c 2 -t 1\n\n\n\n\nuseg{TNUM}-vm-app2\n : \n{VM-APP2-OOB}\n\n\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 20.20.20.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 10.10.10.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 10.10.10.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 20.20.20.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 30.30.30.11 -c 2 -t 1\n\n\n\n\nAll four (4) VMs can still reach their default gateway IP but can no longer ping each other. This confirms that no communication is allowed within an EPG when intra-EPG isolation is enforced.\n\n\nThis concludes the Intra-EPG Isolation feature test.\n\n\n5. Intra-EPG Security\n\n\nIntra-EPG Security allows the creation of contracts for Intra EPG traffic. The feature works for VMs, bare-metal servers, and on EPGs that have a mix of VMs and bare-metal servers. Intra-EPG security can be applied to both an EPG or a uSeg EPG.\n\n\nThe feature uses proxy ARP to work, which means we need to use leafs that are based on gen-2 ASICs (-EX) or later (-FX).\n\n\nIn this session we will create a contract allowing ssh among \nuseg{TNUM}-vm-web1\n, \nuseg{TNUM}-vm-web2\n, \nuseg{TNUM}-vm-app1\n, \nuseg{TNUM}-vm-app2\n, and \nuseg-bm-db\n to demonstrate the funcionality.\n\n\nStep 1.\n Create a Contract to be used for Intra-EPG Security: \nTenants -> useg-user{TNUM} -> Contracts\n.\n\n\n\n\nCreate a contract named \nc-ssh\n:  \n\n\n\n\nCreate a subjct named \ns-ssh\n:\n\n\n\n\nCreae a filter named \nf-ssh\n allowing only \ntcp\n traffic to port \n22\n:\n\n\n\n\nClick \nsubmit\n to save the configuration.\n\n\nStep 2.\n Apply the \nc-ssh\n contract to the base EPG going to \nTenants -> useg-user{TNUM} -> Application Profiles -> uSeg_AP -> Application EPGs -> base_EPG -> Contracts\n. Click on \nActions\n and then on \nAdd Intra-EPG Contract\n on the drop down menu:\n\n\n\n\nStep 3.\n Choose the contract recently created,  Accept the Warning and click on \nSubmit\n\n\n\n\n\n\nStep 4.\n Verify that the Intra-EPG Contract is in a \u201cformed\u201d state\n\n\n\n\nStep 5.\n Verify endpoint connectivities within the base EPG.\n\n\nuseg{TNUM}-vm-web1\n : \n{VM-WEB1-OOB}\n\n\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 10.10.10.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 10.10.10.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 20.20.20.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 20.20.20.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 30.30.30.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ssh 10.10.10.12\n[useg-user@useg{TNUM}-vm-web1 ~]# ssh 20.20.20.11\n[useg-user@useg{TNUM}-vm-web1 ~]# ssh 20.20.20.12\n[useg-user@useg{TNUM}-vm-web1 ~]# ssh 30.30.30.11\n\n\n\n\nIf you are able to see the prompt from the remote server it means \nssh\n is working. It is not necessary to log in to the servers.\n\n\nuseg{TNUM}-vm-web2\n : \n{VM-WEB2-OOB}\n\n\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 10.10.10.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 10.10.10.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 20.20.20.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 20.20.20.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 30.30.30.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ssh 10.10.10.11\n[useg-user@useg{TNUM}-vm-web2 ~]# ssh 20.20.20.11\n[useg-user@useg{TNUM}-vm-web2 ~]# ssh 20.20.20.12\n[useg-user@useg{TNUM}-vm-web2 ~]# ssh 30.30.30.11\n\n\n\n\nIf you are able to see the prompt from the remote server it means \nssh\n is working. It is not necessary to log in to the servers.\n\n\nuseg{TNUM}-vm-app1\n : \n{VM-APP1-OOB}\n\n\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 20.20.20.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 10.10.10.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 10.10.10.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 20.20.20.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 30.30.30.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ssh 10.10.10.11\n[useg-user@useg{TNUM}-vm-app1 ~]# ssh 10.10.10.12\n[useg-user@useg{TNUM}-vm-app1 ~]# ssh 20.20.20.12\n[useg-user@useg{TNUM}-vm-app1 ~]# ssh 30.30.30.11\n\n\n\n\nIf you are able to see the prompt from the remote server it means \nssh\n is working. It is not necessary to log in to the servers.\n\n\nuseg{TNUM}-vm-app2\n : \n{VM-APP2-OOB}\n\n\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 20.20.20.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 10.10.10.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 10.10.10.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 20.20.20.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 30.30.30.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ssh 10.10.10.11\n[useg-user@useg{TNUM}-vm-app2 ~]# ssh 10.10.10.12\n[useg-user@useg{TNUM}-vm-app2 ~]# ssh 20.20.20.11\n[useg-user@useg{TNUM}-vm-app2 ~]# ssh 30.30.30.11\n\n\n\n\nIf you are able to see the prompt from the remote server it means \nssh\n is working. It is not necessary to log in to the servers.\n\n\nAll four (4) VMs and (1) BM can still reach their default gateway IP, they can no longer ping each other but can ssh. This confirms that the only communication allowed within an EPG when intra-EPG security is enforced is controlled by the contract and it works for virtual machines and for bare metal servers.  \n\n\nThis concludes the Intra-EPG Security feature test.\n\n\n6. VM Attribute Based uSeg EPG Configuration\n\n\nWe will create a VM Name based uSeg EPG named \nweb_uSegEPG\n to host all endpoints that have \nweb\n in their hostnames.\n\n\nStep 1.\n Enable micro-segmentation for the VMM domain \ncl-useg-dvs\n. Double click on VMM domain \ncl-useg-dvs\n under \nTenants -> useg-user{TNUM} -> Application Profiles -> base_EPG  -> Domain -> VMware/CLBerlin2016\n. This process is disruptive to traffic to the VMs belonging to the base EPG. While it is ok in this lab, take that into consideration when implementing in a production environment.   \n\n\n\n\n\n\nNavigate back to \nTenants -> useg-user{TNUM} -> Application Profiles -> base_EPG\n and ensure that the \nforwarding control proxy-arp box\n is checked.  \n\n\n\n\n\n\nStep 2.\n Create a VM-attribute based uSeg EPG under \nTenants -> useg-user{TNUM} -> Application Profiles -> uSeg_AP -> uSeg EPGs\n by clicking on \nActions\n in Work pane and choose \nCreate uSeg EPG\n\n\n\n\n\n\nName it \nweb_uSegEPG\n\n\nAssociate it with bridge domain \nuseg-user{TNUM}/uSeg_BD\n, which is the same bridge domain that the base EPG \nbase_EPG\n is associated with.\n\n\n\n\n\n\n\n\nClick on \nNEXT\n to move to the Domains configuration window. Associate it with VMM domain \nCLBerlin2016\n, which is the same VMM domain associated with the base EPG.\n\n\nDeployment Immediacy: \nImmediate\n\n\nResolution Immediacy: \nImmediate\n  \n\n\n\n\n\n\nClick on \nUPDATE\n and then \nFINISH\n to complete the EPG configuration.\n\n\n\n\n\n\nStep 3.\n Click on \nuSeg Attributes\n under \nweb_uSegEPG\n. Click on the \nPlus\n signal on the right hand side to create a new filter.\n\n\n\n\n\n\n\n\nIn the pop up window, use the following parameters:\n\n\n\n\nMatch Any\n\n\nType\n: choose \nVM Name\n from dropdown menu\n\n\nOperator\n: choose \nContains\n from dropdown menu\n\n\nValue\n: \nweb\n\n\nClick on \nSubmit\n to save the configuration\n\n\n\n\n\n\n\n\n\n\nStep 4.\n Verify endpoints under \nweb_uSegEPG\n\n\n\n\nClick on \nweb_uSegEPG\n in the Navagation pane, then click on \nOperational\n tab in the Work pane.\n\n\nVerify that VMs \nuseg{TNUM}-vm-web1\n and \nuseg{TNUM}-vm-web2\n are shown as endpoints for the new VM attribute-based EPG.   \n\n\n(Optional) Verify that those two (2) web VM are no longer appear as endpoints under \nbase_EPG\n. MAC address of endpoints may stay in the base EPG for a while after they are moved into uSeg EPG.\n\n\n\n\nEndpoints under \nweb_uSegEPG\n:\n\n\n\n\nEndpoints under \nbase_EPG\n after \nweb_uSegEPG\n is created (MAC address of endpoints may stay in the base EPG for a while after they are moved into uSeg EPG).\n\n\n\n\nStep 4.\n Verify VM Port-group changes if any\n\n\nAlthough we do not provide user access to vCenter in this lab, from the APIC GUI, you can verify the same from \nVirtual Networking -> VMM Domains -> VMware -> CLBerlin2016 -> Controllers -> vcenter -> DVS - CLBerlin2016 -> Portgroups\n. You can use filter by your tenant name for easy access and validate the port group information from there.\n\n\n\n\nStep 5.\n Verify VM Connectivities\n\n\nuseg{TNUM}-vm-web1\n : \n{VM-WEB1-OOB}\n\n\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 10.10.10.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 10.10.10.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 20.20.20.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 20.20.20.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 30.30.30.11 -c 2 -t 1\n\n\n\n\nuseg{TNUM}-vm-web2\n : \n{VM-WEB2-OOB}\n\n\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 10.10.10.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 10.10.10.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 20.20.20.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 20.20.20.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 30.30.30.11 -c 2 -t 1\n\n\n\n\n\n\nuseg{TNUM}-vm-web1\n and \nuseg{TNUM}-vm-web2\n can ping each other as they are under the same uSeg EPG and \nIntra-EPG Isolation\n is not enabled. You may need to ping their gateway from both web VMs before they can ping each other (due to the fact the bridge domain is set to HA proxy mode)\n\n\nuseg{TNUM}-vm-web1\n and \nuseg{TNUM}-vm-web2\n can \nnot\n ping the two app VMs and the bare metal server that remain in \nbase_EPG\n as there is no contract configured between the two EPGs\n\n\nuseg{TNUM}-vm-web1\n and \nuseg{TNUM}-vm-web2\n can ping their default gateway IP \n10.10.10.1\n\n\n\n\nuseg{TNUM}-vm-app1\n : \n{VM-APP1-OOB}\n\n\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 20.20.20.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 10.10.10.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 10.10.10.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 20.20.20.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 30.30.30.11 -c 2 -t 1\n\n\n\n\nuseg{TNUM}-vm-app2\n : \n{VM-APP2-OOB}\n\n\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 20.20.20.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 10.10.10.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 10.10.10.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 20.20.20.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 30.30.30.11 -c 2 -t 1\n\n\n\n\n\n\nuseg{TNUM}-vm-app1\n and \nuseg{TNUM}-vm-app2\n can not ping each other as they are still under the \nbase_EPG\n and \nIntra-EPG Isolation\n is enabled.\n\n\n\n\n\n\nuseg{TNUM}-vm-app1\n and \nuseg{TNUM}-vm-app2\n can not ping \nuseg-bm-db\n as they are still under the \nbase_EPG\n and \nIntra-EPG Isolation\n is enabled.\n\n\n\n\n\n\nuseg{TNUM}-vm-app1\n and \nuseg{TNUM}-vm-app2\n can \nnot\n ping the two web VMs that are moved into \nweb_uSegEPG\n as there is no contract configured between the two EPGs\n\n\nuseg{TNUM}-vm-app1\n and \nuseg{TNUM}-vm-app2\n can ping their default gateway IP \n20.20.20.1\n\n\n\n\nThis concludes the VM attribute based EPG feature test.\n\n\n7. Network Attribute Based uSeg EPG\n\n\nWe will create an IP address based uSeg EPG named \napp_uSegEPG\n to host all endpoints that have IP address under IP subnet \n20.20.20.0/24\n.\n\n\nStep 1.\n Create a network attribute based uSeg EPG under \nTenants -> useg-user{TNUM} -> Application Profiles -> uSeg_AP -> uSeg EPGs\n by clicking on \nActions\n in Work pane and choose \nCreate uSeg EPG\n\n\n\n\n\n\nName it \napp_uSegEPG\n\n\nAssociate it with bridge domain \nuseg-user{TNUM}/uSeg_BD\n, which is the same bridge domain that the base EPG \nbase_EPG\n is associated with.\n\n\n\n\n\n\n\n\nClick on \nNEXT\n to move to the Domains configuration window. Associate it with VMM domain \nCLBerlin2016\n, which is the same VMM domain associated with the base EPG.\n\n\n\n\n\n\n\n\nClick on \nUPDATE\n and then \nFINISH\n to complete the EPG configuration.\n\n\n\n\nStep 2.\n Click on \nuSeg Attributes\n under \napp_uSegEPG\n. Click on the \nPlus\n signal on the right hand side to create a new filter.\n\n\n\n\n\n\n\n\nIn the pop up window, use the following parameters:\n\n\n\n\nMatch Any\n\n\nType\n: choose \nIP\n from dropdown menu\n\n\nUse EPG Subnet?\n: \nNo\n\n\nValue\n: \n20.20.20.0/24\n\n\nClick on \nSubmit\n to save the configuration\n\n\n\n\n\n\n\n\n\n\nStep 3.\n Verify endpoints under \napp_uSegEPG\n\n\n\n\nClick on \napp_uSegEPG\n in the Navagation pane, then click on \nOperational\n tab in the Work pane.\n\n\nVerify that VMs \nuseg{TNUM}-vm-app1\n and \nuseg{TNUM}-vm-app2\n appear as endpoints for the new IP based EPG.\n\n\nSome IP traffic must be seen by fabric before an endpoint can be classified into an IP based EPG. You may need to perform a ping to their gateway from both app VMs.    \n\n\n(Optional) Verify that those two (2) app VM are no longer shown as endpoints under \nbase_EPG\n. MAC address of endpoints may stay in the base EPG for a while after they are moved into uSeg EPG.\n\n\n\n\nEndpoints under \napp_uSegEPG\n\n\n\n\nEndpoints under \nbase_EPG\n.\n\n\n\n\nbase_EPG\n still have the Endpoints but they are mac learn while \napp_uSegEPG\n learns the Endpoints through their IPs.\n\n\nStep 3.\n Verify VM Port-group change if any\n\n\nFrom the APIC GUI, you can verify the same from \nVM Networking -> VMware -> cl-useg-dvs -> Controllers -> vcenter -> DVS - cl-useg-dvs -> Portgroups\n. You can use filter by your tenant name for easy access and validate the port group info from there.\n\n\n\n\nStep 4.\n Verify VM Connectivities\n\n\nuseg{TNUM}-vm-web1\n : \n{VM-WEB1-OOB}\n\n\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 10.10.10.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 10.10.10.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 20.20.20.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 20.20.20.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 30.30.30.11 -c 2 -t 1\n\n\n\n\nuseg{TNUM}-vm-web2\n : \n{VM-WEB2-OOB}\n\n\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 10.10.10.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 10.10.10.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 20.20.20.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 20.20.20.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 30.30.30.11 -c 2 -t 1\n\n\n\n\n\n\nuseg{TNUM}-vm-web1\n and \nuseg{TNUM}-vm-web2\n can ping each other as they are under the same uSeg EPG and \nIntra-EPG Isolation\n is not enabled.\n\n\nuseg{TNUM}-vm-web1\n and \nuseg{TNUM}-vm-web2\n can not ping the two app VMs that are moved in \napp_uSegEPG\n as there is no contract configured between the two EPGs\n\n\nuseg{TNUM}-vm-web1\n and \nuseg{TNUM}-vm-web2\n can not ping the bare metal server that remain in \nbase_EPG\n as there is no contract configured between the two EPGs\n\n\nuseg{TNUM}-vm-web1\n and \nuseg{TNUM}-vm-web2\n can ping their default gateway IP \n10.10.10.1\n\n\n\n\nuseg{TNUM}-vm-app1\n : \n{VM-APP1-OOB}\n\n\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 20.20.20.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 10.10.10.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 10.10.10.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 20.20.20.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 30.30.30.11 -c 2 -t 1\n\n\n\n\nuseg{TNUM}-vm-app2\n : \n{VM-APP2-OOB}\n\n\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 20.20.20.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 10.10.10.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 10.10.10.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 20.20.20.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 30.30.30.11 -c 2 -t 1\n\n\n\n\n\n\nuseg{TNUM}-vm-app1\n and \nuseg{TNUM}-vm-app2\n can now ping each other as they are under the \napp_uSegEPG\n and \nIntra-EPG Isolation\n is disabled.\n\n\nuseg{TNUM}-vm-app1\n and \nuseg{TNUM}-vm-app2\n can not ping the two web VMs that are under \nweb_uSegEPG\n as there is no contract configured between the two EPGs\n\n\nuseg{TNUM}-vm-app1\n and \nuseg{TNUM}-vm-app2\n can not ping the bare metal server that remain in \nbase_EPG\n as there is no contract configured between the two EPGs\n\n\nuseg{TNUM}-vm-app1\n and \nuseg{TNUM}-vm-app2\n can ping their default gateway IP \n20.20.20.1\n\n\n\n\nStep 5.\n Apply a contract between \nweb_uSegEPG\n and \napp_uSegEPG\n\n\n\n\n\n\nTo enable communication between \nweb_uSegEPG\n and \napp_uSegEPG\n, we will apply \ncommon/default\n contract.\n\n\n\n\n\n\nGo to \nTenant -> useg-user{TNUM} -> Application Profiles -> uSeg_AP -> uSeg EPGs -> web_uSegEPG -> Contracts\n, Click on \nActions\n in Work pane, and choose \nAdd Consumed Contract\n\n\n\n\n\n\n\n\n\n\n\n\nSelect \ncommon/default\n contract from the drop down list and click on \nSUBMIT\n.\n\n\n\n\n\n\nGo to \nTenant -> useg-user{TNUM} -> Application Profiles -> uSeg_AP -> uSeg EPGs -> app_uSegEPG -> Contracts\n, Click on \nActions\n in Work pane, and choose \nAdd Provided Contract\n\n\n\n\n\n\n\n\n\n\nSelect \ncommon/default\n contract from the drop down list and click on \nSUBMIT\n.\n\n\n\n\nStep 6.\n Verify VM Connectivity\n\n\nuseg{TNUM}-vm-web1\n : \n{VM-WEB1-OOB}\n\n\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 20.20.20.11\n\n\n\n\nuseg{TNUM}-vm-app1\n : \n{VM-APP1-OOB}\n\n\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 10.10.10.11 -c 2 -t 1\n\n\n\n\n\n\nuseg{TNUM}-vm-web1\n and \nuseg{TNUM}-vm-app2\n can now ping each other as the permit-any (\ndefault\n contract in ACI) contract has been applied between the two EPGs\n\n\n\n\nThis concludes the network attribute based EPG feature test.\n\n\n8. Hierarchal Matching of uSeg Attributes Using OR/AND Operator\n\n\nYou can configure uSeg EPGs with multiple attributes. However, VMs can become part of only one uSeg EPG. When a VM has attributes matching more than one uSeg EPG in the tenant, Cisco APIC puts the VM into a uSeg EPG based on filtering rules. Depending on how you define the attributes, you can use different filtering rules:\n\n\n\n\n\n\nMatching any attribute - You can match any attribute, and Cisco APIC follows default precedence among attributes in deciding which uSeg EPG that a VM will join.\n\n\n\n\n\n\nMatching all attributes - You can match all of the VM-based attributes defined for the uSeg EPG. You cannot match all for multiple network-based attributes.\n\n\n\n\n\n\nMatch-Any and Match-All operators are not supported for:\n\n\n\n\nMAC Attribute\n\n\nIP Attribute\n\n\n\n\nWe will add a second filter to \nweb_uSegEPG\n using\nMatch-Any (Matching any attribute defined for a uSeg EPG is the default):\n\n\n\n\nMatch-Any\n\n\nType\n: choose \nVM Name\n from dropdown menu\n\n\nOperator\n: choose \nContains\n from dropdown menu\n\n\nValue\n: \n2\n\n\nClick on \nSubmit\n to save the configuration\n\n\n\n\n\n\nEndpoints under \nweb_uSegEPG\n\n\n\n\nIn this case three VMs were moved to the \nweb_uSegEPG\n:\n\n\n\n\ntwo VMs that matched the \nVM Name\n containing \nweb\n: \nuseg{TNUM}-vm-web1\n and \nuseg{TNUM}-vm-web2\n\n\none VM that matched the \nVM Name\n containing \n2\n: \nuseg{TNUM}-vm-app2\n\n\n\n\nWe will modify the filter associated to \nweb_uSegEPG\n using Match-All:\n\n\n\n\nMatch-All\n\n\nType\n: choose \nVM Name\n from dropdown menu\n\n\nOperator\n: choose \nContains\n from dropdown menu\n\n\nValue\n: \n2\n\n\nClick on \nSubmit\n to save the configuration\n\n\n\n\n\n\nEndpoints under \nweb_uSegEPG\n\n\n\n\nIn this case only one VMs was moved to the \nweb_uSegEPG\n: \nuseg{TNUM}-vm-web2\n\n\n\n\none VM that matched the \nVM Name\n containing \n2\n and the \nVM Name\n containing \nweb\n.\n\n\n\n\nUsing Match-Any and Match-All you can create multiple statements to filter for multiple attributes, or you can create block, or nested, statements to create precise filtering rules.\n\n\nThe uSeg EPG precedence value used as uSeg match tie-breaker with OR/AND VM attributes.\n\n\nThis concludes the Hierarchal Matching of uSeg Attributes Using OR/AND Operator feature test.\n\n\n9. DNS Attribute Based uSeg EPG\n\n\nDNS Attribute based uSeg carves uEPG based on Domain Name (DN) or FQDN.\n\n\nAPIC polls DNS server zone and retrieves all IPs and caches them locally.\n\n\nThe feature is still in beta at the time of this writing.\n\n\nIn this session we will use DNS attribute based uSeg to create usegs EPGs for the DB server.\n\n\nStep 1.\n Configure a DNS Server Group. Right click on the \naction\n button on the right hand side and select \nCreate DNS Server Group\n  \n\n\n\n\n\n\n\n\nIn the pop up window, use the following parameters:\n\n\n\n\nAccept the Agreeement\n\n\nName\n: \ndns-group\n\n\nDNS Servers\n: \n172.21.208.194\n\n\nClick on \nSubmit\n to save the configuration\n\n\n\n\n\n\n\n\n\n\nStep 2.\n Configure a Domain. Click on the newly created \ndns-group\n and then click on the plus sign on the right hand side pane.  \n\n\n  \n\n\n\n\n\n\nIn the window, use the following parameters:\n\n\n\n\nDomain Name\n: \naci.local\n\n\nClick on \nUpdate\n to save the configuration\n\n\n\n\n\n\n\n\nStep 3.\n Create a DNS based uSeg EPG under \nTenants -> useg-user{TNUM} -> Application Profiles -> uSeg_AP -> uSeg EPGs\n by clicking on \nActions\n in Work pane and choose \nCreate uSeg EPG\n\n\n\n\n\n\nName it \ndb_uSegEPG\n\n\nAssociate it with bridge domain \nuseg-user{TNUM}/uSeg_BD\n, which is the same bridge domain that the base EPG \nbase_EPG\n is associated with.\n\n\n\n\n\n\n\n\nClick on \nNEXT\n to move to the Domains configuration window. Associate it with physical domain \nuseg-baremetal-phys\n.\n\n\n\n\n\n\n\n\nClick on \nUPDATE\n and then \nFINISH\n to complete the EPG configuration.\n\n\n\n\nStep 2.\n Statically bind \nsite1-leaf1\n and \nsite1-leaf2\n to the \ndb_uSegEPG\n clicking on \nStatic Leaf\n under the \ndb_uSegEPG\n.\n\n\n\n\n\n\nStep 3.\n Click on \nuSeg Attributes\n under \ndb_uSegEPG\n. Click on the \nPlus\n signal on the right hand side to create a new filter.\n\n\n\n\n\n\nIn the pop up window, use the following parameters:\n\n\n\n\nMatch Any\n\n\nType\n: choose \nDNS\n from dropdown menu\n\n\n\n\n\n\n\n\nClick on the magnify glass icon and select the following parameters:\n\n\n\n\nDNS Zone DB\n: \naci.local\n\n\nDNS Zone Entry\n: \nuseg-bm-db\n\n\n\n\n\n\n\n\n\n\n\n\nClick on \nSelect\n and then \nSubmit\n to save the configuration.\n\n\n\n\nStep 4.\n Verify endpoints under \ndb_uSegEPG\n\n\n\n\nClick on \ndb_uSegEPG\n in the Navagation pane, then click on \nOperational\n tab in the Work pane.\n\n\nVerify that  \nuseg-bm-db\n appear as endpoints for the new DNS based EPG.\n\n\nSome IP traffic must be seen by fabric before an endpoint can be classified into an IP based EPG. You may need to perform a ping to their gateway.   \n\n\nVerify that the BM has the same VLAN encap.\n\n\n\n\nEndpoints under \ndb_uSegEPG\n\n\n\n\nEndpoints under \nbase_EPG\n.\n\n\n\n\nbase_EPG\n still have the Endpoints but they are mac learn while \ndb_uSegEPG\n learns the Endpoints through their IPs.\n\n\nStep 5.\n Verify VM Connectivities\n\n\nuseg{TNUM}-vm-web1\n : \n{VM-WEB1-OOB}\n\n\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 30.30.30.11 -c 2 -t 1\n\n\n\n\nuseg{TNUM}-vm-web2\n : \n{VM-WEB2-OOB}\n\n\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 30.30.30.11 -c 2 -t 1\n\n\n\n\n\n\nuseg{TNUM}-vm-web1\n and \nuseg{TNUM}-vm-web2\n can not ping \nuseg-bm-db\n that are moved in \ndb_uSegEPG\n as there is no contract configured between the two EPGs\n\n\n\n\nuseg{TNUM}-vm-app1\n : \n{VM-APP1-OOB}\n\n\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 30.30.30.11 -c 2 -t 1\n\n\n\n\nuseg{TNUM}-vm-app2\n : \n{VM-APP2-OOB}\n\n\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 30.30.30.11 -c 2 -t 1\n\n\n\n\n\n\nuseg{TNUM}-vm-app1\n and \nuseg{TNUM}-vm-app2\n can not ping  \nuseg-bm-db\n db server that are under \ndb_uSegEPG\n as there is no contract configured between the two EPGs\n\n\n\n\nStep 6.\n Apply a contract between \napp_uSegEPG\n and \ndb_uSegEPG\n. Instead of creating a new contract and associating to \napp_uSegEPG\n and \ndb_uSegEPG\n we will leverage a feature called contract inheritance to streamline associating contracts to new EPGs. The EPG inherits all the (provided and consumed) contracts associated directly to another EPG in the same tenant. Contract inheritance can be configured for application, microsegmented, L2Out, and L3Out EPGs.\n\n\nWith Release 3.x, you can also configure contract inheritance for Inter-EPG contracts, both provided and consumed. Inter-EPG contracts are supported on Cisco Nexus 9000 Series switches with EX or FX at the end of their model name or later models.\n\n\nWe want VMs belonging to \napp_uSegEPG\n to access \nuseg-bm-db\n server but we dont want VMs from \nweb_uSegEPG\n to have access to the database server.\n\n\n\n\nClick on \ndb_uSegEPG\n in the Navagation pane, then click on \nPolicy\n -> \nGeneral\n tab in the Work pane.\n\n\n\n\n\n\n\n\nScrown down to \nEPG Contract Master\n and click on the \nAdd\n icon on the right top corner.\n\n\nFrom the drop down menu choose:\n\n\nSelect AP\n: \nuSeg_AP\n\n\nSelect EPG\n: \nweb_uSegEPG\n\n\n\n\n\n\n\n\n\n\nStep 7.\n Verify VM Connectivities\n\n\nuseg{TNUM}-vm-web1\n : \n{VM-WEB1-OOB}\n\n\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 30.30.30.11 -c 2 -t 1\n\n\n\n\nuseg{TNUM}-vm-web2\n : \n{VM-WEB2-OOB}\n\n\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 30.30.30.11 -c 2 -t 1\n\n\n\n\n\n\nuseg{TNUM}-vm-web1\n and \nuseg{TNUM}-vm-web2\n can not ping \nuseg-bm-db\n that are moved in \ndb_uSegEPG\n as there is no contract configured between the two EPGs\n\n\n\n\nuseg{TNUM}-vm-app1\n : \n{VM-APP1-OOB}\n\n\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 30.30.30.11 -c 2 -t 1\n\n\n\n\nuseg{TNUM}-vm-app2\n : \n{VM-APP2-OOB}\n\n\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 30.30.30.11 -c 2 -t 1\n\n\n\n\n\n\nuseg{TNUM}-vm-app1\n and \nuseg{TNUM}-vm-app2\n can ping  \nuseg-bm-db\n db server that is under \ndb_uSegEPG\n because it inherites the contract from \nweb_uSegEPG\n.\n\n\n\n\nThis concludes the test with DNS based uSeg and contract inheritance.\n\n\nCongratulations!\n You have completed the MicrsoSegmentation WISP lab! Thank you for your time!\n\n\nBack to Top",
            "title": "Lab 1 Tasks"
        },
        {
            "location": "/lab1/#lab-1-advanced-routing",
            "text": "ACME DC routers have already tagged all the routes originated from DC1 with BGP community of 65010:1000; all the routes originated from DC2 with BGP community of 65020:2000. Please configure a route-policy to ensure default route (0.0.0.0/0) coming from DC to set an OMP tag of 100. For DC1 routes, setting an OMP tag of 1000; for DC2 routes, setting an OMP tag of 2000. (Lab_Task 1)   ACME wants to have a hub & spoke topology between Remotes and DCs as well between Remotes and Regional hubs. Hub & spoke topology will scale more by reducing NO. of tunnels required on the devices.   ACME has categorized their branches into mutliple Business Units(BUs). In the Data Center (DC) sites, the headend WAN Edges(WEs) are also categorized into mutiple BUs for horizontal scaling purpose in terms of throughputs, therefore RS only needs to build tunnels to its respective DC hub WEs.Remote Site1 only needs to build tunnels to DC1-WE1 and DC2-WE2; on the contrary, Remote Site 2 only needs to build tunnels  to DC1-WE2 and DC2-WE2.(Lab_Task 2)    Remote sites receive default route from both RH and DC, DCs will be preferred and load shared. If RH goes down, DCs are load shared for default(Lab_Task 2)    Remotes sites receive more specific routes from both DCs, routes originated from local DC are preferred, if one DC goes down, it will use the routes from another DC as backup. In another words, from remote sites perspective, previously routes tagged with 1000 will prefer DC1; routes tagged with 2000 will prefer DC2.(Lab_Task 2)    For remote sites to any other regional routes are forced to go through DC\u2019s functional hub. For remote site1, it goes through WE1 in DC1 and 2; for remote site 2, it goes through WE2 in DC1 and 2.(Lab_Task 2)    Note: In these lab exercises, it's possible that there are multiple ways to achieve the requirements. The lab guide provides a detailed step by step instruction for each task. However you're welcomed to solve it with your own solution. Just be mindful with the time.",
            "title": "Lab 1: Advanced Routing"
        },
        {
            "location": "/lab1/#task1-lab-instructions-for-task-lab_task-1",
            "text": "Step 1.  Verification of the routes received on DC WEs.\nSSH to DC1-WE1 (repeat the same on DC1-WE2,DC2-WE1,DC2-WE2,R1-WE1 and R2-WE2 as well) and do show ip route vrf 1 and make sure 10.100.100.0/24 and 10.200.200/24 as well as 0.0.0.0/0 learned via BGP.   Step 2.  Verify the BGP communities. 10.100.100.0/24 should tag with 65010:1000; 10.200.200.0/24 should tag with 65020:2000. Execute show ip bgp vpnv4 vrf 1   (10.100.100.0/24 and 10.200.200.0/24) on DC1-WE1,WE2 and DC2-WE1,WE2.   Step 3.  Configuring Local Route-Policy to set OMP tag for DC specific Routes. Go to Configuration->Policies->Custom Options(upper righ)->Route Policy->Add Route Policy->Create New, then do the following:  Name: LAB_DCs_BGP_RP (write down this name, it will be used later)\nDescription: LAB_DCs_BGP_RP\nClick +Sequence Type then click +Sequence Rule, click Math, select Address, select default.   Click Action, change to Accept, then select OMP tag, key in 100, then save Match and Actions.   Create two other rules:  Match community-list DC1_Routes, Accept and Set Tag 1000;\nMatch community-list DC2_Routes, Accept and Set Tag 2000;\nThen click on Save Route Policy   Step 4.  Creating a Local Policy  Click on Localized Policy, then click on Add Policy   Click on Next,Next and Next, till you see Configure Route Policy, then click Add Route Policy, then select Import Existing Policy, Select LAB_DCs_BGP_RP click import  \nClick on Next, Key in Policy Name: LAB_DCs_Local_policy; Policy Description: LAB_DCs_Local_policy. Check Netflow, Application and Implict ACL Logging. Then click on Save Policy (Feel free to click Preview before save)   Step 5.  Configuring BGP template to apply the route-policy\nGo to Configuration->Template then search for BGP in the serch bar; select Lab_DC_VPN1_BGP_V01 and select three dots then click Edit.   Select Neighbor section, then click on the pencil icon under Action.   Update the following:\nAddress Family changes to Global and set to On\nAddress Family changes to Global and set to ipv4-unicast\nRoute Policy In changes to Global and set to On\nPolicy Name changes to Global and set to LAB_DCs_BGP_RP (this was the name you wrote down earlier)\nthen click on Save changes and Click on Update   Then click Next, feel free to review the config changes, then click Configure Devices, then check the Confim configuration box and click on OK.   Step 6.  Verify that the OMP Tags have been properly set.  SSH to DC wEdge routers(DC1-WE1,DC1-WE2,DC2-WE1,DC2-We2) and run show ip bgp vpnv4 vrf 1   (10.100.100.0/24,10.200.200.0/24), you should see proper OMP tags are set",
            "title": "task1: Lab instructions for task Lab_Task 1"
        },
        {
            "location": "/lab1/#32-lab-instructions-for-task-lab_task-2",
            "text": "Step 1.  Let's do some verification before we do any configurations.\nSSH to R1-WE1 and do show sdwan omp route vpn 1   Do you know why the default route learned from private2 shown as invalid and unreachable (Inv,U)? This is because R1-WE1 doesn't have a transport with private 2 color. If you watch the route on R2-WE1, you should notice the next hop from private 1 marked as Inv,U for the same reason where private 1 color doesn't exist on R2-WE1.  Did you notice the default route is learned from 1.1.30.2 which is the Regional Hub(RH)? Do you know why? In order to answer this question, we have to look at the vSmart table as all the routes are told by vSmart.SSH to vSmart and do show omp route vpn 1 0.0.0.0/0 detail | t   OMP is very much like BGP when it comes down to route preference. In the order of preference, there is a origin-protocol, in this case the default route learned on RH is from Static (by design, in real deployment, probably it's going to be BGP as well); whereas the default learned from DCs is from iBGP. Origin protocol static is more preferred than iBGP.  Now, let's look at the specific routes learned from DC. Do show sdwan omp route vpn 1 10.100.100.0/24.   You will see 4 paths and one of the paths shows Inv,U. Hopefully you can answer why it's that. But why there are 4 paths?  Again, let's go to vSmart and see. SSH to vSmart and do show omp route vpn 1 10.100.100.0/24 | t.   You will see 12 ECMP routes marked as C,R (Chosen,Resolved). Why 12? Because we have 4 DC wEdges each with 3 transport, so total 12 paths. The next question will be why there are only 4 paths on the remote wEdges? This is because the ECMP settings on the wEdge by default is set to 4. If you change it to 16 (currently 16, it will be increased to 128 in the future release), you will see all 12 paths. Note: vSmart is going to randomly select 4 paths (or whatever the max ECMP value is set) installed on the device, in a very large deployment where multiple paths is more than 16 before 128 paths is supported, this may pose problem. This excercise we purposely don't change the ECMP setting and learn how to solve this issue with centralized policy.  Step 2.  Creating a topology for centralized policy.We're going to tackle the above requirements step by step.  On the side bar select the Gear(Configuration) Icon then click Policies, then select Custom Options then select on Topology, then click on Add Topology.   We're going to create two topologies, one for Remote Site 1 another for Remote site 2.  Creating first topology:\nName: LAB_Topo_RS1\nDescription: LAB topology for Remote Site 1\n+Sequence Type then select Route\n+Sequence Rule, leave unchanged under Match(means match all), change Actions to default (we'll come back and do the routes policy later).   Add new TLOC Rules:\n+Sequence Type then select TLOC\n+Sequence Rule, select TLOC List under Match, first TLOC list selects DCs-BU1-TLOCs (this TLOC list has been pre-defined for you which includes all the TLOCs of DC1-WE1 and DC2-WE1); change Actions to accept  +Sequence Rule, select TLOC List under Match, second TLOC list selects RH (this TLOC list has been pre-defined for you which includes all the TLOCs of RH); change Actions to accept  Then click save Control Policy. This policy effectively allows R1-WE1 to build tunnels to all the DCs-BU1 devices (DC1-WE1 and DC2-WE1) as well as RH, nothing else as the default action is reject.   Follow the above step and create another topology with the following settings:\nName: LAB_Topo_RS2\nDescription: LAB topology for Remote Site 2\n+Sequence Type then select Route\n+Sequence Rule, leave unchanged under Match(means match all), change Actions to default (we'll come back and do the routes policy later).   Add new TLOC Rules:\n+Sequence Type then select TLOC\n+Sequence Rule, select TLOC List under Match, first TLOC list selects DCs-BU2-TLOCs (this TLOC list has been pre-defined for you which includes all the TLOCs of DC1-WE2 and DC2-WE2); change Actions to accept  +Sequence Rule, select TLOC List under Match, second TLOC list selects RH (this TLOC list has been pre-defined for you which includes all the TLOCs of RH); change Actions to accept  Then click save Control Policy. This policy effectively allows R2-WE1 to build tunnels to all the DCs-BU1 devices (DC1-WE2 and DC2-WE2) as well as RH, nothing else as the default action is reject.   Step 3.  Apply the topology policy to Centralized Policy  Select Configuration(Gear Icon)->Add Policy, then click next, you will see Configure Topology and VPN membership, then click Add topology, select Import Existing Topology, then click Custom Control(Route and TLOC), select LAB_Topo_RS1; then Click on Add Topology, add LAB_Topo_RS2 as well    Now click Next and Next, you will see Apply Policies to Sites and VPNs,  Policy Name: LAB_Central_v01\nDescription: Task2 Topo only\nClick New Site List Under LAB_Topo_RS1, under Outbound Site List, select RS1,then click on Add\nClick New Site List Under LAB_Topo_RS2, under Outbound Site List, select RS2,then click on Add\nthen click Save Policy   Step 4.  Activate the first Centralized Policy  Go to Configuration Centralized Policy, click ...(three dots) of our LAB_Centeral_v01, then click on Activate, and Activate. Policy will be pushed to the vSmart.   Step 5.  Verify the hub & spoke topology where R1-WE1 and R2-WE1 should not have tunnel between them but everyone else.  SSH to R1-WE1 & R2-WE1 do show sdwan bfd sessions, you can see that    Verify the policy setting under  Policy  tab   Policy Control Enforcement Preference:  Enforced  Policy Control Enforcement Direction:  Ingress    Both of the configuration are default settings and pre-requisites for MicroSegmentation feature to function properly.   Note down the  Segment ID*  ( 2752513*** shown in the sample screenshot.Your Segment ID may be different) for the VRF. you may use the notepad file on your RDP desktop. It will be used  later in the CLI show commands.   Step 3.  Navigate the APIC GUI and verify the bridge domain (BD) settings:  Tenants -> useg-user{TNUM} -> Networking -> Bridge Domains -> uSeg_BD   We are using all default parameters in the bridge domain configuration.  Click on the  L3 Configuration  sub-tab in the Work pane to review L3 configuration for the bridge domain.    BD subnets configured:  10.10.10.1/24 ,  20.20.20.1/24 , and  30.30.30.1/24 .   Step 4.  Navigate the APIC GUI and verify the base EPG configuration:  Tenants -> useg-user{TNUM} -> Application Profiles -> uSeg_AP  Expand on  Application EPGs  underneath and click on  base_EPG  then  General  to verify the base EPG policy configuration.     Note down the  pcTag(sclass)  value ( 49153  in the sample screenshot) of the EPG for later use.  Click on the  Operational  tab in the Work pane to verify the endpoints that are attached to the EPG.    Verify the endpoint names, IP addresses and note down the vlan encapsulation assigned.  The endpoints might be timed out after a long idling period. Please perform a PING to their gateways on the VMs if they are not shown in the list.   Click on and expand  base_EPG , then click on  Domains (VMs and Bare-Metals)  in the Navigation pane, verify that the EGP is associated with DVS VMM Domain  VMware/CLBlin2016  and Allow Micro-Segmentation is set to  False . Physical Domain  useg-baremetal-phys  is also associated.",
            "title": "3.2 Lab instructions for task Lab_Task 2"
        },
        {
            "location": "/lab1/#4-intra-epg-isolation-configuration",
            "text": "We will enable  Intra-EPG Isolation  on our base EPG to demonstrate this feature. once the  Intra-EPG Isolation  feature is enabled, endpoints inside the base EPG will not able to communicate with each other.  Step 1.  Verify that all four (4) endpionts under  base_EPG  can ping each other and their respective gateway.  username:  useg-user  password:  ciscolive.2019  useg{TNUM}-vm-web1  :  {VM-WEB1-OOB}  [useg-user@useg{TNUM}-vm-web1 ~]# ping 10.10.10.1 -c 2\nPING 10.10.10.1 (10.10.10.1) 56(84) bytes of data.\n64 bytes from 10.10.10.1: icmp_seq=1 ttl=63 time=0.477 ms\n...\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 10.10.10.12 -c 2\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 20.20.20.11 -c 2\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 20.20.20.12 -c 2  useg{TNUM}-vm-web2  :  {VM-WEB2-OOB}  [useg-user@useg{TNUM}-vm-web2 ~]# ping 10.10.10.1 -c 2\nPING 10.10.10.1 (10.10.10.1) 56(84) bytes of data.\n64 bytes from 10.10.10.1: icmp_seq=1 ttl=63 time=0.477 ms\n...\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 10.10.10.11 -c 2\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 20.20.20.11 -c 2\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 20.20.20.12 -c 2  useg{TNUM}-vm-app1  :  {VM-APP1-OOB}  [useg-user@useg{TNUM}-vm-app1 ~]# ping 20.20.20.1 -c 2\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 10.10.10.11 -c 2\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 10.10.10.12 -c 2\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 20.20.20.12 -c 2  useg{TNUM}-vm-app2  :  {VM-APP2-OOB}  [useg-user@useg{TNUM}-vm-app2 ~]# ping 20.20.20.1 -c 2\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 10.10.10.11 -c 2\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 10.10.10.12 -c 2\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 20.20.20.11 -c 2  Step 2.  Review the current zoning-rule configuration  Go to  Fabric -> Inventory -> Pod 1 -> site1-leaf1 -> Rules      Use the  Segment ID  of the  uSeg_VRF  you noted down earlier on as  scope ID  ( 2752513  in the sample screenshot) to filter the rules of interest.  Verify that  no  specific filter shown for the  base_EPG  with  pcTag  that you noted earlier on ( 49153  in the sample screenshot) as currently we don't have any contract associated with the base EPG.   Step 3.  Go back to your tenant->application profile->uSeg_AP->Application EPGs configuration from the APIC GUI, click on EPG  base_EPG  in the Navagation pane, under the  Policy->Gerneral  tab, change the  Intra-EPG Isolation  from \" Unenforced \" mode to \u201c Enforced \u201d mode.  You will see the following warning message regarding what are not supported with intra EPG isolation, click on  OK , then click on  SUBMIT .   You will see a Policy Usage Warning pop-up window, click on  SUBMIT CHANGES  to commit the change.   Step 4.  Back onto  Fabric -> Inventory -> Pod1 -> site1-leaf1 -> Rules , check the zoning-rule again. A new zoning-rule should be added to deny traffic within  base_EPG .  In the sample output, a new deny rule (ID  4377 ) is added with both  SrcEPG  and  DstEPG  pcTag of  49153 .   Step 5.   Click on tenant->application profile->uSeg_AP->Application EPGs->base_EPG->Operational->Client End-Points. Verify the encapsulation for the base EPG has changed to (P,S) pair which is a Private VLAN implementation under the hood.   Step 6.   Verify endpoint connectivities within the base EPG.  useg{TNUM}-vm-web1  :  {VM-WEB1-OOB}  [useg-user@useg{TNUM}-vm-web1 ~]# ping 10.10.10.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 10.10.10.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 20.20.20.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 20.20.20.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 30.30.30.11 -c 2 -t 1  useg{TNUM}-vm-web2  :  {VM-WEB2-OOB}  [useg-user@useg{TNUM}-vm-web2 ~]# ping 10.10.10.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 10.10.10.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 20.20.20.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 20.20.20.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 30.30.30.11 -c 2 -t 1  useg{TNUM}-vm-app1  :  {VM-APP1-OOB}  [useg-user@useg{TNUM}-vm-app1 ~]# ping 20.20.20.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 10.10.10.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 10.10.10.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 20.20.20.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 30.30.30.11 -c 2 -t 1  useg{TNUM}-vm-app2  :  {VM-APP2-OOB}  [useg-user@useg{TNUM}-vm-app2 ~]# ping 20.20.20.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 10.10.10.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 10.10.10.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 20.20.20.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 30.30.30.11 -c 2 -t 1  All four (4) VMs can still reach their default gateway IP but can no longer ping each other. This confirms that no communication is allowed within an EPG when intra-EPG isolation is enforced.  This concludes the Intra-EPG Isolation feature test.",
            "title": "4. Intra EPG Isolation Configuration"
        },
        {
            "location": "/lab1/#5-intra-epg-security",
            "text": "Intra-EPG Security allows the creation of contracts for Intra EPG traffic. The feature works for VMs, bare-metal servers, and on EPGs that have a mix of VMs and bare-metal servers. Intra-EPG security can be applied to both an EPG or a uSeg EPG.  The feature uses proxy ARP to work, which means we need to use leafs that are based on gen-2 ASICs (-EX) or later (-FX).  In this session we will create a contract allowing ssh among  useg{TNUM}-vm-web1 ,  useg{TNUM}-vm-web2 ,  useg{TNUM}-vm-app1 ,  useg{TNUM}-vm-app2 , and  useg-bm-db  to demonstrate the funcionality.  Step 1.  Create a Contract to be used for Intra-EPG Security:  Tenants -> useg-user{TNUM} -> Contracts .   Create a contract named  c-ssh :     Create a subjct named  s-ssh :   Creae a filter named  f-ssh  allowing only  tcp  traffic to port  22 :   Click  submit  to save the configuration.  Step 2.  Apply the  c-ssh  contract to the base EPG going to  Tenants -> useg-user{TNUM} -> Application Profiles -> uSeg_AP -> Application EPGs -> base_EPG -> Contracts . Click on  Actions  and then on  Add Intra-EPG Contract  on the drop down menu:   Step 3.  Choose the contract recently created,  Accept the Warning and click on  Submit    Step 4.  Verify that the Intra-EPG Contract is in a \u201cformed\u201d state   Step 5.  Verify endpoint connectivities within the base EPG.  useg{TNUM}-vm-web1  :  {VM-WEB1-OOB}  [useg-user@useg{TNUM}-vm-web1 ~]# ping 10.10.10.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 10.10.10.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 20.20.20.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 20.20.20.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 30.30.30.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ssh 10.10.10.12\n[useg-user@useg{TNUM}-vm-web1 ~]# ssh 20.20.20.11\n[useg-user@useg{TNUM}-vm-web1 ~]# ssh 20.20.20.12\n[useg-user@useg{TNUM}-vm-web1 ~]# ssh 30.30.30.11  If you are able to see the prompt from the remote server it means  ssh  is working. It is not necessary to log in to the servers.  useg{TNUM}-vm-web2  :  {VM-WEB2-OOB}  [useg-user@useg{TNUM}-vm-web2 ~]# ping 10.10.10.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 10.10.10.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 20.20.20.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 20.20.20.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 30.30.30.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ssh 10.10.10.11\n[useg-user@useg{TNUM}-vm-web2 ~]# ssh 20.20.20.11\n[useg-user@useg{TNUM}-vm-web2 ~]# ssh 20.20.20.12\n[useg-user@useg{TNUM}-vm-web2 ~]# ssh 30.30.30.11  If you are able to see the prompt from the remote server it means  ssh  is working. It is not necessary to log in to the servers.  useg{TNUM}-vm-app1  :  {VM-APP1-OOB}  [useg-user@useg{TNUM}-vm-app1 ~]# ping 20.20.20.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 10.10.10.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 10.10.10.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 20.20.20.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 30.30.30.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ssh 10.10.10.11\n[useg-user@useg{TNUM}-vm-app1 ~]# ssh 10.10.10.12\n[useg-user@useg{TNUM}-vm-app1 ~]# ssh 20.20.20.12\n[useg-user@useg{TNUM}-vm-app1 ~]# ssh 30.30.30.11  If you are able to see the prompt from the remote server it means  ssh  is working. It is not necessary to log in to the servers.  useg{TNUM}-vm-app2  :  {VM-APP2-OOB}  [useg-user@useg{TNUM}-vm-app2 ~]# ping 20.20.20.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 10.10.10.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 10.10.10.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 20.20.20.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 30.30.30.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ssh 10.10.10.11\n[useg-user@useg{TNUM}-vm-app2 ~]# ssh 10.10.10.12\n[useg-user@useg{TNUM}-vm-app2 ~]# ssh 20.20.20.11\n[useg-user@useg{TNUM}-vm-app2 ~]# ssh 30.30.30.11  If you are able to see the prompt from the remote server it means  ssh  is working. It is not necessary to log in to the servers.  All four (4) VMs and (1) BM can still reach their default gateway IP, they can no longer ping each other but can ssh. This confirms that the only communication allowed within an EPG when intra-EPG security is enforced is controlled by the contract and it works for virtual machines and for bare metal servers.    This concludes the Intra-EPG Security feature test.",
            "title": "5. Intra-EPG Security"
        },
        {
            "location": "/lab1/#6-vm-attribute-based-useg-epg-configuration",
            "text": "We will create a VM Name based uSeg EPG named  web_uSegEPG  to host all endpoints that have  web  in their hostnames.  Step 1.  Enable micro-segmentation for the VMM domain  cl-useg-dvs . Double click on VMM domain  cl-useg-dvs  under  Tenants -> useg-user{TNUM} -> Application Profiles -> base_EPG  -> Domain -> VMware/CLBerlin2016 . This process is disruptive to traffic to the VMs belonging to the base EPG. While it is ok in this lab, take that into consideration when implementing in a production environment.       Navigate back to  Tenants -> useg-user{TNUM} -> Application Profiles -> base_EPG  and ensure that the  forwarding control proxy-arp box  is checked.      Step 2.  Create a VM-attribute based uSeg EPG under  Tenants -> useg-user{TNUM} -> Application Profiles -> uSeg_AP -> uSeg EPGs  by clicking on  Actions  in Work pane and choose  Create uSeg EPG    Name it  web_uSegEPG  Associate it with bridge domain  useg-user{TNUM}/uSeg_BD , which is the same bridge domain that the base EPG  base_EPG  is associated with.     Click on  NEXT  to move to the Domains configuration window. Associate it with VMM domain  CLBerlin2016 , which is the same VMM domain associated with the base EPG.  Deployment Immediacy:  Immediate  Resolution Immediacy:  Immediate       Click on  UPDATE  and then  FINISH  to complete the EPG configuration.    Step 3.  Click on  uSeg Attributes  under  web_uSegEPG . Click on the  Plus  signal on the right hand side to create a new filter.     In the pop up window, use the following parameters:   Match Any  Type : choose  VM Name  from dropdown menu  Operator : choose  Contains  from dropdown menu  Value :  web  Click on  Submit  to save the configuration      Step 4.  Verify endpoints under  web_uSegEPG   Click on  web_uSegEPG  in the Navagation pane, then click on  Operational  tab in the Work pane.  Verify that VMs  useg{TNUM}-vm-web1  and  useg{TNUM}-vm-web2  are shown as endpoints for the new VM attribute-based EPG.     (Optional) Verify that those two (2) web VM are no longer appear as endpoints under  base_EPG . MAC address of endpoints may stay in the base EPG for a while after they are moved into uSeg EPG.   Endpoints under  web_uSegEPG :   Endpoints under  base_EPG  after  web_uSegEPG  is created (MAC address of endpoints may stay in the base EPG for a while after they are moved into uSeg EPG).   Step 4.  Verify VM Port-group changes if any  Although we do not provide user access to vCenter in this lab, from the APIC GUI, you can verify the same from  Virtual Networking -> VMM Domains -> VMware -> CLBerlin2016 -> Controllers -> vcenter -> DVS - CLBerlin2016 -> Portgroups . You can use filter by your tenant name for easy access and validate the port group information from there.   Step 5.  Verify VM Connectivities  useg{TNUM}-vm-web1  :  {VM-WEB1-OOB}  [useg-user@useg{TNUM}-vm-web1 ~]# ping 10.10.10.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 10.10.10.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 20.20.20.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 20.20.20.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 30.30.30.11 -c 2 -t 1  useg{TNUM}-vm-web2  :  {VM-WEB2-OOB}  [useg-user@useg{TNUM}-vm-web2 ~]# ping 10.10.10.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 10.10.10.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 20.20.20.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 20.20.20.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 30.30.30.11 -c 2 -t 1   useg{TNUM}-vm-web1  and  useg{TNUM}-vm-web2  can ping each other as they are under the same uSeg EPG and  Intra-EPG Isolation  is not enabled. You may need to ping their gateway from both web VMs before they can ping each other (due to the fact the bridge domain is set to HA proxy mode)  useg{TNUM}-vm-web1  and  useg{TNUM}-vm-web2  can  not  ping the two app VMs and the bare metal server that remain in  base_EPG  as there is no contract configured between the two EPGs  useg{TNUM}-vm-web1  and  useg{TNUM}-vm-web2  can ping their default gateway IP  10.10.10.1   useg{TNUM}-vm-app1  :  {VM-APP1-OOB}  [useg-user@useg{TNUM}-vm-app1 ~]# ping 20.20.20.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 10.10.10.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 10.10.10.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 20.20.20.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 30.30.30.11 -c 2 -t 1  useg{TNUM}-vm-app2  :  {VM-APP2-OOB}  [useg-user@useg{TNUM}-vm-app2 ~]# ping 20.20.20.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 10.10.10.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 10.10.10.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 20.20.20.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 30.30.30.11 -c 2 -t 1   useg{TNUM}-vm-app1  and  useg{TNUM}-vm-app2  can not ping each other as they are still under the  base_EPG  and  Intra-EPG Isolation  is enabled.    useg{TNUM}-vm-app1  and  useg{TNUM}-vm-app2  can not ping  useg-bm-db  as they are still under the  base_EPG  and  Intra-EPG Isolation  is enabled.    useg{TNUM}-vm-app1  and  useg{TNUM}-vm-app2  can  not  ping the two web VMs that are moved into  web_uSegEPG  as there is no contract configured between the two EPGs  useg{TNUM}-vm-app1  and  useg{TNUM}-vm-app2  can ping their default gateway IP  20.20.20.1   This concludes the VM attribute based EPG feature test.",
            "title": "6. VM Attribute Based uSeg EPG Configuration"
        },
        {
            "location": "/lab1/#7-network-attribute-based-useg-epg",
            "text": "We will create an IP address based uSeg EPG named  app_uSegEPG  to host all endpoints that have IP address under IP subnet  20.20.20.0/24 .  Step 1.  Create a network attribute based uSeg EPG under  Tenants -> useg-user{TNUM} -> Application Profiles -> uSeg_AP -> uSeg EPGs  by clicking on  Actions  in Work pane and choose  Create uSeg EPG    Name it  app_uSegEPG  Associate it with bridge domain  useg-user{TNUM}/uSeg_BD , which is the same bridge domain that the base EPG  base_EPG  is associated with.     Click on  NEXT  to move to the Domains configuration window. Associate it with VMM domain  CLBerlin2016 , which is the same VMM domain associated with the base EPG.     Click on  UPDATE  and then  FINISH  to complete the EPG configuration.   Step 2.  Click on  uSeg Attributes  under  app_uSegEPG . Click on the  Plus  signal on the right hand side to create a new filter.     In the pop up window, use the following parameters:   Match Any  Type : choose  IP  from dropdown menu  Use EPG Subnet? :  No  Value :  20.20.20.0/24  Click on  Submit  to save the configuration      Step 3.  Verify endpoints under  app_uSegEPG   Click on  app_uSegEPG  in the Navagation pane, then click on  Operational  tab in the Work pane.  Verify that VMs  useg{TNUM}-vm-app1  and  useg{TNUM}-vm-app2  appear as endpoints for the new IP based EPG.  Some IP traffic must be seen by fabric before an endpoint can be classified into an IP based EPG. You may need to perform a ping to their gateway from both app VMs.      (Optional) Verify that those two (2) app VM are no longer shown as endpoints under  base_EPG . MAC address of endpoints may stay in the base EPG for a while after they are moved into uSeg EPG.   Endpoints under  app_uSegEPG   Endpoints under  base_EPG .   base_EPG  still have the Endpoints but they are mac learn while  app_uSegEPG  learns the Endpoints through their IPs.  Step 3.  Verify VM Port-group change if any  From the APIC GUI, you can verify the same from  VM Networking -> VMware -> cl-useg-dvs -> Controllers -> vcenter -> DVS - cl-useg-dvs -> Portgroups . You can use filter by your tenant name for easy access and validate the port group info from there.   Step 4.  Verify VM Connectivities  useg{TNUM}-vm-web1  :  {VM-WEB1-OOB}  [useg-user@useg{TNUM}-vm-web1 ~]# ping 10.10.10.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 10.10.10.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 20.20.20.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 20.20.20.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web1 ~]# ping 30.30.30.11 -c 2 -t 1  useg{TNUM}-vm-web2  :  {VM-WEB2-OOB}  [useg-user@useg{TNUM}-vm-web2 ~]# ping 10.10.10.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 10.10.10.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 20.20.20.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 20.20.20.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-web2 ~]# ping 30.30.30.11 -c 2 -t 1   useg{TNUM}-vm-web1  and  useg{TNUM}-vm-web2  can ping each other as they are under the same uSeg EPG and  Intra-EPG Isolation  is not enabled.  useg{TNUM}-vm-web1  and  useg{TNUM}-vm-web2  can not ping the two app VMs that are moved in  app_uSegEPG  as there is no contract configured between the two EPGs  useg{TNUM}-vm-web1  and  useg{TNUM}-vm-web2  can not ping the bare metal server that remain in  base_EPG  as there is no contract configured between the two EPGs  useg{TNUM}-vm-web1  and  useg{TNUM}-vm-web2  can ping their default gateway IP  10.10.10.1   useg{TNUM}-vm-app1  :  {VM-APP1-OOB}  [useg-user@useg{TNUM}-vm-app1 ~]# ping 20.20.20.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 10.10.10.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 10.10.10.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 20.20.20.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app1 ~]# ping 30.30.30.11 -c 2 -t 1  useg{TNUM}-vm-app2  :  {VM-APP2-OOB}  [useg-user@useg{TNUM}-vm-app2 ~]# ping 20.20.20.1 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 10.10.10.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 10.10.10.12 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 20.20.20.11 -c 2 -t 1\n[useg-user@useg{TNUM}-vm-app2 ~]# ping 30.30.30.11 -c 2 -t 1   useg{TNUM}-vm-app1  and  useg{TNUM}-vm-app2  can now ping each other as they are under the  app_uSegEPG  and  Intra-EPG Isolation  is disabled.  useg{TNUM}-vm-app1  and  useg{TNUM}-vm-app2  can not ping the two web VMs that are under  web_uSegEPG  as there is no contract configured between the two EPGs  useg{TNUM}-vm-app1  and  useg{TNUM}-vm-app2  can not ping the bare metal server that remain in  base_EPG  as there is no contract configured between the two EPGs  useg{TNUM}-vm-app1  and  useg{TNUM}-vm-app2  can ping their default gateway IP  20.20.20.1   Step 5.  Apply a contract between  web_uSegEPG  and  app_uSegEPG    To enable communication between  web_uSegEPG  and  app_uSegEPG , we will apply  common/default  contract.    Go to  Tenant -> useg-user{TNUM} -> Application Profiles -> uSeg_AP -> uSeg EPGs -> web_uSegEPG -> Contracts , Click on  Actions  in Work pane, and choose  Add Consumed Contract       Select  common/default  contract from the drop down list and click on  SUBMIT .    Go to  Tenant -> useg-user{TNUM} -> Application Profiles -> uSeg_AP -> uSeg EPGs -> app_uSegEPG -> Contracts , Click on  Actions  in Work pane, and choose  Add Provided Contract      Select  common/default  contract from the drop down list and click on  SUBMIT .   Step 6.  Verify VM Connectivity  useg{TNUM}-vm-web1  :  {VM-WEB1-OOB}  [useg-user@useg{TNUM}-vm-web1 ~]# ping 20.20.20.11  useg{TNUM}-vm-app1  :  {VM-APP1-OOB}  [useg-user@useg{TNUM}-vm-app1 ~]# ping 10.10.10.11 -c 2 -t 1   useg{TNUM}-vm-web1  and  useg{TNUM}-vm-app2  can now ping each other as the permit-any ( default  contract in ACI) contract has been applied between the two EPGs   This concludes the network attribute based EPG feature test.",
            "title": "7. Network Attribute Based uSeg EPG"
        },
        {
            "location": "/lab1/#8-hierarchal-matching-of-useg-attributes-using-orand-operator",
            "text": "You can configure uSeg EPGs with multiple attributes. However, VMs can become part of only one uSeg EPG. When a VM has attributes matching more than one uSeg EPG in the tenant, Cisco APIC puts the VM into a uSeg EPG based on filtering rules. Depending on how you define the attributes, you can use different filtering rules:    Matching any attribute - You can match any attribute, and Cisco APIC follows default precedence among attributes in deciding which uSeg EPG that a VM will join.    Matching all attributes - You can match all of the VM-based attributes defined for the uSeg EPG. You cannot match all for multiple network-based attributes.    Match-Any and Match-All operators are not supported for:   MAC Attribute  IP Attribute   We will add a second filter to  web_uSegEPG  using\nMatch-Any (Matching any attribute defined for a uSeg EPG is the default):   Match-Any  Type : choose  VM Name  from dropdown menu  Operator : choose  Contains  from dropdown menu  Value :  2  Click on  Submit  to save the configuration    Endpoints under  web_uSegEPG   In this case three VMs were moved to the  web_uSegEPG :   two VMs that matched the  VM Name  containing  web :  useg{TNUM}-vm-web1  and  useg{TNUM}-vm-web2  one VM that matched the  VM Name  containing  2 :  useg{TNUM}-vm-app2   We will modify the filter associated to  web_uSegEPG  using Match-All:   Match-All  Type : choose  VM Name  from dropdown menu  Operator : choose  Contains  from dropdown menu  Value :  2  Click on  Submit  to save the configuration    Endpoints under  web_uSegEPG   In this case only one VMs was moved to the  web_uSegEPG :  useg{TNUM}-vm-web2   one VM that matched the  VM Name  containing  2  and the  VM Name  containing  web .   Using Match-Any and Match-All you can create multiple statements to filter for multiple attributes, or you can create block, or nested, statements to create precise filtering rules.  The uSeg EPG precedence value used as uSeg match tie-breaker with OR/AND VM attributes.  This concludes the Hierarchal Matching of uSeg Attributes Using OR/AND Operator feature test.",
            "title": "8. Hierarchal Matching of uSeg Attributes Using OR/AND Operator"
        },
        {
            "location": "/lab1/#9-dns-attribute-based-useg-epg",
            "text": "DNS Attribute based uSeg carves uEPG based on Domain Name (DN) or FQDN.  APIC polls DNS server zone and retrieves all IPs and caches them locally.  The feature is still in beta at the time of this writing.  In this session we will use DNS attribute based uSeg to create usegs EPGs for the DB server.  Step 1.  Configure a DNS Server Group. Right click on the  action  button on the right hand side and select  Create DNS Server Group        In the pop up window, use the following parameters:   Accept the Agreeement  Name :  dns-group  DNS Servers :  172.21.208.194  Click on  Submit  to save the configuration      Step 2.  Configure a Domain. Click on the newly created  dns-group  and then click on the plus sign on the right hand side pane.          In the window, use the following parameters:   Domain Name :  aci.local  Click on  Update  to save the configuration     Step 3.  Create a DNS based uSeg EPG under  Tenants -> useg-user{TNUM} -> Application Profiles -> uSeg_AP -> uSeg EPGs  by clicking on  Actions  in Work pane and choose  Create uSeg EPG    Name it  db_uSegEPG  Associate it with bridge domain  useg-user{TNUM}/uSeg_BD , which is the same bridge domain that the base EPG  base_EPG  is associated with.     Click on  NEXT  to move to the Domains configuration window. Associate it with physical domain  useg-baremetal-phys .     Click on  UPDATE  and then  FINISH  to complete the EPG configuration.   Step 2.  Statically bind  site1-leaf1  and  site1-leaf2  to the  db_uSegEPG  clicking on  Static Leaf  under the  db_uSegEPG .    Step 3.  Click on  uSeg Attributes  under  db_uSegEPG . Click on the  Plus  signal on the right hand side to create a new filter.    In the pop up window, use the following parameters:   Match Any  Type : choose  DNS  from dropdown menu     Click on the magnify glass icon and select the following parameters:   DNS Zone DB :  aci.local  DNS Zone Entry :  useg-bm-db       Click on  Select  and then  Submit  to save the configuration.   Step 4.  Verify endpoints under  db_uSegEPG   Click on  db_uSegEPG  in the Navagation pane, then click on  Operational  tab in the Work pane.  Verify that   useg-bm-db  appear as endpoints for the new DNS based EPG.  Some IP traffic must be seen by fabric before an endpoint can be classified into an IP based EPG. You may need to perform a ping to their gateway.     Verify that the BM has the same VLAN encap.   Endpoints under  db_uSegEPG   Endpoints under  base_EPG .   base_EPG  still have the Endpoints but they are mac learn while  db_uSegEPG  learns the Endpoints through their IPs.  Step 5.  Verify VM Connectivities  useg{TNUM}-vm-web1  :  {VM-WEB1-OOB}  [useg-user@useg{TNUM}-vm-web1 ~]# ping 30.30.30.11 -c 2 -t 1  useg{TNUM}-vm-web2  :  {VM-WEB2-OOB}  [useg-user@useg{TNUM}-vm-web2 ~]# ping 30.30.30.11 -c 2 -t 1   useg{TNUM}-vm-web1  and  useg{TNUM}-vm-web2  can not ping  useg-bm-db  that are moved in  db_uSegEPG  as there is no contract configured between the two EPGs   useg{TNUM}-vm-app1  :  {VM-APP1-OOB}  [useg-user@useg{TNUM}-vm-app1 ~]# ping 30.30.30.11 -c 2 -t 1  useg{TNUM}-vm-app2  :  {VM-APP2-OOB}  [useg-user@useg{TNUM}-vm-app2 ~]# ping 30.30.30.11 -c 2 -t 1   useg{TNUM}-vm-app1  and  useg{TNUM}-vm-app2  can not ping   useg-bm-db  db server that are under  db_uSegEPG  as there is no contract configured between the two EPGs   Step 6.  Apply a contract between  app_uSegEPG  and  db_uSegEPG . Instead of creating a new contract and associating to  app_uSegEPG  and  db_uSegEPG  we will leverage a feature called contract inheritance to streamline associating contracts to new EPGs. The EPG inherits all the (provided and consumed) contracts associated directly to another EPG in the same tenant. Contract inheritance can be configured for application, microsegmented, L2Out, and L3Out EPGs.  With Release 3.x, you can also configure contract inheritance for Inter-EPG contracts, both provided and consumed. Inter-EPG contracts are supported on Cisco Nexus 9000 Series switches with EX or FX at the end of their model name or later models.  We want VMs belonging to  app_uSegEPG  to access  useg-bm-db  server but we dont want VMs from  web_uSegEPG  to have access to the database server.   Click on  db_uSegEPG  in the Navagation pane, then click on  Policy  ->  General  tab in the Work pane.     Scrown down to  EPG Contract Master  and click on the  Add  icon on the right top corner.  From the drop down menu choose:  Select AP :  uSeg_AP  Select EPG :  web_uSegEPG      Step 7.  Verify VM Connectivities  useg{TNUM}-vm-web1  :  {VM-WEB1-OOB}  [useg-user@useg{TNUM}-vm-web1 ~]# ping 30.30.30.11 -c 2 -t 1  useg{TNUM}-vm-web2  :  {VM-WEB2-OOB}  [useg-user@useg{TNUM}-vm-web2 ~]# ping 30.30.30.11 -c 2 -t 1   useg{TNUM}-vm-web1  and  useg{TNUM}-vm-web2  can not ping  useg-bm-db  that are moved in  db_uSegEPG  as there is no contract configured between the two EPGs   useg{TNUM}-vm-app1  :  {VM-APP1-OOB}  [useg-user@useg{TNUM}-vm-app1 ~]# ping 30.30.30.11 -c 2 -t 1  useg{TNUM}-vm-app2  :  {VM-APP2-OOB}  [useg-user@useg{TNUM}-vm-app2 ~]# ping 30.30.30.11 -c 2 -t 1   useg{TNUM}-vm-app1  and  useg{TNUM}-vm-app2  can ping   useg-bm-db  db server that is under  db_uSegEPG  because it inherites the contract from  web_uSegEPG .   This concludes the test with DNS based uSeg and contract inheritance.  Congratulations!  You have completed the MicrsoSegmentation WISP lab! Thank you for your time!  Back to Top",
            "title": "9. DNS Attribute Based uSeg EPG"
        },
        {
            "location": "/lab2/",
            "text": "Lab 2: Route to the legacy site\n\n\n\n\nIn this section, you will help ACME to configure routing between sd-wan remote sites and legacy none sd-wan site. The legacy site is connected to SP \npriviate1\n with OSPF as CE-PE protocol. Legacy site prefix \n10.11.1.0/24\n is advertised to \nprivate1\n PE router; DC WAN Edge routers are receiving this prefix from service side over BGP.\n\n\n\n\nTo make sure traffic between sd-wan remotes and legacy site use optimal path, ACME requires\n- SD-WAN site Remote2 uses DC as transit site to reach legacy site over private2.\n-  SD-WAN site Remote1 route directly over private 1 to legacy site.\n\n\n\n\nStep1: Verify current route\n\n\n\n\n\n\nSSH into ubuntu host in Remote1 and Remote2.\n|R1-VM1|198.18.133.200:19018|\n|---|---|\n|\nR1-WM1\n|\n198.18.133.200:19019\n|\n\n\n\n\n\n\nrun \ntraceroute 10.11.1.1\n from both hosts as show in below sreenshots\n\n\n\n\n\n\n\n\n\n\nAs show from the traceroute, ubuntu host from both remote sites are using DC1 as transit site to reach prefix \n10.11.1.0/24\n from legacy site.\n\n\nStep2: Route policy for Remote2\n\n\nThe requirement for remote2 is to use DC as transit site and use transport \nprivate2\n. To achieve that, you can modify the central policy created in \nlab1\n to set higher OMP preference for prefix \n10.11.1.0/24\n from color \nprivate2\n.\n- login vManage \n198.18.133.200\n and access policy configuration from \nConfiguration - Policies\n\n- Click \nCustom Options\n on the upper right corner and select \nLists\n under \nCentralized Policy\n as show below.\n\n\n\n- select \nPrefix\n and click \nNew Prefix List\n to add prefix \n10.11.1.0/24\n for legacy site as show below. Click \nAdd\n to save new prefix list \nLegacy_prefix\n .\n \n\n\n\n\nClick \nCustom Options\n on the upper right corner and select \nTopology\n under \nCentralized Policy\n.\n\n\nSelect Topology policy \nLAB_Topo_RS2\n created in lab1, and click the \n\"...\"\n to Edit.\n\n\nSelect \nRoute\n under \nSequence Type\n from the left.\n \n\n\nClick \nSequence Rule\n to add new rule. For omp route that matches \nLegacy_prefix\n and \nprivate2\n color, set \nPreference\n 200.\n \n\n ##### \n \nNote\n: After save, move the new created rule to the top by drag and drop the sequence number left to the rule. \n\n\nRun \ntraceroute 10.11.1.1\n again from Remote2 host and compare the path from previous output.\n \n\n\n\n\n#### Step3: Route policy for Remote1\n\n\nThe requirement for remote1 is to use \nprivate1\n route directly to legacy site. To achieve that, you can leak prefix \n10.11.1.0/24\n from VPN0 into service VPN.\n\n\nSP \nprivate1\n uses OSPF as PE-CE routing protocol; create OSPF feature template and attach to R1-WE1 VPN0.\n- login vManage \n198.18.133.200\n and access feature template from \nConfiguration - Template\n then click \nFeature\n\n- Click \nAdd Template\n and select OSPF template as show below.\n \n\n - Name the template: \nLab_OSPF_VPN0_V01\n\n - Assign Router ID: \n1.1.100.1\n\n \n\n - Add \nconnected\n as protocol under \nREDISTRIBUTE\n section\n \n\n - enable OSPF Area 0 on interface GigabitEthernet1\n \n\n- Access device template from \nConfiguration - Template\n then locate template \nLab_R1_V01\n. Click \n\"...\"\n for more option and select Edit.\n - Move to \nTransport & Management VPN\n section, Add \nCisco OSPF\n template and select \nLab_OSPF_VPN0_V01\n from dropdown list.\n \n \n\n- Update the device template and trigger vManage to update R1-VE1 configuration.\n- After vManage complete the push, SSH into \nR1-WE1\n to verify new OSPF neighbor and routes learned OSPF routes.\n \n\n \n\nConfigure route leaking between VPN0 and service VPN, so R1-WE1 will use the OSPF route learned from OSPF in VPN0 for prefix \n10.11.1.0/24\n\n- login vManage \n198.18.133.200\n and access feature template from \nConfiguration - Template\n then click \nFeature\n\n- Locate existing template \n\"Lab_Remote_VPN1_V01\"\n. Click \n\"...\"\n for more option and select Edit.\n - Move to \nGlobal Route Leak\n section. Add OSPF under \nAdd New Route Leak from Global VPN to Service VPN\n \n\n - Add connected under \nAdd New Route Leak from Service VPN to Global VPN\n \n\n \n \n\n - Update the template to trigger configuration push from vManage to R1-WE1\n\n\nNote: As optional task, you can add route policy to limit the routes being leaked between Global and service VPN\n\n- SSH into R1-WE1 to verify route \n10.10.101.0/24\nbeing added in global route table\n \n\n- SSH into R1-WE1 to verify route \n10.11.1.0/24\n being added in VRF 1 route table. The SP prefixes \n172.1.x.0\n are also leaked into service VPN which can be limited from additional route policy in previous step.\n \n\n- Now let's verify the new route path from remote1 Ubuntu host. Run \ntraceroute 10.11.1.1\n again from Remote1 host and compare the result from previous output.",
            "title": "Lab 2 Tasks"
        },
        {
            "location": "/lab2/#lab-2-route-to-the-legacy-site",
            "text": "In this section, you will help ACME to configure routing between sd-wan remote sites and legacy none sd-wan site. The legacy site is connected to SP  priviate1  with OSPF as CE-PE protocol. Legacy site prefix  10.11.1.0/24  is advertised to  private1  PE router; DC WAN Edge routers are receiving this prefix from service side over BGP.   To make sure traffic between sd-wan remotes and legacy site use optimal path, ACME requires\n- SD-WAN site Remote2 uses DC as transit site to reach legacy site over private2.\n-  SD-WAN site Remote1 route directly over private 1 to legacy site.",
            "title": "Lab 2: Route to the legacy site"
        },
        {
            "location": "/lab2/#step1-verify-current-route",
            "text": "SSH into ubuntu host in Remote1 and Remote2.\n|R1-VM1|198.18.133.200:19018|\n|---|---|\n| R1-WM1 | 198.18.133.200:19019 |    run  traceroute 10.11.1.1  from both hosts as show in below sreenshots      As show from the traceroute, ubuntu host from both remote sites are using DC1 as transit site to reach prefix  10.11.1.0/24  from legacy site.",
            "title": "Step1: Verify current route"
        },
        {
            "location": "/lab2/#step2-route-policy-for-remote2",
            "text": "The requirement for remote2 is to use DC as transit site and use transport  private2 . To achieve that, you can modify the central policy created in  lab1  to set higher OMP preference for prefix  10.11.1.0/24  from color  private2 .\n- login vManage  198.18.133.200  and access policy configuration from  Configuration - Policies \n- Click  Custom Options  on the upper right corner and select  Lists  under  Centralized Policy  as show below.  \n- select  Prefix  and click  New Prefix List  to add prefix  10.11.1.0/24  for legacy site as show below. Click  Add  to save new prefix list  Legacy_prefix  .\n    Click  Custom Options  on the upper right corner and select  Topology  under  Centralized Policy .  Select Topology policy  LAB_Topo_RS2  created in lab1, and click the  \"...\"  to Edit.  Select  Route  under  Sequence Type  from the left.\n   Click  Sequence Rule  to add new rule. For omp route that matches  Legacy_prefix  and  private2  color, set  Preference  200.\n  \n #####    Note : After save, move the new created rule to the top by drag and drop the sequence number left to the rule.   Run  traceroute 10.11.1.1  again from Remote2 host and compare the path from previous output.\n    #### Step3: Route policy for Remote1  The requirement for remote1 is to use  private1  route directly to legacy site. To achieve that, you can leak prefix  10.11.1.0/24  from VPN0 into service VPN.  SP  private1  uses OSPF as PE-CE routing protocol; create OSPF feature template and attach to R1-WE1 VPN0.\n- login vManage  198.18.133.200  and access feature template from  Configuration - Template  then click  Feature \n- Click  Add Template  and select OSPF template as show below.\n  \n - Name the template:  Lab_OSPF_VPN0_V01 \n - Assign Router ID:  1.1.100.1 \n  \n - Add  connected  as protocol under  REDISTRIBUTE  section\n  \n - enable OSPF Area 0 on interface GigabitEthernet1\n  \n- Access device template from  Configuration - Template  then locate template  Lab_R1_V01 . Click  \"...\"  for more option and select Edit.\n - Move to  Transport & Management VPN  section, Add  Cisco OSPF  template and select  Lab_OSPF_VPN0_V01  from dropdown list.\n    \n- Update the device template and trigger vManage to update R1-VE1 configuration.\n- After vManage complete the push, SSH into  R1-WE1  to verify new OSPF neighbor and routes learned OSPF routes.\n  \n  \nConfigure route leaking between VPN0 and service VPN, so R1-WE1 will use the OSPF route learned from OSPF in VPN0 for prefix  10.11.1.0/24 \n- login vManage  198.18.133.200  and access feature template from  Configuration - Template  then click  Feature \n- Locate existing template  \"Lab_Remote_VPN1_V01\" . Click  \"...\"  for more option and select Edit.\n - Move to  Global Route Leak  section. Add OSPF under  Add New Route Leak from Global VPN to Service VPN   \n - Add connected under  Add New Route Leak from Service VPN to Global VPN   \n    \n - Update the template to trigger configuration push from vManage to R1-WE1  Note: As optional task, you can add route policy to limit the routes being leaked between Global and service VPN \n- SSH into R1-WE1 to verify route  10.10.101.0/24 being added in global route table\n  \n- SSH into R1-WE1 to verify route  10.11.1.0/24  being added in VRF 1 route table. The SP prefixes  172.1.x.0  are also leaked into service VPN which can be limited from additional route policy in previous step.\n  \n- Now let's verify the new route path from remote1 Ubuntu host. Run  traceroute 10.11.1.1  again from Remote1 host and compare the result from previous output.",
            "title": "Step2: Route policy for Remote2"
        },
        {
            "location": "/lab3/",
            "text": "Lab 3: Performance Optimization\n\n\n\n\nIn this section, you will help ACME to optimize their SD-WAN fabric. You will perform the following tasks in this lab.\n\n\n\n\nAdd QoS and make sure consistent QoS policies are applied across the SD-WAN fabric.\n\n\nRegional hub has higher bandwidth on WAN circuits compare to remote sites. This bandwidth mismatch could potentially cause packet drops on remote sites. Configure the sd-wan fabric to prevent this potential issue.\n\n\nDue to the latency sensitive application requirement, a spoke to spoke tunnel is needed between remote sites. Configure the sd-wan fabric to build on-demand tunnel between remote sites.\n\n\nCloud Application (16.16.16.16) requires inspection services on all users. Configure IPSec tunnel to SIG provider for inspection services and configure the sd-wan fabric to route all traffic to this application over a IPSec tunnel.  \n\n\nACME wants to reduce the bandwidth consumption on private WAN links. Configure the sd-wan fabric to route public cloud and Internet traffic over local internet access.\n\n\nFor SaaS application, configure the sd-wan fabric to use either local DIA or RH based on application performance.\n\n\n\n\n\n\nTask 1: QoS\n\n\nEnabling QoS has three main steps: classification, marking and queueing. Queueing policy is configured as Localized policy and applied on interface level. classification and marking can be enabled over Localized policy or over centralized data policy. ACME requires consistent QoS policies across sd-wan fabric, you will use centralized data policy to achieve that.\n\n\nACME uses 4-class QoS model with the following policy requirements.\n\n\n\n\n\n\n\n\nClass\n\n\nApplications\n\n\nDSCP Value\n\n\nQueueing\n\n\n\n\n\n\n\n\n\n\nREALTIME\n\n\nrtp,webex,zoom\n\n\nEF\n\n\n30%\n\n\n\n\n\n\nSIGNALING\n\n\nrtcp,mgcp,sip\n\n\nCS3\n\n\n10%\n\n\n\n\n\n\nCRITICAL\n\n\nSSH,SNMP,SMB\n\n\nAF31\n\n\n40%\n\n\n\n\n\n\nDEFAULT\n\n\n\n\n0\n\n\n20%\n\n\n\n\n\n\n\n\nStep1.1: class map and applications\n\n\n\n\n\n\nlogin vManage \n198.18.133.200\n and access policy configuration from \nConfiguration - Policies\n\n\n\n\n\n\nClick \nCustom Options\n drop down on the top right and select \nLists\n under \nLocalized Policy\n\n \n  \n\n\n\n\nClick \nClass Map\n list type on the left and add \nNew Class List\n. In the pop up window enter \nREALTIME\n in Class filed, and select \n0\n from Queue dropdown.\n \n  \n\n\nAfter save \nREALTIME\n class, add following three classes.\n\n\nclass: \nSIGNALING\n  Queue: \n1\n\n\nclass: \nCRITICAL\n Queue: \n3\n\n\nclass: \nDEFAULT\n  Queue: \n2\n\n\n\n\n\n\nClick \nCustom Options\n drop down on the top right and select \nLists\n under \nCentralized Policy\n\n \n     \n\n\n\n\n\n\nClick \nApplication\n list type on the left and add \nNew Application List\n. In the application configure window enter \nREALTIME\n in Application List Name, and select \"\nRTP\n, \nWebEX\n, \nZoom\n\" from Application drop list.\n \n\n\n\n\nAfter same \"REALTIME\" Application, add following two Applications\n\n\nApplication List Name: \nSIGNALING\n Application: \nReal Time Control Protocol, Media Gateway Control Protocol, Session Initiation Protocol\n\n\nApplication List Name: \nCRITICAL\n Application: \nSecure Shell, SImple Network Management Protocol, SMB\n\n  \n\n\n\n\nStep1.2: Central Data Policy for classification\n\n\n\n\n\n\nlogin vManage \n198.18.133.200\n and access policy configuration from \nConfiguration - Policies\n\n\n\n\n\n\nClick \nCustom Options\n drop down on the top right and select \nTraffic Policy\n under \nCentralized Policy\n\n\n\n\n\n\nSelect \nTraffic Data\n and select \nCreate New\n from Add Policy drop list\n  \n\n\n\n\nConfigure the data policy to match on  application list,  assign to forwarding class and DSCP value as show below.\n  \n\n\nAfter \nSave Data Policy\n, go back to the \nCentralized Policy\n configuration and edit central policy \nLAB_Central_V01\n\n  \n\n\nClick \nTraffic Rules\n tab on the top then click \nTraffic Data\n and select \nImport Existing\n to add QoS data policy \nLab_QoS_v01\n\n  \n\n\nClick \nPolicy Application\n tab on the top then click \nTraffic Data\n to assign the qos data policy.\n\n\nTo have consistent QoS policy for the fabric, We will apply the QoS policy to all sites and all VPNs on service side as below screenshot.\n  \n\n\nClick \nAdd\n and \nSave Policy Changes\n then \nActive\n the updated central policy.   \n\n\n\n\nStep1.3: Local QoS queuing policy\n\n\n\n\n\n\nlogin vManage \n198.18.133.200\n and access policy configuration from \nConfiguration - Policies\n\n\n\n\n\n\nClick \nCustom Options\n drop down on the top right and select \nforwarding Class/QoS\n under \nLocalized Policy\n\n\n\n\n\n\nSelect \nQoS Map\n and select \nAdd QoS Map\n to create new queuing policy \nLab_QoS_Map_v01\n\n\n\n\nClick \nAdd Queue\n to add policy for \nSIGNALING\n class as show below.\n   \n\n\nClick \nAdd Queue\n to add policy for \nCRITICAL\n class as show below\n   \n   \n\n\nClick \nAdd Queue\n to add policy for \nDEFAULT\n class as show below\n    \n\n\nThe QoS queuing policy will look similar to screenshot below.\n\n\n\nAfter queuing policy is created, we create localized policy that includes the queueing policy.\n\n\n\n\nNote: To save time, We will only create local policy for remote sites in this lab.\n\n- Click \nLocalized Policy\n tab and \nAdd Policy\n\n- Click \nNext\n move to \nconfigure Forwarding Classes/QoS\n\n- Click \nAdd QoS Map\n drop down and select import existing. Search \nLab_QoS_Map_v01\n and Import.\n- Click next to pass ACL and route policy config. On Policy Overview, give a nme for the local policy and check \nApplication\n at the bottom from Policy Settings.\n\n\n\nStep1.4: Apply QoS queuing policy\n\n\nApplying QoS queuing policy is two step process, first you need to associate the localized policy to the device template, and next you need reference the queueing policy-map on transport interface.\n\n\n\n\nAccess template configuration from \nConfiguration - Templates\n\n\nUnder \nDevice\n template tab, locate template \nLab_R1_V01\n and select \nEdit\n\n\nAssociate \nLab_Remote_VPN1_V01\n localized policy to the template as show below\n\n\n\nClick \nUpdate\n to push the new localized policy configuration.\n\n\nRepeat the above steps for template \nLab_R2_V01\n\n\n\n\nNow you have the localized policy associated with device template for both remotes. Next you need reference the queueing policy on transport interfaces.\n\n\n\n\nAccess template configuration from \nConfiguration - Templates\n\n\nUnder \nFeature\n template tab, locate template \nLab_Remote_VPN0_Private1_v01\n and select \nEdit\n\n\nUnder ACL/QOS section, hardcode \nLab_QoS_Map_v01\n for QoS Map field.\n\n\n\nclick update to push configuration change.\n\n\nRepeat the above steps to update   \nLab_Remote_VPN0_Private2_V01\n and \nLab_Remote_VPN0_LTE_V01\n feature templates.\n\n\nAfter queuing policy is applied on both transport interfaces, you can verify the QoS policy from CLI using command \nshow policy-map interface\n\n\n\n\nR2-WE1#show policy-map interface GigabitEthernet 2\n GigabitEthernet2\n\n  Service-policy output: Lab_QoS_Map_v01\n\n    queue stats for all priority classes:\n      Queueing\n      priority level 1\n      queue limit 512 packets\n      (queue depth/total drops/no-buffer drops) 0/0/0\n      (pkts output/bytes output) 22647/6060238\n\n    Class-map: Queue0 (match-any)\n      22647 packets, 6060238 bytes\n      30 second offered rate 15000 bps, drop rate 0000 bps\n      Match: qos-group 0\n      police:\n          rate 30 %\n          rate 300000000 bps, burst 9375000 bytes\n        conformed 22647 packets, 6060238 bytes; actions:\n          transmit\n        exceeded 0 packets, 0 bytes; actions:\n          drop\n        conformed 15000 bps, exceeded 0000 bps\n      Priority: Strict, b/w exceed drops: 0\n\n      Priority Level: 1\n\n    Class-map: Queue1 (match-any)\n      0 packets, 0 bytes\n      30 second offered rate 0000 bps, drop rate 0000 bps\n      Match: qos-group 1\n      Queueing\n      queue limit 1041 packets\n      (queue depth/total drops/no-buffer drops) 0/0/0\n      (pkts output/bytes output) 0/0\n      bandwidth remaining ratio 10\n\n    Class-map: Queue3 (match-any)\n      10268 packets, 1197729 bytes\n      30 second offered rate 0000 bps, drop rate 0000 bps\n      Match: qos-group 3\n      Queueing\n      queue limit 1041 packets\n      (queue depth/total drops/no-buffer drops) 0/0/0\n      (pkts output/bytes output) 10268/1197729\n      bandwidth remaining ratio 40\n\n    Class-map: class-default (match-any)\n      15 packets, 1609 bytes\n      30 second offered rate 0000 bps, drop rate 0000 bps\n      Match: any\n      Queueing\n      queue limit 1041 packets\n      (queue depth/total drops/no-buffer drops) 0/0/0\n      (pkts output/bytes output) 15/1609\n      bandwidth remaining ratio 20\n        Exp-weight-constant: 9 (1/512)\n        Mean queue depth: 0 packets\n        class       Transmitted         Random drop      Tail drop          Minimum        Maximum     Mark\n                pkts/bytes            pkts/bytes       pkts/bytes          thresh         thresh     prob\n\n        0               1/349             0/0              0/0                260           520  1/10\n        1               0/0               0/0              0/0                292           520  1/10\n        2               0/0               0/0              0/0                325           520  1/10\n        3               0/0               0/0              0/0                357           520  1/10\n        4               0/0               0/0              0/0                390           520  1/10\n        5               0/0               0/0              0/0                422           520  1/10\n        6              14/1260            0/0              0/0                455           520  1/10\n        7               0/0               0/0              0/0                487           520  1/10\n\n\n\n\nTask 2: per-tunnel QoS\n\n\nIn this section, you will configure the RH WAN edge router (\nRH-WE1\n) to shape tunnel traffic to each remote. This per-tunnel QoS will make sure RH cannot send excessive traffic to remotes and overrun it.\n\n\nStep2.1: Configure QoS policy on RH\n\n\n\n\nIn taks 1, you have configured QoS policy on remote sites. Follow the same steps to configure QoS policy on RH \nRH-WE1\n.\n\n\nlogin vManage \n198.18.133.200\n and access policy configuration from \nConfiguration - Policies - Localized Policy\n\n\nCopy polocy \nLAB_Remote_Local_v01\n and name new policy \nLAB_RH_Local_v01\n.\n\n\nAccess template configuration from \nConfiguration - Templates\n\n\nLocate device template \nLab_RH_V01\n and attach localized policy \nLAB_RH_Local_v01\n to the device template.  \n\n\nUpdate following feature templates\n\n\nLab_RH_VPN0_Private1_v01\n\n\nLab_RH_VPN0_Private2_V01\n\n\nLab_RH_VPN0_LTE_V01\n  \n\n\n\n\n\n\nUnder ACL/QOS section, hardcode \nLab_QoS_Map_v01\n for QoS Map field.\n\n\n\n\nStep2.2: Configure Hub role on RH\n\n\n\n\nAccess template configuration from \nConfiguration - Templates\n\n\nUnder \nFeature\n template tab, locate template \nLab_RH_VPN0_Private1_v01\n and select \nEdit\n  \n\n\nIn \nTUNNEL\n section, configure the following\n\n\nselect \nOn\n for \nPer-tunnel QoS\n to enable per-tunnel QoS\n\n\nselect \nOn\n for \nPer-tunnel QoS Aggregator\n to set this as hub tunnel\n\n\nConfigure \nTunnel Bandwidth Percent\n to \n80\n to set maximum bandwidth usage for overlay traffic\n\n\n\n\n\n\n\n\nLocate feature template \nLab_RH_VPN0_Private2_V01\n, and select \nEdit\n  \n\n\nIn \nTUNNEL\n section, configure the following\n\n\nselect \nOn\n for \nPer-tunnel QoS\n to enable per-tunnel QoS\n\n\nselect \nOn\n for \nPer-tunnel QoS Aggregator\n to set this as hub tunnel\n\n\nConfigure \nTunnel Bandwidth Percent\n to \n80\n to set maximum bandwidth usage for overlay traffic  \n\n\n\n\nStep2.3: Configure Spoke role on Remotes\n\n\n\n\nAccess template configuration from \nConfiguration - Templates\n\n\nUnder \nFeature\n template tab, locate template \nLab_Remote_VPN0_Private1_v01\n and select \nEdit\n\n\nIn \nTUNNEL\n section, configure \nOn\n for \nPer-tunnel QoS\n to enable per-tunnel QoS. Since this is spoke, we will leave \nPer-tunnel QoS Aggregator\n off.\n  \n\n\nTo configure a device as spoke role, you will also need to configure the downstream bandwidth.\n\n\n\n\nspecify the downstream bandwidth to 10Mbps for remote1\n  \n\n\n\n\n\n\nlocate template \nLab_Remote_VPN0_Private2_v01\n and select \nEdit\n\n\n\n\nIn \nTUNNEL\n section, configure \nOn\n for \nPer-tunnel QoS\n to enable per-tunnel QoS. Since this is spoke, we will leave \nPer-tunnel QoS Aggregator\n off.\n    \n\n\nTo configure a device as spoke role, you will also need to configure the downstream bandwidth.\n\n\nspecify the downstream bandwidth to 10Mbps for remote1\n    \n  \n\n\n\n\nStep2.4: Verify per-tunnel QOS\n\n\nTo verify per-tunnel QoS is working as configured. SSH into \nRH-WE1\n and run the commands as show below\n\n\nRH-WE1#show platform software sdwan qos policy\n============ Session QoS Policy Database ============\npolicy              bandwidth     remaining-ratio template\nSDWANPolicy4210704  10000000      1               Lab_QoS_Map_v01\nSDWANPolicy4210705  20000000      2               Lab_QoS_Map_v01\n\n\n\n\n\nRH-WE1#show platform software sdwan qos target\n============ Session QoS Target Database ============\nsrc-addr                 dst-addr                 sport   dport   proto remote-tloc     dummy-intf            tunnel         policy                bandwidth\n172.1.7.2                172.1.8.2                12346   12346   IPSEC 1.1.100.1       SDWANSession4210704   Tunnel1        SDWANPolicy4210704    10000\n172.2.6.2                172.2.7.2                12346   12346   IPSEC 1.1.102.1       SDWANSession4210705   Tunnel2        SDWANPolicy4210705    20000\n\n\n\n\nTask 3: On-demand Tunnel\n\n\nHub and Spoke topology can reduce the CPU and memory usage on WAN Edge, but sometime a spoke to spoke tunnel is needed. Dynamic on-demand tunnel offers the benefits of having direct spoke to spoke tunnel while keep the low CPU and memory usage on WAN Edge.\n\n\nTo improve latency of traffic between remotes, configure dynamic on-demand tunnel between remote1 and remote2.\n\n\nStep3.1: Modify central control policy\n\n\nIn Lab1 you have created hub and spoke topology for both remote sites. In order to create dynamic on-demand tunnel between remotes, first you need modify the topology policy to include a \ntloc-action backup\n action.\n- login vManage \n198.18.133.200\n and access policy configuration from \nConfiguration - Policies\n\n\n\n\n\n\nClick \nCustom Options\n drop down on the top right and select \nTopology\n under \nCentralized Policy\n\n\n\n\n\n\nHighlight topology policy \nLAB_Topo_RS1\n and select \nEdit\n\n\n\n\nClick \nTLOC\n from \nSequence Type\n on the left\n\n\nClick \nSequence Rule\n to add a new rule; configure the rule to match on site list \nAll-Remotes\n, Actions \nAccept\n. \nSave Match And Actions\n to add this new rule.\n    \n\n\nClick \nRoute\n from \nSequence Type\n on the left\n    \n\n\nClick \nSequence Rule\n to add a new rule; configure the rule to match on site list \nAll-Remotes\n, Actions TLOC list \nRH-Tlocs\n and TLOC Action \nBackup\n.\n    \n\n\nAfter \nSave Match and And Actions\n, drag and drop the newly created rule to seq # 1.\n  \n\n\nFollow the same steps to modify topology policy \nLAB_Topo_RS2\n.\n\n\n\n\nStep3.2: Configure On-demand Tunnel\n\n\nEnable Traffic Engineering service on RH to allow RH becomes backup path.\n- Access template configuration from \nConfiguration - Templates\n\n- Under \nFeature\n template tab, locate template \nLab_RH_VPN0_v01\n and select \nEdit\n\n- In \nSERVICE\n section, add \nTE\n from service type drop down, and add it to this feature template.\n  \n\n- Update and push configure change.\n\n\nOn remote sites, R1-WE1 and R2-WE2, enable on-demand on system template.\n-  Under \nFeature\n template tab, locate template \nLab_System_V01\n and select \nCopy\n\n- Name new system template \nLab_Remote_System_V01\n\n- Edit \nLab_Remote_System_V01\n to enable \nOn-demand Tunnel\n\n  \n\n- locate device template \nLab_R1_V01\n and change system template to \nLab_Remote_System_V01\n\n    \n\n    update and push configuration change.\n- locate device template \nLab_R2_V01\n and change system template to \nLab_Remote_System_V01\n. update and push configuration change.\n\n\nStep3.3: Verify On-demand Tunnel between remotes\n\n\nYou can verify the dynamic tunnel between remotes from vManage.\n- login vManage \n198.18.133.200\n and access \nMonitor - Network\n\n- select WAN-Edge \nR1-WE1\n\n    \n\n- Click \nReal Time\n and type in \non demand local\n in \nDevice Options\n filed\n    \n\n- The output shows local on demand tunnel is enabled and status is active.\n    \n\n- type in \non demand remote\n in \nDevice Options\n filed  \n\n- the output shows remote on demand tunnel to remote2 \n1.1.102.1\n is enabled and tunnel status is \ninactive\n\n    \n\n- Dynamic on demand tunnel is triggered by traffic between the local and remote sites. That's why you see status of on demand remote is inactive. Let's generate bi-directional traffic between remote1 and remote2 to trigger on demand tunnel.\n- ssh into \nR1-VM1\n, and type \nssh 10.10.102.10\n to login \nR2-VM2\n with credential \nviptela/viptela\n\n\nWelcome to Ubuntu 16.04.2 LTS (GNU/Linux 4.8.0-36-generic x86_64)\n\n * Documentation:  https://help.ubuntu.com\n * Management:     https://landscape.canonical.com\n * Support:        https://ubuntu.com/advantage\n689 packages can be updated.\n475 updates are security updates.\nLast login: Mon Feb  8 09:22:21 2021 from 10.16.22.163\nviptela@remote1_ubuntu:~$ ssh 10.10.102.10\nviptela@10.10.102.10's password:\nWelcome to Ubuntu 16.04.2 LTS (GNU/Linux 4.8.0-36-generic x86_64)\n\n * Documentation:  https://help.ubuntu.com\n * Management:     https://landscape.canonical.com\n * Support:        https://ubuntu.com/advantage\n711 packages can be updated.\n521 updates are security updates.\nLast login: Mon Feb  8 09:25:00 2021 from 10.10.101.10\nviptela@remote2_ubuntu:~$\n\n\n\n\n\n\nGo back to \nvManage - Monitor - Network - R1-WE1 - Real time\n and type in \non demand remote\n in \nDevice Options\n filed.\n\n\nverify the tunnel status for on demand tunnel to remote2 \n1.1.102.1\n changes \nactive\n    \n\n\n\n\n\n\nTask 4: IPsec tunnel to SIG\n\n\nInspection service is required for traffic to cloud application with IP \n16.16.16.16\n. Configure remote1 and remote2 to build an IPSec tunnel to SIG provider. Route all traffic to \n16.16.16.16\n for inspection.\n\n\nStep4.1 : Manual IPSec tunnel to SIG\n\n\nBefore configuring the IPSec tunnel, verify the connectivity to Cloud application at \n16.16.16.16\n from remote ubuntu hosts. It is expected to see the application is not reachable.\n\n\n\nviptela@remote1_ubuntu:~$ ping 16.16.16.16\nPING 16.16.16.16 (16.16.16.16) 56(84) bytes of data.\n\n\n\n\n\nConfigure IPSec tunnel on remote1 and remote2 to match the pre-configured tunnel at SIG provider.\n\n\n\n\n\n\n\n\nsite\n\n\ntunnel IP\n\n\ntunnel source\n\n\ntunnel destination\n\n\nIKE version\n\n\npre-share key\n\n\n\n\n\n\n\n\n\n\nRemote1\n\n\n172.4.101.1/24\n\n\nGigabitEthernet2\n\n\n172.3.2.2\n\n\nIKE v1\n\n\ncisco123\n\n\n\n\n\n\nRemote2\n\n\n172.4.102.1/24\n\n\nGigabitEthernet2\n\n\n172.3.2.2\n\n\nIKE v1\n\n\ncisco123\n\n\n\n\n\n\n\n\nIsakmp policy\n\n\nencryption algorithm:   AES - Advanced Encryption Standard (256 bit keys).\nhash algorithm:         Secure Hash Standard\nauthentication method:  Pre-Shared Key\nDiffie-Hellman group:   #16 (4096 bit)\nlifetime:               14400 seconds, no volume limit\n\n\n\n\nIPSec policy\n\n\nSecurity association lifetime:3600 seconds\nPFS (Y/N): Y\nDH group:  group16\nMixed-mode : Disabled\nTransform sets=esp-aes esp-sha-hmac\nAntireplay window size = 512\n\n\n\n\n\n\nlogin vManage \n198.18.133.200\n and access template configuration from \nConfiguration - Templates - Feature\n\n\nAdd new IPsec interface feature template as show below\n \n\n\nConfigure the template with following fields and leave other fields as default value\n|filed name|value|\n|---|---|\n|Template Name|Lab_IPsec_Int_V01|\n|Description|Lab_IPsec_Int_V01|\n|Shutdown|No|\n|Interface Name|ipsec1|\n|IPv4 address|ipsec_tun_ip|\n|source|Interface|\n|IPsec Source Interface|GigabitEthernet2|\n|IPsec Destination IP Address|172.3.2.2|\n|Preshared Key|cisco123|\n\n\n\n\n\n\n\n\nAdd tunnel feature template \nLab_IPsec_Int_V01\n to device template \nLab_R1_V01\n and \nLab_R2_V01\n\n\nLocate device template \nLab_R1_V01\n click Edit\n\n\nAdd \nLab_IPsec_Int_V01\n under VPN0\n \n\n\nclick save to update and filed in \n172.4.101.1/24\n for tunnel IP Address\n \n\n\nLocate device template \nLab_R2_V01\n click Edit\n\n\nAdd \nLab_IPsec_Int_V01\n under VPN0\n\n\nclick save to update and filed in \n172.4.102.1/24\n for tunnel IP Address\n \n\n\nThe ipsec tunnel will be \nUP\n on both remote sites. You can verify the tunnel status from \nshow ip interface brief\n\n\n\n\nR2-WE1#sh ip int b\nInterface              IP-Address      OK? Method Status                Protocol\nGigabitEthernet1       172.2.7.2       YES other  up                    up\nGigabitEthernet2       172.3.9.7       YES DHCP   up                    up\nGigabitEthernet3       unassigned      YES other  down                  down\nGigabitEthernet4       10.10.102.1     YES other  up                    up\nGigabitEthernet5       unassigned      YES other  down                  down\nGigabitEthernet6       unassigned      YES other  down                  down\nGigabitEthernet7       unassigned      YES other  down                  down\nGigabitEthernet8       192.168.150.19  YES other  up                    up\nSdwan-system-intf      1.1.102.1       YES unset  up                    up\nLoopback65528          192.168.1.1     YES other  up                    up\nNVI0                   unassigned      YES unset  up                    up\nTunnel1                172.2.7.2       YES TFTP   up                    up\nTunnel2                172.3.9.7       YES TFTP   up                    up\nTunnel100001           172.4.102.1     YES other  up                    up\nR2-WE1#\n\n\n\n\nR1-WE1#sh ip int b\nInterface              IP-Address      OK? Method Status                Protocol\nGigabitEthernet1       172.1.8.2       YES other  up                    up\nGigabitEthernet2       172.3.8.7       YES DHCP   up                    up\nGigabitEthernet3       10.10.101.1     YES other  up                    up\nGigabitEthernet4       unassigned      YES other  down                  down\nGigabitEthernet5       unassigned      YES other  down                  down\nGigabitEthernet6       unassigned      YES other  down                  down\nGigabitEthernet7       unassigned      YES other  down                  down\nGigabitEthernet8       192.168.150.16  YES other  up                    up\nSdwan-system-intf      1.1.100.1       YES unset  up                    up\nLoopback65528          192.168.1.1     YES other  up                    up\nNVI0                   unassigned      YES unset  up                    up\nTunnel1                172.1.8.2       YES TFTP   up                    up\nTunnel2                172.3.8.7       YES TFTP   up                    up\nTunnel100001           172.4.101.1     YES other  up                    up\nR1-WE1#\n\n\n\n\n\n\nNext you need to route all traffic to cloud application \n16.16.16.16\n to the tunnel.\n\n\nlocate feature template \nLab_Remote_VPN1_V01\n and edit\n\n\nIn \nIPSEC ROUTE\n section, add \nNew IPSEC Route\n with prefix \n16.16.16.16/32\n interface \nipsec1\n\n\n\n\n\n\n\n\nclick update to push configure change to both remote sites.\n\n\n\n\nStep4.2 : verify SIG tunnel\n\n\n\n\n\n\nVNC login \nR1-VM1\n and \nR2-VM1\n with credential \nviptela\n\n\n\n\n\n\nverify that you can ping \n16.16.16.16\n from the VM\n  \n\n\n\n\nnow try access \n16.16.16.16\n from browser. You should see this login page\n  \n\n\n\n\nTask 5: DIA\n\n\nThere are two options to enable DIA.\n- option 1: NAT DIA Route\n\n\n\nIn this option, a NAT route is configured under service VPN. You can direct local internet traffic from service VPN to transport VPN.\n- option 2: Centralized data policy\n  \n\n\nIn this option, a centralized policy is applied to service side traffic based on ip prefixes, a match will redirect to transport VPN. Traffic that doesnt match the policy will stay in service VPN and route over IPSec tunnel.\n\n\n\nIn this task, you are going to configure DIA on remote sites using option 2.       \n\n\nTask 6: CoR for SaaS\n\n\nInstead of using the DIA exit point as configured in previous task, for SaaS application box and salesforce, ACME wants to use the most optimal path. Configure the remote sites to dynamically chose local DIA or regional hub as exit point for box and salesforce based on application performance.\n  \n\n\nStep6.1 Enable Cloud OnRamp for SaaS\n\n\n\n\nlogin vManage \n198.18.133.200\n and access \nAdministration - Settings\n\n\nEdit \nCloud onRamp for SaaS\n and check \nEnabled\n\n  \n\n\n\n\nStep6.2 Add SaaS application\n\n\n\n\nAccess CoR SaaS configuration via \nConfiguration - Cloud onRamp for SaaS\n  \n\n\n\n\nFrom \nManage Cloud OnRamp for SaaS\n dropdown, select \nApplications and Policy\n\n  \n\n\n\n\n\n\nSelect \nBox\n and \nSalesforce\n from the application list; Select \nEnabled\n for Monitoring dropdown list; Enter \n1\n for VPN; Select \nEnabled\n for Policy/Cloud SLA dropdown list.\n\n\n\n\n\n\n\n- Cloud OnRamp for SaaS uses existing AAR policy, we will keep the system created policy for SaaS. Click \nSave Policy\n to proceed the policy update.\n  \n\n\nStep6.3 Add sites\n\n\nYou are going to configure remote sites as DIA site, and Regional hub as gateway site. Remote sites will monitor the QoE score for local DIA via LTE transport, and also the QoE score for gateway site.\n- Access CoR SaaS configuration via \nConfiguration - Cloud onRamp for SaaS\n\n- Click \nManage Cloud OnRamp for SaaS\n dropdown list on the upper left, and select \nGateway\n\n  \n\n- Click \nAttach Gateways\n,  select \nRH-WE1\n and move it to \nselected Sites\n. Click \nAdd interfaces to selected sites\n.\n  \n\n- In the pop up window, under \nInterface\n field select interface \nGigabitEthernet4\n from the list. This will allow gateway site sends\n\n\n\n- Click \nManage Cloud OnRamp for SaaS\n dropdown list on the upper left, and select \nDIA Sites\n\n   \n\n- select \nAttach DIA Sites\n, select \nR1-WE1\n and \nR2-WE1\n and move it to \nselected Sites\n.     \n\n\n  \n\n\nStep6.4 Verify CoR SaaS\n\n\nClick \nManage Cloud OnRamp for SaaS\n to verify QoE status, DIA status, exit interface on each WAN Edge for SaaS application.  \n\n\n\n\nNote: Your output may not match the screenshot on the vQoE score and DIA Status. This is expected.\n\n- screenshot above shows both remote sites are using local DIA as exit point for box and Salesfoce SaaS application.\n- This lab doesn't have traffic impairment tool, we can't increase remote transport's latency or drop to trigger SaaS changes exit point. But if you keep checking the SaaS status, you will notice the vQoE score changes and exit interface changes.\n   \n\n\n\n\nCongratulation! You have completed the whole lab.",
            "title": "Lab 3 Tasks"
        },
        {
            "location": "/lab3/#lab-3-performance-optimization",
            "text": "In this section, you will help ACME to optimize their SD-WAN fabric. You will perform the following tasks in this lab.   Add QoS and make sure consistent QoS policies are applied across the SD-WAN fabric.  Regional hub has higher bandwidth on WAN circuits compare to remote sites. This bandwidth mismatch could potentially cause packet drops on remote sites. Configure the sd-wan fabric to prevent this potential issue.  Due to the latency sensitive application requirement, a spoke to spoke tunnel is needed between remote sites. Configure the sd-wan fabric to build on-demand tunnel between remote sites.  Cloud Application (16.16.16.16) requires inspection services on all users. Configure IPSec tunnel to SIG provider for inspection services and configure the sd-wan fabric to route all traffic to this application over a IPSec tunnel.    ACME wants to reduce the bandwidth consumption on private WAN links. Configure the sd-wan fabric to route public cloud and Internet traffic over local internet access.  For SaaS application, configure the sd-wan fabric to use either local DIA or RH based on application performance.",
            "title": "Lab 3: Performance Optimization"
        },
        {
            "location": "/lab3/#task-1-qos",
            "text": "Enabling QoS has three main steps: classification, marking and queueing. Queueing policy is configured as Localized policy and applied on interface level. classification and marking can be enabled over Localized policy or over centralized data policy. ACME requires consistent QoS policies across sd-wan fabric, you will use centralized data policy to achieve that.  ACME uses 4-class QoS model with the following policy requirements.     Class  Applications  DSCP Value  Queueing      REALTIME  rtp,webex,zoom  EF  30%    SIGNALING  rtcp,mgcp,sip  CS3  10%    CRITICAL  SSH,SNMP,SMB  AF31  40%    DEFAULT   0  20%",
            "title": "Task 1: QoS"
        },
        {
            "location": "/lab3/#step11-class-map-and-applications",
            "text": "login vManage  198.18.133.200  and access policy configuration from  Configuration - Policies    Click  Custom Options  drop down on the top right and select  Lists  under  Localized Policy \n       Click  Class Map  list type on the left and add  New Class List . In the pop up window enter  REALTIME  in Class filed, and select  0  from Queue dropdown.\n      After save  REALTIME  class, add following three classes.  class:  SIGNALING   Queue:  1  class:  CRITICAL  Queue:  3  class:  DEFAULT   Queue:  2    Click  Custom Options  drop down on the top right and select  Lists  under  Centralized Policy \n           Click  Application  list type on the left and add  New Application List . In the application configure window enter  REALTIME  in Application List Name, and select \" RTP ,  WebEX ,  Zoom \" from Application drop list.\n    After same \"REALTIME\" Application, add following two Applications  Application List Name:  SIGNALING  Application:  Real Time Control Protocol, Media Gateway Control Protocol, Session Initiation Protocol  Application List Name:  CRITICAL  Application:  Secure Shell, SImple Network Management Protocol, SMB",
            "title": "Step1.1: class map and applications"
        },
        {
            "location": "/lab3/#step12-central-data-policy-for-classification",
            "text": "login vManage  198.18.133.200  and access policy configuration from  Configuration - Policies    Click  Custom Options  drop down on the top right and select  Traffic Policy  under  Centralized Policy    Select  Traffic Data  and select  Create New  from Add Policy drop list\n     Configure the data policy to match on  application list,  assign to forwarding class and DSCP value as show below.\n    After  Save Data Policy , go back to the  Centralized Policy  configuration and edit central policy  LAB_Central_V01 \n    Click  Traffic Rules  tab on the top then click  Traffic Data  and select  Import Existing  to add QoS data policy  Lab_QoS_v01 \n    Click  Policy Application  tab on the top then click  Traffic Data  to assign the qos data policy.  To have consistent QoS policy for the fabric, We will apply the QoS policy to all sites and all VPNs on service side as below screenshot.\n    Click  Add  and  Save Policy Changes  then  Active  the updated central policy.",
            "title": "Step1.2: Central Data Policy for classification"
        },
        {
            "location": "/lab3/#step13-local-qos-queuing-policy",
            "text": "login vManage  198.18.133.200  and access policy configuration from  Configuration - Policies    Click  Custom Options  drop down on the top right and select  forwarding Class/QoS  under  Localized Policy    Select  QoS Map  and select  Add QoS Map  to create new queuing policy  Lab_QoS_Map_v01   Click  Add Queue  to add policy for  SIGNALING  class as show below.\n     Click  Add Queue  to add policy for  CRITICAL  class as show below\n         Click  Add Queue  to add policy for  DEFAULT  class as show below\n      The QoS queuing policy will look similar to screenshot below.  After queuing policy is created, we create localized policy that includes the queueing policy.   Note: To save time, We will only create local policy for remote sites in this lab. \n- Click  Localized Policy  tab and  Add Policy \n- Click  Next  move to  configure Forwarding Classes/QoS \n- Click  Add QoS Map  drop down and select import existing. Search  Lab_QoS_Map_v01  and Import.\n- Click next to pass ACL and route policy config. On Policy Overview, give a nme for the local policy and check  Application  at the bottom from Policy Settings.",
            "title": "Step1.3: Local QoS queuing policy"
        },
        {
            "location": "/lab3/#step14-apply-qos-queuing-policy",
            "text": "Applying QoS queuing policy is two step process, first you need to associate the localized policy to the device template, and next you need reference the queueing policy-map on transport interface.   Access template configuration from  Configuration - Templates  Under  Device  template tab, locate template  Lab_R1_V01  and select  Edit  Associate  Lab_Remote_VPN1_V01  localized policy to the template as show below  Click  Update  to push the new localized policy configuration.  Repeat the above steps for template  Lab_R2_V01   Now you have the localized policy associated with device template for both remotes. Next you need reference the queueing policy on transport interfaces.   Access template configuration from  Configuration - Templates  Under  Feature  template tab, locate template  Lab_Remote_VPN0_Private1_v01  and select  Edit  Under ACL/QOS section, hardcode  Lab_QoS_Map_v01  for QoS Map field.  click update to push configuration change.  Repeat the above steps to update    Lab_Remote_VPN0_Private2_V01  and  Lab_Remote_VPN0_LTE_V01  feature templates.  After queuing policy is applied on both transport interfaces, you can verify the QoS policy from CLI using command  show policy-map interface   R2-WE1#show policy-map interface GigabitEthernet 2\n GigabitEthernet2\n\n  Service-policy output: Lab_QoS_Map_v01\n\n    queue stats for all priority classes:\n      Queueing\n      priority level 1\n      queue limit 512 packets\n      (queue depth/total drops/no-buffer drops) 0/0/0\n      (pkts output/bytes output) 22647/6060238\n\n    Class-map: Queue0 (match-any)\n      22647 packets, 6060238 bytes\n      30 second offered rate 15000 bps, drop rate 0000 bps\n      Match: qos-group 0\n      police:\n          rate 30 %\n          rate 300000000 bps, burst 9375000 bytes\n        conformed 22647 packets, 6060238 bytes; actions:\n          transmit\n        exceeded 0 packets, 0 bytes; actions:\n          drop\n        conformed 15000 bps, exceeded 0000 bps\n      Priority: Strict, b/w exceed drops: 0\n\n      Priority Level: 1\n\n    Class-map: Queue1 (match-any)\n      0 packets, 0 bytes\n      30 second offered rate 0000 bps, drop rate 0000 bps\n      Match: qos-group 1\n      Queueing\n      queue limit 1041 packets\n      (queue depth/total drops/no-buffer drops) 0/0/0\n      (pkts output/bytes output) 0/0\n      bandwidth remaining ratio 10\n\n    Class-map: Queue3 (match-any)\n      10268 packets, 1197729 bytes\n      30 second offered rate 0000 bps, drop rate 0000 bps\n      Match: qos-group 3\n      Queueing\n      queue limit 1041 packets\n      (queue depth/total drops/no-buffer drops) 0/0/0\n      (pkts output/bytes output) 10268/1197729\n      bandwidth remaining ratio 40\n\n    Class-map: class-default (match-any)\n      15 packets, 1609 bytes\n      30 second offered rate 0000 bps, drop rate 0000 bps\n      Match: any\n      Queueing\n      queue limit 1041 packets\n      (queue depth/total drops/no-buffer drops) 0/0/0\n      (pkts output/bytes output) 15/1609\n      bandwidth remaining ratio 20\n        Exp-weight-constant: 9 (1/512)\n        Mean queue depth: 0 packets\n        class       Transmitted         Random drop      Tail drop          Minimum        Maximum     Mark\n                pkts/bytes            pkts/bytes       pkts/bytes          thresh         thresh     prob\n\n        0               1/349             0/0              0/0                260           520  1/10\n        1               0/0               0/0              0/0                292           520  1/10\n        2               0/0               0/0              0/0                325           520  1/10\n        3               0/0               0/0              0/0                357           520  1/10\n        4               0/0               0/0              0/0                390           520  1/10\n        5               0/0               0/0              0/0                422           520  1/10\n        6              14/1260            0/0              0/0                455           520  1/10\n        7               0/0               0/0              0/0                487           520  1/10",
            "title": "Step1.4: Apply QoS queuing policy"
        },
        {
            "location": "/lab3/#task-2-per-tunnel-qos",
            "text": "In this section, you will configure the RH WAN edge router ( RH-WE1 ) to shape tunnel traffic to each remote. This per-tunnel QoS will make sure RH cannot send excessive traffic to remotes and overrun it.",
            "title": "Task 2: per-tunnel QoS"
        },
        {
            "location": "/lab3/#step21-configure-qos-policy-on-rh",
            "text": "In taks 1, you have configured QoS policy on remote sites. Follow the same steps to configure QoS policy on RH  RH-WE1 .  login vManage  198.18.133.200  and access policy configuration from  Configuration - Policies - Localized Policy  Copy polocy  LAB_Remote_Local_v01  and name new policy  LAB_RH_Local_v01 .  Access template configuration from  Configuration - Templates  Locate device template  Lab_RH_V01  and attach localized policy  LAB_RH_Local_v01  to the device template.    Update following feature templates  Lab_RH_VPN0_Private1_v01  Lab_RH_VPN0_Private2_V01  Lab_RH_VPN0_LTE_V01       Under ACL/QOS section, hardcode  Lab_QoS_Map_v01  for QoS Map field.",
            "title": "Step2.1: Configure QoS policy on RH"
        },
        {
            "location": "/lab3/#step22-configure-hub-role-on-rh",
            "text": "Access template configuration from  Configuration - Templates  Under  Feature  template tab, locate template  Lab_RH_VPN0_Private1_v01  and select  Edit     In  TUNNEL  section, configure the following  select  On  for  Per-tunnel QoS  to enable per-tunnel QoS  select  On  for  Per-tunnel QoS Aggregator  to set this as hub tunnel  Configure  Tunnel Bandwidth Percent  to  80  to set maximum bandwidth usage for overlay traffic     Locate feature template  Lab_RH_VPN0_Private2_V01 , and select  Edit     In  TUNNEL  section, configure the following  select  On  for  Per-tunnel QoS  to enable per-tunnel QoS  select  On  for  Per-tunnel QoS Aggregator  to set this as hub tunnel  Configure  Tunnel Bandwidth Percent  to  80  to set maximum bandwidth usage for overlay traffic",
            "title": "Step2.2: Configure Hub role on RH"
        },
        {
            "location": "/lab3/#step23-configure-spoke-role-on-remotes",
            "text": "Access template configuration from  Configuration - Templates  Under  Feature  template tab, locate template  Lab_Remote_VPN0_Private1_v01  and select  Edit  In  TUNNEL  section, configure  On  for  Per-tunnel QoS  to enable per-tunnel QoS. Since this is spoke, we will leave  Per-tunnel QoS Aggregator  off.\n    To configure a device as spoke role, you will also need to configure the downstream bandwidth.   specify the downstream bandwidth to 10Mbps for remote1\n      locate template  Lab_Remote_VPN0_Private2_v01  and select  Edit   In  TUNNEL  section, configure  On  for  Per-tunnel QoS  to enable per-tunnel QoS. Since this is spoke, we will leave  Per-tunnel QoS Aggregator  off.\n      To configure a device as spoke role, you will also need to configure the downstream bandwidth.  specify the downstream bandwidth to 10Mbps for remote1",
            "title": "Step2.3: Configure Spoke role on Remotes"
        },
        {
            "location": "/lab3/#step24-verify-per-tunnel-qos",
            "text": "To verify per-tunnel QoS is working as configured. SSH into  RH-WE1  and run the commands as show below  RH-WE1#show platform software sdwan qos policy\n============ Session QoS Policy Database ============\npolicy              bandwidth     remaining-ratio template\nSDWANPolicy4210704  10000000      1               Lab_QoS_Map_v01\nSDWANPolicy4210705  20000000      2               Lab_QoS_Map_v01  RH-WE1#show platform software sdwan qos target\n============ Session QoS Target Database ============\nsrc-addr                 dst-addr                 sport   dport   proto remote-tloc     dummy-intf            tunnel         policy                bandwidth\n172.1.7.2                172.1.8.2                12346   12346   IPSEC 1.1.100.1       SDWANSession4210704   Tunnel1        SDWANPolicy4210704    10000\n172.2.6.2                172.2.7.2                12346   12346   IPSEC 1.1.102.1       SDWANSession4210705   Tunnel2        SDWANPolicy4210705    20000",
            "title": "Step2.4: Verify per-tunnel QOS"
        },
        {
            "location": "/lab3/#task-3-on-demand-tunnel",
            "text": "Hub and Spoke topology can reduce the CPU and memory usage on WAN Edge, but sometime a spoke to spoke tunnel is needed. Dynamic on-demand tunnel offers the benefits of having direct spoke to spoke tunnel while keep the low CPU and memory usage on WAN Edge.  To improve latency of traffic between remotes, configure dynamic on-demand tunnel between remote1 and remote2.",
            "title": "Task 3: On-demand Tunnel"
        },
        {
            "location": "/lab3/#step31-modify-central-control-policy",
            "text": "In Lab1 you have created hub and spoke topology for both remote sites. In order to create dynamic on-demand tunnel between remotes, first you need modify the topology policy to include a  tloc-action backup  action.\n- login vManage  198.18.133.200  and access policy configuration from  Configuration - Policies    Click  Custom Options  drop down on the top right and select  Topology  under  Centralized Policy    Highlight topology policy  LAB_Topo_RS1  and select  Edit   Click  TLOC  from  Sequence Type  on the left  Click  Sequence Rule  to add a new rule; configure the rule to match on site list  All-Remotes , Actions  Accept .  Save Match And Actions  to add this new rule.\n      Click  Route  from  Sequence Type  on the left\n      Click  Sequence Rule  to add a new rule; configure the rule to match on site list  All-Remotes , Actions TLOC list  RH-Tlocs  and TLOC Action  Backup .\n      After  Save Match and And Actions , drag and drop the newly created rule to seq # 1.\n    Follow the same steps to modify topology policy  LAB_Topo_RS2 .",
            "title": "Step3.1: Modify central control policy"
        },
        {
            "location": "/lab3/#step32-configure-on-demand-tunnel",
            "text": "Enable Traffic Engineering service on RH to allow RH becomes backup path.\n- Access template configuration from  Configuration - Templates \n- Under  Feature  template tab, locate template  Lab_RH_VPN0_v01  and select  Edit \n- In  SERVICE  section, add  TE  from service type drop down, and add it to this feature template.\n   \n- Update and push configure change.  On remote sites, R1-WE1 and R2-WE2, enable on-demand on system template.\n-  Under  Feature  template tab, locate template  Lab_System_V01  and select  Copy \n- Name new system template  Lab_Remote_System_V01 \n- Edit  Lab_Remote_System_V01  to enable  On-demand Tunnel \n   \n- locate device template  Lab_R1_V01  and change system template to  Lab_Remote_System_V01 \n     \n    update and push configuration change.\n- locate device template  Lab_R2_V01  and change system template to  Lab_Remote_System_V01 . update and push configuration change.",
            "title": "Step3.2: Configure On-demand Tunnel"
        },
        {
            "location": "/lab3/#step33-verify-on-demand-tunnel-between-remotes",
            "text": "You can verify the dynamic tunnel between remotes from vManage.\n- login vManage  198.18.133.200  and access  Monitor - Network \n- select WAN-Edge  R1-WE1 \n     \n- Click  Real Time  and type in  on demand local  in  Device Options  filed\n     \n- The output shows local on demand tunnel is enabled and status is active.\n     \n- type in  on demand remote  in  Device Options  filed   \n- the output shows remote on demand tunnel to remote2  1.1.102.1  is enabled and tunnel status is  inactive \n     \n- Dynamic on demand tunnel is triggered by traffic between the local and remote sites. That's why you see status of on demand remote is inactive. Let's generate bi-directional traffic between remote1 and remote2 to trigger on demand tunnel.\n- ssh into  R1-VM1 , and type  ssh 10.10.102.10  to login  R2-VM2  with credential  viptela/viptela  Welcome to Ubuntu 16.04.2 LTS (GNU/Linux 4.8.0-36-generic x86_64)\n\n * Documentation:  https://help.ubuntu.com\n * Management:     https://landscape.canonical.com\n * Support:        https://ubuntu.com/advantage\n689 packages can be updated.\n475 updates are security updates.\nLast login: Mon Feb  8 09:22:21 2021 from 10.16.22.163\nviptela@remote1_ubuntu:~$ ssh 10.10.102.10\nviptela@10.10.102.10's password:\nWelcome to Ubuntu 16.04.2 LTS (GNU/Linux 4.8.0-36-generic x86_64)\n\n * Documentation:  https://help.ubuntu.com\n * Management:     https://landscape.canonical.com\n * Support:        https://ubuntu.com/advantage\n711 packages can be updated.\n521 updates are security updates.\nLast login: Mon Feb  8 09:25:00 2021 from 10.10.101.10\nviptela@remote2_ubuntu:~$   Go back to  vManage - Monitor - Network - R1-WE1 - Real time  and type in  on demand remote  in  Device Options  filed.  verify the tunnel status for on demand tunnel to remote2  1.1.102.1  changes  active",
            "title": "Step3.3: Verify On-demand Tunnel between remotes"
        },
        {
            "location": "/lab3/#task-4-ipsec-tunnel-to-sig",
            "text": "Inspection service is required for traffic to cloud application with IP  16.16.16.16 . Configure remote1 and remote2 to build an IPSec tunnel to SIG provider. Route all traffic to  16.16.16.16  for inspection.",
            "title": "Task 4: IPsec tunnel to SIG"
        },
        {
            "location": "/lab3/#step41-manual-ipsec-tunnel-to-sig",
            "text": "Before configuring the IPSec tunnel, verify the connectivity to Cloud application at  16.16.16.16  from remote ubuntu hosts. It is expected to see the application is not reachable.  \nviptela@remote1_ubuntu:~$ ping 16.16.16.16\nPING 16.16.16.16 (16.16.16.16) 56(84) bytes of data.  Configure IPSec tunnel on remote1 and remote2 to match the pre-configured tunnel at SIG provider.     site  tunnel IP  tunnel source  tunnel destination  IKE version  pre-share key      Remote1  172.4.101.1/24  GigabitEthernet2  172.3.2.2  IKE v1  cisco123    Remote2  172.4.102.1/24  GigabitEthernet2  172.3.2.2  IKE v1  cisco123     Isakmp policy  encryption algorithm:   AES - Advanced Encryption Standard (256 bit keys).\nhash algorithm:         Secure Hash Standard\nauthentication method:  Pre-Shared Key\nDiffie-Hellman group:   #16 (4096 bit)\nlifetime:               14400 seconds, no volume limit  IPSec policy  Security association lifetime:3600 seconds\nPFS (Y/N): Y\nDH group:  group16\nMixed-mode : Disabled\nTransform sets=esp-aes esp-sha-hmac\nAntireplay window size = 512   login vManage  198.18.133.200  and access template configuration from  Configuration - Templates - Feature  Add new IPsec interface feature template as show below\n   Configure the template with following fields and leave other fields as default value\n|filed name|value|\n|---|---|\n|Template Name|Lab_IPsec_Int_V01|\n|Description|Lab_IPsec_Int_V01|\n|Shutdown|No|\n|Interface Name|ipsec1|\n|IPv4 address|ipsec_tun_ip|\n|source|Interface|\n|IPsec Source Interface|GigabitEthernet2|\n|IPsec Destination IP Address|172.3.2.2|\n|Preshared Key|cisco123|     Add tunnel feature template  Lab_IPsec_Int_V01  to device template  Lab_R1_V01  and  Lab_R2_V01  Locate device template  Lab_R1_V01  click Edit  Add  Lab_IPsec_Int_V01  under VPN0\n   click save to update and filed in  172.4.101.1/24  for tunnel IP Address\n   Locate device template  Lab_R2_V01  click Edit  Add  Lab_IPsec_Int_V01  under VPN0  click save to update and filed in  172.4.102.1/24  for tunnel IP Address\n   The ipsec tunnel will be  UP  on both remote sites. You can verify the tunnel status from  show ip interface brief   R2-WE1#sh ip int b\nInterface              IP-Address      OK? Method Status                Protocol\nGigabitEthernet1       172.2.7.2       YES other  up                    up\nGigabitEthernet2       172.3.9.7       YES DHCP   up                    up\nGigabitEthernet3       unassigned      YES other  down                  down\nGigabitEthernet4       10.10.102.1     YES other  up                    up\nGigabitEthernet5       unassigned      YES other  down                  down\nGigabitEthernet6       unassigned      YES other  down                  down\nGigabitEthernet7       unassigned      YES other  down                  down\nGigabitEthernet8       192.168.150.19  YES other  up                    up\nSdwan-system-intf      1.1.102.1       YES unset  up                    up\nLoopback65528          192.168.1.1     YES other  up                    up\nNVI0                   unassigned      YES unset  up                    up\nTunnel1                172.2.7.2       YES TFTP   up                    up\nTunnel2                172.3.9.7       YES TFTP   up                    up\nTunnel100001           172.4.102.1     YES other  up                    up\nR2-WE1#  R1-WE1#sh ip int b\nInterface              IP-Address      OK? Method Status                Protocol\nGigabitEthernet1       172.1.8.2       YES other  up                    up\nGigabitEthernet2       172.3.8.7       YES DHCP   up                    up\nGigabitEthernet3       10.10.101.1     YES other  up                    up\nGigabitEthernet4       unassigned      YES other  down                  down\nGigabitEthernet5       unassigned      YES other  down                  down\nGigabitEthernet6       unassigned      YES other  down                  down\nGigabitEthernet7       unassigned      YES other  down                  down\nGigabitEthernet8       192.168.150.16  YES other  up                    up\nSdwan-system-intf      1.1.100.1       YES unset  up                    up\nLoopback65528          192.168.1.1     YES other  up                    up\nNVI0                   unassigned      YES unset  up                    up\nTunnel1                172.1.8.2       YES TFTP   up                    up\nTunnel2                172.3.8.7       YES TFTP   up                    up\nTunnel100001           172.4.101.1     YES other  up                    up\nR1-WE1#   Next you need to route all traffic to cloud application  16.16.16.16  to the tunnel.  locate feature template  Lab_Remote_VPN1_V01  and edit  In  IPSEC ROUTE  section, add  New IPSEC Route  with prefix  16.16.16.16/32  interface  ipsec1     click update to push configure change to both remote sites.",
            "title": "Step4.1 : Manual IPSec tunnel to SIG"
        },
        {
            "location": "/lab3/#step42-verify-sig-tunnel",
            "text": "VNC login  R1-VM1  and  R2-VM1  with credential  viptela    verify that you can ping  16.16.16.16  from the VM\n     now try access  16.16.16.16  from browser. You should see this login page",
            "title": "Step4.2 : verify SIG tunnel"
        },
        {
            "location": "/lab3/#task-5-dia",
            "text": "There are two options to enable DIA.\n- option 1: NAT DIA Route  In this option, a NAT route is configured under service VPN. You can direct local internet traffic from service VPN to transport VPN.\n- option 2: Centralized data policy\n    In this option, a centralized policy is applied to service side traffic based on ip prefixes, a match will redirect to transport VPN. Traffic that doesnt match the policy will stay in service VPN and route over IPSec tunnel.  In this task, you are going to configure DIA on remote sites using option 2.",
            "title": "Task 5: DIA"
        },
        {
            "location": "/lab3/#task-6-cor-for-saas",
            "text": "Instead of using the DIA exit point as configured in previous task, for SaaS application box and salesforce, ACME wants to use the most optimal path. Configure the remote sites to dynamically chose local DIA or regional hub as exit point for box and salesforce based on application performance.",
            "title": "Task 6: CoR for SaaS"
        },
        {
            "location": "/lab3/#step61-enable-cloud-onramp-for-saas",
            "text": "login vManage  198.18.133.200  and access  Administration - Settings  Edit  Cloud onRamp for SaaS  and check  Enabled",
            "title": "Step6.1 Enable Cloud OnRamp for SaaS"
        },
        {
            "location": "/lab3/#step62-add-saas-application",
            "text": "Access CoR SaaS configuration via  Configuration - Cloud onRamp for SaaS      From  Manage Cloud OnRamp for SaaS  dropdown, select  Applications and Policy \n      Select  Box  and  Salesforce  from the application list; Select  Enabled  for Monitoring dropdown list; Enter  1  for VPN; Select  Enabled  for Policy/Cloud SLA dropdown list.    \n- Cloud OnRamp for SaaS uses existing AAR policy, we will keep the system created policy for SaaS. Click  Save Policy  to proceed the policy update.",
            "title": "Step6.2 Add SaaS application"
        },
        {
            "location": "/lab3/#step63-add-sites",
            "text": "You are going to configure remote sites as DIA site, and Regional hub as gateway site. Remote sites will monitor the QoE score for local DIA via LTE transport, and also the QoE score for gateway site.\n- Access CoR SaaS configuration via  Configuration - Cloud onRamp for SaaS \n- Click  Manage Cloud OnRamp for SaaS  dropdown list on the upper left, and select  Gateway \n   \n- Click  Attach Gateways ,  select  RH-WE1  and move it to  selected Sites . Click  Add interfaces to selected sites .\n   \n- In the pop up window, under  Interface  field select interface  GigabitEthernet4  from the list. This will allow gateway site sends  \n- Click  Manage Cloud OnRamp for SaaS  dropdown list on the upper left, and select  DIA Sites \n    \n- select  Attach DIA Sites , select  R1-WE1  and  R2-WE1  and move it to  selected Sites .",
            "title": "Step6.3 Add sites"
        },
        {
            "location": "/lab3/#step64-verify-cor-saas",
            "text": "Click  Manage Cloud OnRamp for SaaS  to verify QoE status, DIA status, exit interface on each WAN Edge for SaaS application.     Note: Your output may not match the screenshot on the vQoE score and DIA Status. This is expected. \n- screenshot above shows both remote sites are using local DIA as exit point for box and Salesfoce SaaS application.\n- This lab doesn't have traffic impairment tool, we can't increase remote transport's latency or drop to trigger SaaS changes exit point. But if you keep checking the SaaS status, you will notice the vQoE score changes and exit interface changes.",
            "title": "Step6.4 Verify CoR SaaS"
        },
        {
            "location": "/lab3/#congratulation-you-have-completed-the-whole-lab",
            "text": "",
            "title": "Congratulation! You have completed the whole lab."
        },
        {
            "location": "/survey/",
            "text": "",
            "title": "Survey"
        }
    ]
}